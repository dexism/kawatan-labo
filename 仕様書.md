## **『永い後日談のネクロニカ』 NC用バトルパート支援ツール 仕様書**

### 1. 概要

本ツールは、テーブルトークRPG『永い後日談のネкроニカ』の戦闘パートを、NC（ネクロマンサー、ゲームマスターの意）が円滑に進行するためのウェブアプリケーションである。
キャラクターのステータス、行動順、戦場の状況を視覚的に管理し、複雑なルール処理を自動化・半自動化することで、NCの負担を軽減し、より物語に集中できる環境を提供することを目的とする。

### 2. 主要機能一覧

*   **戦闘準備機能**
    *   JSONデータに基づいたPC（姉妹ドール）および手駒（敵キャラクター）の戦場への追加。
    *   キャラクターの初期配置エリア設定。
*   **戦闘進行管理機能**
    *   ターンおよびカウントの自動進行管理。
    *   行動値に基づいたキャラクターの行動順の視覚的表示（バトルグリッド）。
    *   ターン終了時の自動処理（全PCへの狂気点追加）。
*   **キャラクター管理機能**
    *   キャラクターごとのステータスをカード形式で表示。
    *   行動値、パーツの損傷状態（箇所別、全体）、狂気点、各種ステータス異常の管理と表示。
    *   レギオンカテゴリのスタック数管理と表示。
*   **マニューバ（行動）処理機能**
    *   ルールに基づいた使用可能マニューバのメニュー表示。
    *   「アクション」「ラピッド」「ジャッジ」「ダメージ」の各タイミングに基づいた宣言と解決のフロー管理。
    *   クリック操作による直感的な移動先選択メニュー。
    *   ターゲット選択支援。
    *   攻撃判定およびダメージ処理のモーダルによる対話的実行。
*   **補助機能**
    *   汎用ダイスローラー。
    *   戦闘経過を記録・表示するログ機能。
    *   マニューバの詳細情報を表示するカードUI。
*   **開発・保守機能**
    *   各モジュールのバージョン管理とフッターへの表示。
    *   ルール定義（ポジション名など）を外部JSONファイル (`core-data.json`) で管理。

### 3. 画面構成

画面は大きく分けて、左側の「メインコンテンツエリア」と右側の「ステータスパネルエリア」で構成される。両エリアの高さは常に同期する。

*   **メインコンテンツエリア (左側)**
    *   **ネクロマンサーの手駒エリア (上部):** 敵キャラクターのカードが配置される。
    *   **バトルグリッドエリア (中央):** 戦場の5つのエリア（奈落〜楽園）と、キャラクターの現在行動値（20〜-5）をマトリクスで表示。各キャラクターはアイコン（マーカー）で示される。
    *   **姉妹ドールエリア (下部):** PCのキャラクターカードが配置される。
*   **ステータスパネルエリア (右側)**
    *   **バトルステータス:** 現在の勝利条件、ターン、カウントを表示。また、現在の処理フェーズ（アクション、ラピッド、ジャッジ、ダメージ）を示すインジケーターと、カウント進行・ターン終了ボタンが配置される。
    *   **ラピッド宣言:** ラピッドタイミングで宣言されたマニューバがキューとして一覧表示される。
    *   **アクション宣言:** アクションタイミングで宣言されたマニューバがキューとして一覧表示される。
    *   **ログ:** ダイスロールの結果や行動宣言、処理結果などが時系列で表示される。

### 4. 機能詳細

#### 4.1. 戦闘準備フェーズ

1.  **キャラクターの追加:**
    *   PCエリアおよび手駒エリアの「アンデッドを追加」カードをクリックすると、キャラクター選択モーダルが表示される。
    *   モーダルには `undead.json` に定義されたテンプレートがカテゴリ別にフィルタリング可能で一覧表示される。
    *   テンプレートを選択すると、キャラクターインスタンスが生成され、戦場に追加される (`character-manager.js`)。
2.  **初期配置:**
    *   追加されたキャラクターカードの「移動」ボタンから、初期配置エリア（奈落、地獄、煉獄、花園、楽園）を選択・設定できる。
3.  **戦闘開始:**
    *   PCと手駒がそれぞれ1体以上配置されると、バトルグリッド中央の「戦闘開始」バナーが有効化される。
    *   バナーをクリックすると、戦闘が開始され、UIが戦闘モードに移行する (`battle-logic.js`)。

#### 4.2. 戦闘の進行

1.  **カウントの決定と進行:**
    *   戦闘開始時および各ターン開始時、全キャラクターの最大行動値から最初のカウントが決定される。
    *   「カウントダウン」ボタンを押すと、次に行動可能なキャラクターが存在する行動値までカウントがジャンプする (`battle-logic.js` の `advanceCount`)。行動可能なキャラクターがいない場合は、ターン終了処理に移行する。
2.  **ターン終了処理:**
    *   「ターン終了」ボタンを押すと、狂気点追加フェーズに移行する (`battle-logic.js` の `startMadnessPhase`)。
    *   モーダルが表示され、NCは各PCが狂気点を追加する未練を選択する。
    *   確定後、各キャラクターの行動値が最大行動値分回復し、次のターンが開始される (`character-manager.js` の `startNewTurn` / `battle-logic.js` の `proceedToNextTurn`)。

#### 4.3. アクションの処理フロー

フローチャート画像 (`戦闘進行図.png`) およびルール (`戦闘.md`) に基づく、カウント内の詳細な処理フローは以下の通りである。

1.  **アクション宣言 (Action Declaration):**
    *   現在のカウントで行動可能なキャラクターがマニューバを宣言する。
    *   宣言されたアクションは「アクション宣言」キューに追加される。
    *   この宣言に対し、他のキャラクターは「ラピッド」タイミングのマニューバを宣言して割り込むことができる。ラピッド宣言は「ラピッド宣言」キューに追加される。

2.  **解決フェーズ (Resolution Phase):**
    *   そのカウントで行動可能なキャラクター全員がアクション宣言を終えるか、待機を選択すると、解決フェーズに移行する。
    *   **ステップ1: ラピッド処理 (Rapid Processing):**
        *   「ラピッド宣言」キューに項目がある場合、他のタイミングはすべて非活性化され、ラピッドの解決が最優先される。
        *   NCがラピッド宣言のチェックボックスをすべてチェックすると、キュー内の「ラピッド」マニューバが「後から宣言されたもの」から順に解決される。
    *   **ステップ2: アクション・ジャッジ処理 (Action/Judge Processing):**
        *   ラピッド処理完了後、「ジャッジ」タイミングが活性化される。NCがアクション宣言のチェックボックスをすべてチェックすると、キュー内の「アクション」マニューバの効果が**すべて同時に**適用される。
        *   この際、**移動マニューバの効果が他の効果（攻撃など）よりも先に解決される。**
    *   **ステップ3: ダメージ処理 (Damage Processing):**
        *   アクション処理の結果としてダメージが発生した場合、「ダメージ」タイミングが活性化する。
        *   攻撃が命中した場合、「ダメージ処理モーダル」が表示され、NCが対象の損傷パーツを決定する。

#### 4.4. UI/UX詳細

*   **キャラクターカード:**
    *   戦闘準備中は、キャラクターの配置変更、編集、削除、表示順変更のボタンが表示される。
    *   戦闘中は、現在のカウントで行動可能なキャラクターのカードがハイライトされる。
    *   **パーツ状態表示:** カード画像上に、各キャラクターカテゴリの特性に応じた形式でパーツの損傷状態がマーカーで表示される（ドール/サヴァント: 箇所別、ホラー: 全体数、レギオン: スタック数）。
    *   精神崩壊、戦闘離脱などの状態異常は、カード上に視覚的なオーバーレイ（テープなど）で表示される。
*   **マニューバメニュー:**
    *   移動マニューバをクリックすると、独立した「移動先選択メニュー」がクリック位置にポップアップ表示される。移動範囲外はマスクされ、現在位置は強調表示される。
    *   マニューバにマウスカーソルを合わせると、効果、条件、説明文などを記載した詳細カードがフローティング表示される。
*   **パーツ損傷モーダル:**
    *   ダメージ処理時に表示される。対象キャラクターの全部位・全パーツが一覧表示される。NCは発生したダメージ点数と同じ数の未損傷パーツを選択し、処理を完了する。
*   **狂気点追加モーダル:**
    *   ターン終了時に表示され、PCごとに狂気点を追加する未練を選択する。

#### 4.5. データ構造

本ツールは、複数のJSONファイルによってゲームデータを管理する。

*   `maneuvers.json`: 全てのスキル、パーツのマニューバデータを格納。
*   `undead.json`: PCおよび手駒のキャラクターテンプレートを格納。
*   `regret.json`, `takaramono.json`, `memory_fragments.json`: それぞれ未練、たからもの、記憶のカケラのマスターデータを格納。
*   `effects.json`: マニューバの効果に関する詳細な説明テキストを格納。
*   `core-data.json`: ポジション名、クラス名、カテゴリ定義など、アプリケーションの動作の基本となる「骨格データ」を格納。プログラム内のハードコーディングを排除し、メンテナンス性を向上させる。

#### 4.6. モジュール構成と責務

本ツールは、責務ごとに分割されたJavaScriptモジュールで構成されている。

*   `script.js`: アプリケーション全体のエントリーポイント。各モジュールの初期化とバージョン情報の集約を行う。
*   `data-handler.js`: 全てのJSONデータの読み込みと提供を担当する、データアクセスの窓口。
*   `character-manager.js`: 戦場にいるキャラクターインスタンスの生成、状態変更（パーツ損傷、狂気点追加など）、ライフサイクル全般を管理する。
*   `battle-logic.js`: **戦闘の中核ロジック**。戦闘の進行（ターン、カウント）、状態管理、アクションの宣言受付と解決フロー（ラピッド、ジャッジ、ダメージ）、ルール判定をすべて担当する。
*   `ui-manager.js`: **DOM操作全般**を担当。キャラクターカード、バトルグリッド、各種ステータス表示の描画・更新を行う。
*   `interaction-manager.js`: **ユーザー操作の受付**と、それに伴う**UI表示の指示**を担当。クリックやドラッグ等のイベントリスナーを設定し、`battle-logic.js`の関数を呼び出したり、メニューやモーダルを表示したりする。
*   `dice-roller.js`: ダイスロール機能の実装。コマンド解釈と結果の計算、ログ出力を担当する。