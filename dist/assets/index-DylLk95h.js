import*as k from"https://unpkg.com/three@0.160.0/build/three.module.js";import*as S from"https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js";import{FBXLoader as At}from"https://unpkg.com/three@0.160.0/examples/jsm/loaders/FBXLoader.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Tt="1.4.7";let X={},ne={},Qe={},Fe={},ze={},Ge={},Je={},Ke={},Ye={};async function Bt(){try{const t=["positions.json","classes.json","basic_parts.json","armed_parts.json","mutant_parts.json","custom_parts.json","tegoma_skills.json","tegoma_parts.json","tegoma_parts0.json"].map(u=>fetch(`data/maneuvers/${u}`).then(r=>r.json())),[n,a,s,o,i,c,l,...p]=await Promise.all([fetch("data/hint.json"),fetch("data/regret.json"),fetch("data/takaramono.json"),fetch("data/memory_fragments.json"),fetch("data/undead.json"),fetch("data/core-data.json"),fetch("data/effects_db.json"),...t]);X=p.reduce((u,r)=>({...u,...r}),{}),[Ye,Qe,Fe,ze,Je,Ke,Ge]=await Promise.all([n.json(),a.json(),s.json(),o.json(),i.json(),c.json(),l.json()]),ne={};for(const u in X){const r=X[u];r&&r.name&&(ne[r.name]={id:u,...r})}console.log("Data handler initialized successfully!")}catch(e){throw console.error("Error in data handler initialization:",e),e}}function xt(){return X}function _(e){return ne[e]}function xe(){return Qe}function _t(){return Fe}function Nt(){return ze}function _e(){return Je}function pe(){return Ke}function Pt(e){return Ge[e]}function Dt(){return Ye}function Rt(){const e=_e(),t=new Set;for(const n in e)e[n]&&e[n].img&&t.add(e[n].img);return[...t]}function Ot(e){if(!e||!e.name){console.warn("追加しようとしたマニューバデータが無効です:",e);return}if(ne[e.name])return;const t=`CSTM_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;e.id=t,X[t]=e,ne[e.name]=e,console.log(`カスタムマニューバ「${e.name}」を動的に追加しました。`)}const Xe="1.5.17";let Ze={},I=[],et=1;function se(e){let t=0;[...e.skills||[],...Object.values(e.partsStatus||{}).flat().map(a=>a.name)].forEach(a=>{const s=_(a);if(!s||!s.effects||s.effects.length===0)return;let o=!1;if(e.partsStatus){const i=Object.values(e.partsStatus).flat().find(c=>c.name===a);i&&(o=i.damaged)}for(const i of s.effects)i.ref==="APPLY_BUFF"&&i.params.stat==="maxActionValue"?(isNaN(o)||!o)&&(t+=i.params.value||0):i.ref==="MODIFY_MAX_ACTION_VALUE_ON_DAMAGE"&&o&&(t+=i.params.value||0)}),e.maxActionValue=(e.baseActionValue||6)+t}function Ht(e,t,n){const a=Ze[e];if(!a)return console.error(`テンプレートIDが見つかりません: ${e}`),null;const s=JSON.parse(JSON.stringify(a));s.id=`char_${et++}`,s.type=t,s.area=n||a.initialArea||(t==="pc"?"煉獄":"奈落"),s.partsStatus={};let o=0;if(a.parts&&typeof a.parts=="object"&&Object.keys(a.parts).forEach(i=>{Array.isArray(a.parts[i])&&(s.partsStatus[i]=a.parts[i].map(c=>({id:`${s.id}_part_${o++}`,name:c,damaged:!1})))}),t==="pc"&&a.treasure){let i=!1;for(const c in s.partsStatus){const l=s.partsStatus[c].find(p=>p.name===a.treasure);if(l){l.id=`${s.id}_part_treasure`,i=!0;break}}i||(s.partsStatus.body||(s.partsStatus.body=[]),s.partsStatus.body.push({id:`${s.id}_part_treasure`,name:a.treasure,damaged:!1}))}return s.madnessPoints={},s.statusEffects=[],s.activeBuffs=[],s.isMentallyBroken=!1,s.isDestroyed=!1,s.hasWithdrawn=!1,s.regrets=[],se(s),s.actionValue=s.maxActionValue,s.skills=a.skills||[],s.stackCount=1,s.hasActedThisCount=!1,tt(s),s}function ge(){const e=I.filter(a=>a.skills&&a.skills.includes("合流"));if(e.length<2)return;const t=new Map;e.forEach(a=>{const s=`${a.position}-${a.area}`;t.has(s)||t.set(s,[]),t.get(s).push(a)});let n=!1;t.forEach(a=>{if(a.length<2)return;const s=a[0];for(let o=1;o<a.length;o++){const i=a[o];s.stackCount+=i.stackCount;const c=I.findIndex(l=>l.id===i.id);c!==-1&&I.splice(c,1)}n=!0}),n&&console.log("キャラクターが合流しました。")}function tt(e){e.usedManeuvers=new Set,e.turnLimitedManeuvers=new Set,[...e.skills||[],...Object.values(e.partsStatus||{}).flat().map(n=>n.name)].forEach(n=>{const a=_(n);if(!a)return;let s=!1;a.hasOwnProperty("usageLimit")?s=a.usageLimit:["ジャッジ","ダメージ","ラピッド"].includes(a.timing)&&(s=!0),s&&e.turnLimitedManeuvers.add(n)})}function nt(e){e.regrets=[];const t=I.filter(o=>o.type==="pc"&&o.id!==e.id),n=e.treasure||"たからもの";e.regrets.push({id:`treasure_${e.id}`,name:`${n}への依存`,points:3,category:"たからもの"});const a=xe(),s=Object.keys(a).filter(o=>o.startsWith("SI-"));t.forEach(o=>{if(s.length>0){const i=s[Math.floor(Math.random()*s.length)];e.regrets.push({id:`regret_${e.id}_to_${o.id}`,name:`${o.name}への${a[i].name}`,points:3,categoryKey:"SI"});const c=s[Math.floor(Math.random()*s.length)];o.regrets.push({id:`regret_${o.id}_to_${e.id}`,name:`${e.name}への${a[c].name}`,points:3,categoryKey:"SI"})}})}function at(e){Ze=e,console.log("Character Manager initialized.")}function B(e=!1){return I}function P(e){return I.find(t=>t.id===e)}function st(e,t,n){const a=Ht(e,t,n);return a?(t==="pc"&&nt(a),I.push(a),console.log(`${a.name} (${t}) を戦場に追加しました。`),ge(),a):null}function ot(e){const t=P(e);if(t&&t.stackCount>1)return t.stackCount--,console.log(`${t.name}のスタックが1減少しました。`),!0;const n=I.findIndex(a=>a.id===e);if(n!==-1){const a=I[n].name;return I.splice(n,1),console.log(`${a} を戦場から削除しました。`),!0}return!1}function Se(e,t){const n=I.findIndex(p=>p.id===e);if(n===-1)return;const a=I[n],s=I.filter(p=>p.type===a.type),o=s.findIndex(p=>p.id===e);let i;if(t==="left"){if(o===0)return;i=o-1}else{if(o===s.length-1)return;i=o+1}I.splice(n,1);const c=s[i].id,l=I.findIndex(p=>p.id===c);t==="left"?I.splice(l,0,a):I.splice(l+1,0,a)}function j(e,t){const n=P(e);n?(Object.assign(n,t),(n.isDestroyed||n.hasWithdrawn)&&(n.actionValue=0,n.isDestroyed&&n.partsStatus&&Object.values(n.partsStatus).flat().forEach(a=>a.damaged=!0)),se(n),ge()):console.warn(`更新対象のキャラクターが見つかりません: ${e}`)}function Ne(e,t,n=1){const a=P(e);if(!a){console.error("損傷対象のキャラクターが見つかりません。",{characterId:e});return}if(a.category==="レギオン"){a.stackCount-=n,console.log(`${a.name}のスタックが${n}減少しました。残り: ${a.stackCount}`),a.stackCount<=0&&(a.isDestroyed=!0,a.actionValue=0,console.log(`${a.name}は完全に破壊されました。`));return}for(const s in a.partsStatus){const o=a.partsStatus[s].find(i=>i.id===t);if(o){if(o.damaged)return;o.damaged=!0,console.log(`${a.name}の[${s}]にある「${o.name}」が損傷しました。`),se(a);return}}console.error("損傷対象のパーツIDが見つかりません。",{characterId:e,partId:t})}function it(e,t){const n=P(e);if(!n)return;const a=n.regrets.find(i=>i.id===t);a&&a.points<4&&(a.points++,console.log(`${n.name}の未練「${a.name}」に狂気点が1追加されました。(現在: ${a.points})`)),n.regrets&&n.regrets.length>0&&n.regrets.every(i=>i.points>=4)&&(n.isMentallyBroken=!0,console.log(`★★★ ${n.name} は精神崩壊しました。 ★★★`))}function rt(){I.forEach(e=>{if(e.isDestroyed||e.hasWithdrawn){e.actionValue=0;return}e.actionValue+=e.maxActionValue,e.hasActedThisCount=!1,e.usedManeuvers.clear()}),ge(),console.log("新しいターンが開始され、全キャラクターの行動値が更新されました。")}function ct(e){e.forEach(t=>{const n=P(t.characterId);n&&(n.area=t.targetArea)}),console.log("予約された移動を一括で適用しました。")}function jt(e,t){const n=JSON.parse(JSON.stringify(e));n.id=`char_${et++}`,n.type=t,n.area=n.initialArea||(t==="pc"?"煉獄":"奈落"),n.partsStatus={};let a=0;if(n.parts&&typeof n.parts=="object"&&Object.keys(n.parts).forEach(s=>{Array.isArray(n.parts[s])&&(n.partsStatus[s]=n.parts[s].map(o=>({id:`${n.id}_part_${a++}`,name:o,damaged:!1})))}),t==="pc"&&n.treasure)for(const s in n.partsStatus){const o=n.partsStatus[s].find(i=>i.name===n.treasure);if(o){o.id=`${n.id}_part_treasure`;break}}return n.isMentallyBroken=!1,n.isDestroyed=!1,n.activeBuffs=[],n.hasWithdrawn=!1,n.stackCount=1,n.hasActedThisCount=!1,t==="pc"?nt(n):n.regrets=[],se(n),n.actionValue=n.maxActionValue,tt(n),I.push(n),console.log(`${n.name} (imported ${t}) を戦場に追加しました。`),ge(),n}const qt=Object.freeze(Object.defineProperty({__proto__:null,addCharacterFromObject:jt,addCharacterFromTemplate:st,addMadnessPoint:it,applyQueuedMoves:ct,damagePart:Ne,getCharacterById:P,getCharacters:B,initialize:at,moveCharacter:Se,recalculateMaxActionValue:se,removeCharacter:ot,startNewTurn:rt,updateCharacter:j,version:Xe},Symbol.toStringTag,{value:"Module"})),Vt="1.0.1";function lt(e){const n=pe().maneuverCategories.find(a=>a.name===e);return n?n.slug:"other"}const Ut="1.0.10",Wt=.01,Qt=-9.82,Ft=.2,zt=.3,Gt=.3,Jt=.9;let V,U,q,H,Z,D,re,ye,z,we=null,ee=!1,Ie,de,J,ce;const Kt=[{normal:new k.Vector3(0,1,0),value:1},{normal:new k.Vector3(0,-1,0),value:9},{normal:new k.Vector3(.951,0,.309),value:10},{normal:new k.Vector3(.588,0,-.809),value:2},{normal:new k.Vector3(-.588,0,-.809),value:7},{normal:new k.Vector3(-.951,0,.309),value:4},{normal:new k.Vector3(0,.851,.526),value:8},{normal:new k.Vector3(0,.851,-.526),value:6},{normal:new k.Vector3(0,-.851,.526),value:3},{normal:new k.Vector3(0,-.851,-.526),value:5}];function Yt(e){J=e;const t=e.clientWidth,n=e.clientHeight;V=new k.Scene,U=new k.PerspectiveCamera(30,t/n||1,.1,10),U.position.set(0,.5,0),U.lookAt(0,0,0),q=new k.WebGLRenderer({antialias:!0,alpha:!0}),q.setSize(t,n),q.setPixelRatio(window.devicePixelRatio),q.setClearColor(0,0),e.appendChild(q.domElement),V.add(new k.AmbientLight(16777215,.7));const a=new k.DirectionalLight(16777215,.9);a.position.set(1,2,1),V.add(a),H=new S.World,H.gravity.set(0,Qt,0),re=new S.Material("dice"),ye=new S.Material("ground"),z=new S.Material("wall"),H.addContactMaterial(new S.ContactMaterial(re,ye,{restitution:Gt,friction:Ft})),H.addContactMaterial(new S.ContactMaterial(re,z,{restitution:Jt,friction:zt}));const s=new S.Body({mass:0,material:ye});s.addShape(new S.Plane),s.quaternion.setFromEuler(-Math.PI/2,0,0),H.addBody(s),mt(),Zt(),ft(),window.addEventListener("resize",Le),setTimeout(Le,0)}function Xt(e){!D||ee||(we=e,ee=!0,clearTimeout(de),J.classList.add("is-visible"),Le(),D.position.set(0,.1,0),D.velocity.set(0,2.4,0),D.angularVelocity.set(Math.random()*20+10,Math.random()*20+10,Math.random()*20+10),D.wakeUp(),dt(),de=setTimeout(()=>{ee&&(console.warn("Dice roll timed out. Forcing result."),ut())},2e3))}function Zt(){const e=new At,t=new k.TextureLoader,n="models/",a="Dice_10.fbx",s={map:"Dice_10_Albedo.png",normalMap:"Dice_10_Normal.png",metalnessMap:"Dice_10_Metallic.png",roughnessMap:"Dice_10_Roughness.png",aoMap:"Dice_10_AO.png"},o={};let i=0;const c=Object.keys(s).length;Object.entries(s).forEach(([p,u])=>{t.load(n+u,r=>{r.colorSpace=k.SRGBColorSpace,o[p]=r,i++,i===c&&l()})});function l(){e.load(n+a,p=>{p.traverse(g=>{g.isMesh&&(g.material=new k.MeshStandardMaterial({map:o.map,normalMap:o.normalMap,metalnessMap:o.metalnessMap,roughnessMap:o.roughnessMap,aoMap:o.aoMap,metalness:1,roughness:1,aoMapIntensity:1}))}),an(p);const u=tn(p),r=Wt/u;sn(p,r),V.add(p),Z=p;const{vertices:m,indices:d}=nn(p),h=new S.Trimesh(m,d);D=new S.Body({mass:.005,material:re,shape:h,angularDamping:0,allowSleep:!0}),H.addBody(D)})}}function dt(){clearTimeout(Ie),D.sleepState===S.Body.SLEEPING?(clearTimeout(de),setTimeout(ut,200)):Ie=setTimeout(dt,100)}function ut(){if(!ee)return;ee=!1,clearTimeout(de),clearTimeout(Ie);const e=en();we&&we(e),setTimeout(()=>{J.classList.remove("is-visible")},1500)}function en(){let e=-2,t=-1;const n=new k.Vector3(0,1,0);return Kt.forEach(a=>{const o=a.normal.clone().applyQuaternion(Z.quaternion).dot(n);o>e&&(e=o,t=a.value)}),t}const be=[],$e=[];function mt(){if(be.forEach(r=>H.removeBody(r)),be.length=0,$e.forEach(r=>V.remove(r)),$e.length=0,!ce)return;const e=ce.width*.9,t=ce.height*.9,n=new k.PlaneGeometry(e,t),a=new k.MeshStandardMaterial({color:3355443,transparent:!0,opacity:.3}),s=new k.Mesh(n,a);s.rotation.x=-Math.PI/2,s.position.y=.001,V.add(s),$e.push(s);const o=.5,i=.1,c=new S.Box(new S.Vec3(e/2,o/2,i/2)),l=new S.Box(new S.Vec3(i/2,o/2,t/2)),p=[new S.Vec3(0,o/2,t/2),new S.Vec3(0,o/2,-t/2),new S.Vec3(e/2,o/2,0),new S.Vec3(-e/2,o/2,0)];[new S.Body({mass:0,shape:c,position:p[0],material:z}),new S.Body({mass:0,shape:c,position:p[1],material:z}),new S.Body({mass:0,shape:l,position:p[2],material:z}),new S.Body({mass:0,shape:l,position:p[3],material:z})].forEach(r=>{H.addBody(r),be.push(r)})}function Le(){if(!J)return;const e=J.clientWidth,t=J.clientHeight;if(e===0||t===0)return;const n=k.MathUtils.degToRad(U.fov),a=2*Math.tan(n/2)*.5;ce={width:a*(e/t),height:a},mt(),U.aspect=e/t,U.updateProjectionMatrix(),q.setSize(e,t)}let He=performance.now();function ft(){requestAnimationFrame(ft);const e=performance.now(),t=(e-He)/1e3;H&&H.step(1/60,t,3),He=e,Z&&D&&(Z.position.copy(D.position),Z.quaternion.copy(D.quaternion)),q&&V&&U&&q.render(V,U)}function tn(e){const t=new k.Vector3;let n=0;return e.traverse(a=>{if(a.isMesh&&a.geometry?.attributes?.position){const s=a.geometry.attributes.position;for(let o=0;o<s.count;o++){t.fromBufferAttribute(s,o);const i=t.length();i>n&&(n=i)}}}),n}function nn(e){const t=[],n=[];let a=0;return e.traverse(s=>{if(s.isMesh&&s.geometry?.attributes?.position){const o=s.geometry,i=o.attributes.position;for(let c=0;c<i.count;c++)t.push(i.getX(c),i.getY(c),i.getZ(c));if(o.index){const c=o.index.array;for(let l=0;l<c.length;l++)n.push(a+c[l])}else for(let c=0;c<i.count;c++)n.push(a+c);a+=i.count}}),{vertices:t,indices:n}}function an(e){const t=new k.Box3().setFromObject(e),n=new k.Vector3;t.getCenter(n),e.traverse(a=>{a.isMesh&&a.geometry&&a.geometry.translate(-n.x,-n.y,-n.z)}),e.position.set(0,0,0)}function sn(e,t){const n=new k.Matrix4().makeScale(t,t,t);e.traverse(a=>{a.isMesh&&a.geometry&&a.geometry.applyMatrix4(n)}),e.scale.set(1,1,1)}const on="1.2.13";let pt={},gt={},ht={},vt={},Ae=()=>{},je=!1;function rn(e){if(pt=e.hintMasterData,gt=e.regretMasterData,ht=e.takaramonoMasterData,vt=e.memoryFragmentsData,Ae=e.addLog,!je){const t=document.getElementById("dice3d-container");t&&(Yt(t),je=!0)}}function cn(){R({title:"ダイスロール",items:[{label:"ダイスロール",isTitle:!0},{label:"NA  攻撃判定",onClick:()=>x({command:"NA",showToast:!0})},{label:"NC  判定",onClick:()=>x({command:"NC",showToast:!0})},{label:"NM  姉妹への未練",onClick:()=>x({command:"NM",showToast:!0})},{label:"NME 敵への未練",onClick:()=>x({command:"NME",showToast:!0})},{label:"NMN 中立者への未練",onClick:()=>x({command:"NMN",showToast:!0})},{label:"NT  たからもの表",onClick:()=>x({command:"NT",showToast:!0})},{label:"NK  記憶のカケラ",onClick:()=>x({command:"NK",showToast:!0})},{label:"NH  暗示表",onClick:()=>x({command:"NH",showToast:!0})},{label:"1D10",onClick:()=>x({command:"1d10",showToast:!0})},{label:"1D100",onClick:()=>x({command:"1d100",showToast:!0})},{label:"直接入力",onClick:()=>{R({title:"🎲 ダイスロール",bodyHtml:`
                    <p style="text-align: center; margin-bottom: 15px;">ダイスコマンドを入力してください。</p>
                    <input type="text" id="diceCommandInput" value="3d6" 
                           class="modal-input-text" autofocus
                           inputmode="latin" style="ime-mode: disabled;">
                `,footerHtml:'<button id="executeDiceRollBtn" class="welcome-modal-close-btn">ダイスロール</button>',onRender:(a,s)=>{const o=a.querySelector("#diceCommandInput"),i=a.querySelector("#executeDiceRollBtn"),c=()=>{o.value&&x({command:o.value,showToast:!0}),s()};i.onclick=c,o.onkeydown=l=>{l.key==="Enter"&&c()},o.select()}})}}]})}function x(e){const t=typeof e=="string"?e:e.command,n=typeof e=="object"&&e.callback?e.callback:null;if(!t)return;const a=t.toLowerCase().replace(/\s/g,"");let s=`「${t}」は無効な入力です。`,o=null,i=null;if(a==="nm")s=Ce("SI-","姉妹への未練表");else if(a==="nme")s=Ce("EN-","敵への未練表");else if(a==="nmn")s=Ce("NP-","中立者への未練表");else if(a==="nt"){const c=Math.floor(Math.random()*10)+1,l=ht[c];s=l?`🎲 たからもの表(${c}) ＞ 【${l.name}】 ${l.description}`:`たからものデータ[${c}]が見つかりませんでした。`}else if(a==="nk"){const c=Math.floor(Math.random()*100)+1,l=vt[c];s=l?`🎲 記憶のカケラ表(${c}) ＞ 【${l.name}】 ${l.description}`:`記憶のカケラデータ[${c}]が見つかりませんでした。`}else if(a==="nh"){const c=Math.floor(Math.random()*10)+1,l=pt[c];s=l?`🎲 暗示表(${c}) ＞ 【${l.name}】 ${l.description}`:`暗示データ[${c}]が見つかりませんでした。`}else{const c=/^(\d*)?(nc|na)([+-]\d+)?$/,l=a.match(c);if(l){const[,p,u,r]=l,m=p?parseInt(p,10):1,d=r?parseInt(r,10):0,h=Array.from({length:m},()=>Math.floor(Math.random()*10)+1),g=Math.max(...h),f=Math.min(...h),v=g+d;let C=d>0?`+${d}`:d<0?`${d}`:"",b="",y="",M="#dc3545";u==="nc"?(v>=11?(b="大成功",M="#007bff"):f+d<=1?(b="大失敗",y="＞ 使用パーツ全損"):v>=6?(b="成功",M="#007bff"):b="失敗",o=b):u==="na"&&(v>=11?(b="大成功",y=`＞ 攻撃側任意（追加ダメージ${v-10}）`,M="#007bff",i="任意"):v>=10?(b="成功",y="＞ 頭（なければ攻撃側任意）",M="#007bff",i="頭"):v>=9?(b="成功",y="＞ 腕（なければ攻撃側任意）",M="#007bff",i="腕"):v>=8?(b="成功",y="＞ 胴（なければ攻撃側任意）",M="#007bff",i="胴"):v>=7?(b="成功",y="＞ 脚（なければ攻撃側任意）",M="#007bff",i="脚"):v>=6?(b="成功",y="＞ 防御側任意",M="#007bff",i="任意"):v>=2?b="失敗":(b="大失敗",y="＞ 味方か自身に命中"),o=b);const w=`[${h.join(",")}]`;s=`<span style="color: ${M};">🎲 ${t.toUpperCase()} ＞ ${g}${w}${C} ＞ ${v} ＞ ${b} ${y}</span>`,Ae(s),Xt(L=>{const F=`🎲 1D10 ＞ ${L}`;ae(F,4e3),n&&n(o,i,s)});return}else{const p=/^(\d*)d(\d+)([+-]\d+)?$/,u=a.match(p);if(u){const r=u[1]?parseInt(u[1],10):1,m=parseInt(u[2],10),d=u[3]?parseInt(u[3],10):0;if(r>0&&m>0&&r<=100){const h=Array.from({length:r},()=>Math.floor(Math.random()*m)+1),g=h.reduce((C,b)=>C+b,0),f=g+d;let v=d>0?`+${d}`:d<0?`${d}`:"";s=`🎲 ${t.toUpperCase()} ＞ ${g}[${h.join(",")}]${v} ＞ ${f}`}else s=`「${t}」のダイスの数や種類が正しくありません。`}}}Ae(s),(typeof e=="object"&&e.showToast||typeof e=="string")&&ae(s,4e3),n&&n(o,i,s)}function Ce(e,t){const n=gt;if(!n||Object.keys(n).length===0)return"未練データが見つかりませんでした。";const a=Object.keys(n).filter(i=>i.startsWith(e));if(a.length===0)return`${t} に該当する未練データが見つかりませんでした。`;const s=a[Math.floor(Math.random()*a.length)],o=n[s];return o?`🎲 ${t}(${s}) ＞ 【${o.name}】[発狂:${o.madnessName}] ${o.madnessEffect}`:`未練データ[${s}]が見つかりませんでした。`}const ln="1.1.17";function dn(e){if(!e)return console.error("[Converter] 変換対象のデータ(sourceData)が存在しません。"),null;try{const t={};t.name=e.Name||e.pc_name||e.data_title||"名称未設定",t.description=`${e.data_title||""} | ${e.Position_Name||""}（${e.MCLS_Name||""}・${e.SCLS_Name||""}）`,t.img="images/noimage.png",t.category="ドール",t.initialArea="煉獄",t.baseActionValue=6,t.position=e.Position_Name||"",t.mainClass=e.MCLS_Name||"",t.subClass=e.SCLS_Name||"";const n={1:"武装",2:"変異",3:"改造"};t.enhancementValue={bonus:n[e.ST_Bonus]||"武装"},t.skills=[],t.parts={head:[],arms:[],torso:[],legs:[],body:[]};const a={4:"head",5:"arms",6:"torso",7:"legs"},s={1:"オート",2:"アクション",3:"ジャッジ",4:"ダメージ",5:"ラピッド"},o={1:"攻撃",2:"攻撃",3:"行動値",4:"補助",5:"妨害",6:"防御",7:"移動"},i=e.Power_name?.length||0;let c=null,l=-1;l=e.Power_shozoku?.findIndex(r=>r&&r.includes("たから")),l>-1?c=e.Power_name[l]:(l=e.Power_memo?.findIndex((r,m)=>{const d=e.Power_hantei[m];return!["1","2","3"].includes(d)&&r&&r.includes("たからもの")}),l>-1&&(c=e.Power_name[l])),t.treasure=c;for(let r=0;r<i;r++){const m=e.Power_name[r];if(!m||m===c)continue;const d=e.Power_hantei[r],h=a[d];if(!_(m)){const g=e.Power_Type[r],f={name:m,timing:s[e.Power_timing[r]]||"オート",cost:e.Power_cost[r]||"なし",range:e.Power_range[r]||"自身",effect:e.Power_memo[r]||"効果不明",description:e.Power_memo[r]||"効果不明",category:["1","2","3"].includes(d)?"スキル":o[g]||"強化パーツ"};Ot(f)}["1","2","3"].includes(d)?t.skills.push(m):h?t.parts[h].push(m):t.skills.push(m)}if(c){const r=e.Power_hantei[l],m=a[r];m?t.parts[m].push(c):t.parts.body.push(c)}t.regrets=[];const p=e.roice_name?.length||0;for(let r=0;r<p;r++){const m=e.roice_name[r],d=e.roice_pos[r];if(m&&d){const h={name:`${m}への${d}`,points:parseInt(e.roice_damage[r],10)||3};m==="たからもの"&&t.treasure?(h.name=`${t.treasure}への${d}`,h.category="たからもの"):h.categoryKey="SI",t.regrets.push(h)}}t.memories=[];const u=e.kakera_name?.length||0;for(let r=0;r<u;r++){const m=e.kakera_name[r],d=e.kakera_memo[r];m&&t.memories.push({name:m,memo:d})}return t.personalData={title:e.data_title||"",tags:e.pc_tags||"",race:e.shuzoku||"ドール",age:e.age||"",sex:e.sex||"",height:e.pc_height||"",weight:e.pc_weight||"",karma:e.pc_carma||"",hairColor:e.color_hair||"",eyeColor:e.color_eye||"",skinColor:e.color_skin||"",memo:e.pc_making_memo||""},t}catch(t){return console.error("キャラクターシートの変換中にエラーが発生しました:",t),null}}const un="1.1.3";function mn(){const e=document.querySelectorAll('input[name="theme-switcher"]'),t=localStorage.getItem("theme")||"system";Ee(t),document.querySelector(`input[name="theme-switcher"][value="${t}"]`).checked=!0,e.forEach(a=>{a.addEventListener("change",s=>{const o=s.target.value;Ee(o),localStorage.setItem("theme",o),console.log(`Theme changed to: ${o}`)})}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&Ee("system")}),console.log("Settings Manager initialized.")}function Ee(e){e==="system"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e)}function fn(){let e=0;for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),a=localStorage.getItem(n);if(n&&a){const s=(n.length+a.length)*2;e+=s}}return e}function pn(){localStorage.removeItem("userLocalImages"),console.log("Local image cache cleared.")}const gn="1.10.36";let ue=null;const K=["奈落","地獄","煉獄","花園","楽園"];let oe=null,Y="宣言";const yt=e=>{const t=document.getElementById("maneuverMenu");t&&!t.contains(e.target)&&ue&&!ue.contains(e.target)&&me()};function qe(e,t){me(),ue=t;const n=document.getElementById("maneuverMenu");n.innerHTML="";const a=[{id:"宣言",label:"宣言"},{id:"スキル",label:"スキル"},{id:"パーツ",label:"パーツ"},{id:"バフ",label:"バフ"},{id:"移動",label:"移動"},{id:"攻撃",label:"攻撃"},{id:"支援",label:"支援"},{id:"妨害",label:"妨害"},{id:"すべて",label:"すべて"}],s=document.createElement("div");s.className="maneuver-menu-header",s.innerHTML=`
        <span class="header-icon" id="menuHeaderIcon">🪪</span>
        <span class="header-title">${e.name}</span>
        <button class="header-close-btn">&times;</button>
    `,n.appendChild(s),s.querySelector("#menuHeaderIcon").onclick=()=>Pe(e),s.querySelector(".header-close-btn").onclick=me;const o=document.createElement("div");o.className="maneuver-menu-filter-bar",a.forEach(u=>{const r=document.createElement("button");r.className="filter-btn",r.dataset.filterId=u.id,r.textContent=u.label,u.id===Y&&r.classList.add("is-active"),r.onclick=()=>{Y=u.id,o.querySelectorAll(".filter-btn").forEach(m=>m.classList.remove("is-active")),r.classList.add("is-active"),c()},o.appendChild(r)}),n.appendChild(o);const i=document.createElement("div");i.className="maneuver-menu-list-container",n.appendChild(i);const c=()=>{i.innerHTML="";const u=bt(e),r=hn(u,Y,e);if(Y!=="パーツ"){const m=pe().maneuverCategories.map(d=>d.name);r.sort((d,h)=>{const g=d.data.category==="行動値増加"?"行動値":d.data.category,f=h.data.category==="行動値増加"?"行動値":h.data.category;let v=m.indexOf(g);v===-1&&(v=m.length);let C=m.indexOf(f);return C===-1&&(C=m.length),v!==C?v-C:d.data.name.localeCompare(h.data.name)})}Y==="パーツ"?l(r,e):p(r,e)},l=(u,r)=>{["頭","腕","胴","脚","他"].forEach(d=>{const h=u.filter(g=>bn(g.data,r).includes(d));if(h.length>0){const g=document.createElement("div");g.className="maneuver-group",g.innerHTML=`<div class="group-header">${d}</div>`,h.forEach(f=>g.appendChild(Ve(f,r))),i.appendChild(g)}})},p=(u,r)=>{if(u.length===0){i.innerHTML='<div class="maneuver-item is-empty">対象のマニューバはありません</div>';return}u.forEach(m=>i.appendChild(Ve(m,r)))};c(),n.classList.add("is-visible"),setTimeout(()=>{document.addEventListener("click",yt)},0)}function Ve(e,t){const n=e.data,a=document.createElement("div");a.className="maneuver-item-new";const s=document.createElement("div");s.className="item-category-col";const o=n.category||"その他",i=`category-color-${lt(o)}`;a.classList.add(i.replace("bg-","")),s.classList.add(i),s.innerHTML=`<span>${o}</span>`;const c=document.createElement("div");if(c.className="item-icon-col item-passive-icon-col",e.isActiveBuff||n.timing==="オート"){let u=!1;if(e.isActiveBuff)u=!0;else{const r=e.isDamaged;["レギオン","ホラー","合流"].includes(n.name)?u=!0:n.effects&&n.effects.length>0&&(n.effects.some(h=>h.ref==="MODIFY_MAX_ACTION_VALUE_ON_DAMAGE")?r&&(u=!0):n.effects.some(g=>g.ref==="APPLY_BUFF"||g.ref==="REDUCE_MOVE_COST")&&!r&&(u=!0))}u&&(c.innerHTML='<span class="maneuver-icon">💡</span>')}const l=document.createElement("div");if(l.className="item-icon-col item-status-icon-col",e.isActiveBuff)l.innerHTML='<input type="checkbox" class="maneuver-checkbox" checked disabled>';else if(t.turnLimitedManeuvers.has(n.name)){const u=t.usedManeuvers.has(n.name);l.innerHTML=`<input type="checkbox" class="maneuver-checkbox" ${u?"checked":""} disabled>`}const p=document.createElement("div");return p.className="item-right-col",p.innerHTML=`
        <div class="item-row-1">
            <span class="item-name">【${n.name}】</span>
            <span class="item-stats">《${n.timing}/${n.cost}/${n.range}》</span>
        </div>
        <div class="item-row-2">${n.description||""}</div>
    `,a.appendChild(s),a.appendChild(c),a.appendChild(l),a.appendChild(p),a.addEventListener("mouseenter",()=>Et(document.getElementById("maneuverMenu").getBoundingClientRect(),a.getBoundingClientRect(),t,e)),a.addEventListener("mouseleave",()=>te()),e.isUsable?a.onclick=async u=>{if(u.stopPropagation(),me(),n.name==="任意"){const m=`<div class="action-cost-form"><div class="action-cost-selector">${[1,2,3,4,5].map(h=>`<label><input type="radio" name="action-cost" value="${h}" ${h===1?"checked":""}> <span>${h}</span></label>`).join("")}</div></div>`;R({title:"消費する行動値を選択",bodyHtml:m,footerHtml:'<button id="applyActionCostBtn" class="welcome-modal-close-btn">適用</button>',onRender:(h,g)=>{h.querySelector("#applyActionCostBtn").onclick=()=>{const f=h.querySelector('input[name="action-cost"]:checked').value,v={...n,cost:String(parseInt(f,10))};W(t,v),g()}}});return}if(n.timing==="ジャッジ"&&n.range!=="自身"){const m=Mn(t,n);if(m.length===0){E("支援/妨害の対象となるアクションがありません。");return}const d=m.map(h=>({label:`${h.performer.name}: 【${h.sourceManeuver.name}】${h.target?` → ${h.target.name}`:""}`,onClick:()=>W(t,n,null,h)}));R({title:`【${n.name}】の対象を選択`,items:d});return}if(n.tags.includes("移動")){yn(t,n);return}if(n.tags.includes("攻撃")){const m=await kn(t,n,yt);m&&W(t,n,m);return}W(t,n)}:(a.classList.add("is-masked"),e.isDamaged&&a.classList.add("is-damaged")),a}function hn(e,t,n){let a=[];const s=["待機","任意"];switch(t){case"宣言":a=e.filter(o=>o.isUsable&&o.data.timing!=="オート");break;case"スキル":a=e.filter(o=>o.sourceType==="skill"&&!s.includes(o.data.name));break;case"パーツ":a=e.filter(o=>o.sourceType==="part"&&!s.includes(o.data.name));break;case"移動":a=e.filter(o=>o.data.tags.includes("移動")&&!s.includes(o.data.name));break;case"攻撃":a=e.filter(o=>o.data.tags.includes("攻撃")&&!s.includes(o.data.name));break;case"支援":a=e.filter(o=>(o.data.tags.includes("支援")||o.data.tags.includes("強化"))&&!s.includes(o.data.name));break;case"妨害":a=e.filter(o=>(o.data.tags.includes("妨害")||o.data.tags.includes("脆弱"))&&!s.includes(o.data.name));break;case"バフ":case"すべて":default:a=[...e];break}return(t==="バフ"||t==="すべて")&&n.activeBuffs&&n.activeBuffs.length>0&&n.activeBuffs.forEach(o=>{const i=_(o.source);if(i){const c=a.findIndex(l=>l.data.name===o.source&&!l.isActiveBuff);c>-1&&a.splice(c,1),a.some(l=>l.isActiveBuff&&l.sourceName===o.source)||a.push({data:i,sourceType:"active_buff",sourceName:o.source,isActiveBuff:!0,isUsable:!1})}}),t==="バフ"?a.filter(o=>o.isActiveBuff||o.data.timing==="オート"&&o.data.effects&&o.data.effects.some(i=>i.ref==="APPLY_BUFF"||i.ref==="REDUCE_MOVE_COST")):a}function Pe(e){const t=e.category==="ドール",n=pe(),a=n.classes;let s={A:0,M:0,R:0};if(t){const u=Object.keys(a).find(g=>a[g].name===e.mainClass),r=Object.keys(a).find(g=>a[g].name===e.subClass),m=u?a[u]:null,d=r?a[r]:null;m&&(s.A+=m.A||0,s.M+=m.M||0,s.R+=m.R||0),d&&(s.A+=d.A||0,s.M+=d.M||0,s.R+=d.R||0);const h=e.enhancementValue.bonus;h==="武装"&&(s.A+=1),h==="変異"&&(s.M+=1),h==="改造"&&(s.R+=1)}const l=(t?["煉獄","花園","楽園"]:["奈落","地獄","煉獄","花園","楽園"]).map(u=>`<option value="${u}" ${e.area===u?"selected":""}>${u}</option>`).join(""),p=`
    <div class="sheet-grid-container">
        <div class="sheet-img">
            <button class="sheet-edit-image-btn">✏️ 画像の変更</button>
            <img src="${e.img}" alt="${e.name}">
        </div>
        <div class="sheet-header">
            ${e.sheetId?`
            <div class="sheet-charasheet-link">
                <button class="sheet-link-btn" data-sheet-id="${e.sheetId}">保管所で見る ID: ${e.sheetId}</button> 
            </div>
            `:""}
            ${e.personalData&&e.personalData.title?`
                <div class="sheet-char-title">${e.personalData.title}</div>
            `:""}
        </div>
        <div class="sheet-basic-info">
            <div class="sheet-input-group">
                <label>名前</label>
                <input type="text" value="${e.name}" disabled>
            </div>
            ${t?`
            <div class="sheet-input-group">
                <label>享年</label>
                <input type="text" value="${e.personalData?.age||"未設定"}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>暗示</label>
                <input type="text" value="${e.personalData?.karma||"未設定"}" disabled>
            </div>`:""}
             <div class="sheet-input-group">
                <label>最大行動値</label>
                <input type="text" value="${e.maxActionValue}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>初期配置</label>
                <select id="areaSelector" class="sheet-select">${l}</select>
            </div>
        </div>
        <div class="sheet-section sheet-enhancement">
            <h4>基本情報</h4>
            <div class="sheet-input-group">
                <label>カテゴリ</label> <input type="text" value="${e.category}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>ポジション</label> <input type="text" value="${e.position}" disabled>
            </div>
            ${t?`
            <div class="sheet-input-group">
                <label>メインクラス</label> <input type="text" value="${e.mainClass}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>サブクラス</label> <input type="text" value="${e.subClass}" disabled>
            </div>
            <h4>強化点</h4>
             <div class="sheet-input-group">
                <label>ボーナス</label> <input type="text" value="${e.enhancementValue.bonus}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>武装</label> <input type="text" value="${s.A}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>変異</label> <input type="text" value="${s.M}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>改造</label> <input type="text" value="${s.R}" disabled>
            </div>`:""}
        </div>
        ${e.personalData?`
        <div class="sheet-section sheet-personal-data">
            <h4>パーソナルデータ</h4>
            <div class="sheet-input-group"><label>タグ</label><input type="text" value="${e.personalData.tags}" disabled></div>
            <div class="sheet-input-group"><label>種族</label><input type="text" value="${e.personalData.race}" disabled></div>
            <div class="sheet-input-group"><label>身長</label><input type="text" value="${e.personalData.height}" disabled></div>
            <div class="sheet-input-group"><label>髪の色</label><input type="text" value="${e.personalData.hairColor}" disabled></div>
            <div class="sheet-input-group"><label>瞳の色</label><input type="text" value="${e.personalData.eyeColor}" disabled></div>
            <div class="sheet-input-group"><label>肌の色</label><input type="text" value="${e.personalData.skinColor}" disabled></div>
            <h4>その他メモ</h4>
            <textarea class="sheet-textarea" rows="8" disabled>${e.personalData.memo}</textarea>
        </div>
        `:""}
        ${t?`
        <div class="sheet-section sheet-hint">
            <h4>暗示</h4>
            ${e.hint?`<p><b>【${e.hint.name}】</b><br>${e.hint.description}</p>`:"<p>（暗示は設定されていません）</p>"}
        </div>
        <div class="sheet-section sheet-memory">
            <h4>記憶のカケラ</h4>
            ${e.memories&&e.memories.length>0?e.memories.map(u=>`<p><b>【${u.name}】</b><br>${u.memo}</p>`).join(""):"<p>（記憶のカケラはありません）</p>"}
        </div>
        <div class="sheet-section sheet-regrets">
            <h4>未練</h4>
            ${e.regrets&&e.regrets.length>0?e.regrets.map(u=>{const r=u.points||0,m="●".repeat(r)+"○".repeat(4-r),d=xe(),h=Object.values(d).find(f=>u.name.includes(f.name)),g=h?`：${h.madnessName}：${h.madnessEffect}`:"";return`<p>${u.name}：${r}点 ${m}${g}</p>`}).join(""):"<p>（未練はありません）</p>"}
        </div>`:""}
        <div class="sheet-section sheet-skills">
            <h4>スキル</h4>
            ${e.skills.map(u=>{const r=_(u);if(!r)return`<div class="part-list-item">${u}</div>`;let m="スキル";if(r.id&&t){const d=r.id,h=d.substring(0,2),g=d.endsWith("-SP"),f=e.mainClass===e.subClass,v=Object.keys(n.positions).find(y=>n.positions[y].name===e.position),C=Object.keys(a).find(y=>a[y].name===e.mainClass),b=Object.keys(a).find(y=>a[y].name===e.subClass);g&&h===C?m="特化スキル":h===v?m="ポジション":h===C?m=f?"クラス":"メインクラス":h===b&&(m=f?"クラス":"サブクラス")}return`<div class="part-list-item"><span class="type">[${m}]</span> <b>【${u}】</b>《${r.timing}/${r.cost}/${r.range}》：${r.description||r.effect}</div>`}).join("")}
        </div>
        <div class="sheet-section sheet-parts">
            <h4>パーツ</h4>
            <div class="sheet-parts-grid">
                ${["head","arms","torso","legs","body"].map(u=>{if(!e.partsStatus[u]||e.partsStatus[u].length===0)return"";const r={head:"頭",arms:"腕",torso:"胴",legs:"脚",body:"体"}[u],m=e.partsStatus[u].map(d=>{const h=d.id.includes("_treasure"),g=h?xt()["TR-00"]:_(d.name),f=g?.id?.startsWith("BP-"),v=h?"たからもの":f?"基本":"強化";if(!g)return`<div class="part-list-item"><span class="type">[${v}]</span> <b>${d.name}</b></div>`;const C=h?g.effect:g.description||g.effect;return`<div class="part-list-item"><span class="type">[${v}]</span> <b>【${d.name}】</b>《${g.timing}／${g.cost}／${g.range}》：${C}</div>`}).join("");return`<div><h4>〈${r}〉</h4>${m}</div>`}).join("")}
            </div>
        </div>
    </div>
    `;R({title:"ネクロニカ 人形設計図",bodyHtml:p,onRender:(u,r)=>{u.querySelector(".modal-content").classList.add("sheet-modal-content"),u.querySelector(".modal-body").classList.add("sheet-modal-body");const m=u.querySelector(".sheet-edit-image-btn");m&&(m.onclick=()=>{Te(e,r)});const d=u.querySelector("#areaSelector");d&&(d.onchange=g=>{const f=g.target.value;j(e.id,{area:f}),T(),Q()});const h=u.querySelector(".sheet-link-btn");h&&(h.onclick=()=>{const g=h.dataset.sheetId;g&&window.open(`https://charasheet.vampire-blood.net/${g}`,"_blank")})}})}function vn(e){const t=document.getElementById("undeadListModal"),n=t.querySelector(".modal-body");n.innerHTML="";const a=document.createElement("div");a.className="import-container";const s=document.createElement("button");s.className="import-btn",s.textContent="保管所から読込み",s.onclick=()=>{t.classList.remove("is-visible"),$n(e,qt)},a.appendChild(s),n.appendChild(a);const o=document.createElement("div");o.className="undead-filter-container",["すべて",...["ドール","レギオン","ホラー","サヴァント"]].forEach(r=>{const m=document.createElement("button");m.className="filter-btn",m.textContent=r,m.dataset.category=r,r==="すべて"&&m.classList.add("active"),o.appendChild(m)}),n.appendChild(o);const l=document.createElement("div");l.className="undead-list-container",n.appendChild(l);const p=_e(),u=r=>{l.innerHTML="";for(const m in p){if(m.startsWith("//"))continue;const d=p[m];if(r==="すべて"||d.category===r){const h=document.createElement("div");h.className="undead-list-item",h.innerHTML=`<img src="${d.img}" alt="${d.name}"><div class="undead-list-item-name">${d.name}</div>`,h.onclick=()=>{const g=d.category==="レギオン"?5:1;for(let f=0;f<g;f++)st(m,e);T(),t.classList.remove("is-visible"),ve()},l.appendChild(h)}}};o.querySelectorAll(".filter-btn").forEach(r=>{r.onclick=()=>{o.querySelectorAll(".filter-btn").forEach(m=>m.classList.remove("active")),r.classList.add("active"),u(r.dataset.category)}}),u("すべて"),t.querySelector("#closeModalBtn").onclick=()=>t.classList.remove("is-visible"),t.onclick=r=>{r.target===t&&t.classList.remove("is-visible")},t.classList.add("is-visible")}function yn(e,t,n){const a=K.indexOf(e.area);let s=1;if(t&&t.effects){const r=t.effects.find(m=>m.ref==="MOVE_CHARACTER");if(r&&r.params&&r.params.distance){const d=String(r.params.distance).split("-");s=parseInt(d[1]||d[0],10)}}const o={奈落:"naraku",地獄:"jigoku",煉獄:"rengoku",花園:"hanazono",楽園:"rakuen"},i=[],c=e.type==="enemy"&&e.area==="奈落"&&e.category!=="レギオン"&&e.category!=="ホラー",l={label:">>> 逃走 >>>",isDisabled:!c,onClick:()=>{c&&W(e,{...t,name:"逃走",isEscapeAttempt:!0})}},p=e.type==="pc"&&e.area==="楽園"&&e.category!=="レギオン"&&e.category!=="ホラー",u={label:"<<< 逃走 <<<",isDisabled:!p,onClick:()=>{p&&W(e,{...t,name:"逃走",isEscapeAttempt:!0})}};t.effects.some(r=>r.ref==="MOVE_CHARACTER")&&i.push(l),K.forEach((r,m)=>{const h=Math.abs(a-m)>s||m===a,f={label:m===a?`${r} (現在地)`:r,isDisabled:h,onClick:()=>{h||W(e,{...t,targetArea:r})}},v=o[r];v&&(f.class=`area-color-${v}`),i.push(f)}),t.effects.some(r=>r.ref==="MOVE_CHARACTER")&&i.push(u),R({title:`【${t.name}】移動先を選択`,items:i})}function me(){const e=document.getElementById("maneuverMenu");e&&e.classList.remove("is-visible"),te(),ue=null}function bt(e){const t=A(),n=[];(e.skills||[]).forEach(i=>{const c=_(i);c&&n.push({data:c,sourceType:"skill",sourceName:i})}),Object.values(e.partsStatus||{}).flat().forEach(i=>{const c=_(i.name);c&&n.push({data:c,sourceType:"part",sourceName:i.name,isDamaged:i.damaged})});const a=_("待機");a&&n.push({data:a,sourceType:"common"});const s=_("任意");s&&n.push({data:s,sourceType:"common"});const o=new Set;return document.getElementById("actionPhaseIndicator")?.classList.contains("active")&&o.add("アクション"),document.getElementById("rapidPhaseIndicator")?.classList.contains("active")&&o.add("ラピッド"),document.getElementById("judgePhaseIndicator")?.classList.contains("active")&&o.add("ジャッジ"),document.getElementById("damagePhaseIndicator")?.classList.contains("active")&&o.add("ダメージ"),n.map(i=>{const c=i.data;let l=!0;if(i.isDamaged&&(l=!1),e.usedManeuvers.has(c.name)&&(l=!1),(isNaN(Number(c.cost))?0:Number(c.cost))>e.actionValue&&(l=!1),c.timing!=="オート"&&o.has(c.timing)||(l=!1),c.timing==="アクション"&&l&&(t.activeActors.some(r=>r.id===e.id)||(l=!1)),l&&c.timing!=="オート"){const{hasTarget:u}=De(e,c);u||(l=!1)}return{...i,isUsable:l}})}function bn(e,t){if(!t||!t.partsStatus)return"";for(const n in t.partsStatus)if(t.partsStatus[n].some(a=>a.name===e.name))return{head:"頭",arms:"腕",torso:"胴",legs:"脚",body:"他"}[n]||"";return""}function $n(e,t){R({title:"保管所からキャラクターを読込み",bodyHtml:`
        <div class="import-method-selector">
            <input type="radio" name="import-method" id="import-by-new" value="new" checked>
            <label for="import-by-new">新着リスト</label>
            <input type="radio" name="import-method" id="import-by-idlist" value="idlist">
            <label for="import-by-idlist">IDリスト</label>
            <input type="radio" name="import-method" id="import-by-id" value="id">
            <label for="import-by-id">ID入力</label>
        </div>
        
        <div id="import-by-list-content">
            <div class="loader">リストを読み込んでいます...</div>
            <div class="sheet-list-container"></div>
        </div>

        <div id="import-by-id-content" style="display: none;">
            <p style="text-align: center; margin: 10px 0;">キャラクターシート保管所のURLまたはIDを入力してください。</p>
            <input type="text" id="sheetIdInput" class="modal-input-text" placeholder="例: 4634334">
            <p class="modal-note">※ https://charasheet.vampire-blood.net/xxxx の形式に対応しています。</p>
            <button id="importSheetBtn" class="import-btn">読込み</button>
        </div>
    `,onRender:(a,s)=>{const o=a.querySelector("#import-by-list-content"),i=a.querySelector("#import-by-id-content"),c=a.querySelector(".sheet-list-container"),l=a.querySelector(".loader"),p=a.querySelector("#sheetIdInput"),u=a.querySelector("#importSheetBtn"),r=async d=>{try{s(),ae(`ID: ${d} を読込み中...`,3e3);const h=await En(d),g=dn(h);if(g)g.sheetId=d,t.addCharacterFromObject(g,e),T(),ve(),ae(`「${g.name}」を読み込みました。`,3e3);else throw new Error("データの変換に失敗しました。")}catch(h){alert(`エラー: ${h.message}`)}},m=d=>{l.style.display="block",c.innerHTML="",l.textContent=`${d==="id"?"ID":"新着"}リストを読み込み中...`,Cn(d).then(h=>{l.style.display="none";const g=`
                        <table class="sheet-list-table">
                            <thead>
                                <tr><th>ID</th><th>タイトル / PC名</th><th>ポジション</th><th>クラス</th></tr>
                            </thead>
                            <tbody>
                                ${h.map(f=>{const v=f.title||"(タイトルなし)",C=f.Name?`<br><span class="pc-name-in-list">${f.Name}</span>`:"";return`
                                        <tr data-id="${f.id}">
                                            <td>${f.id}</td>
                                            <td>${v}${C}</td>
                                            <td>${f.Race}</td>
                                            <td>${f.Class}</td>
                                        </tr>
                                    `}).join("")}
                            </tbody>
                        </table>`;c.innerHTML=g,a.querySelectorAll(".sheet-list-table tbody tr").forEach(f=>{f.onclick=()=>r(f.dataset.id)})}).catch(h=>{l.textContent=`リストの読み込みに失敗しました: ${h.message}`})};a.querySelectorAll('input[name="import-method"]').forEach(d=>{d.onchange=h=>{const g=h.target.value;g==="new"?(o.style.display="block",i.style.display="none",m("%21")):g==="idlist"?(o.style.display="block",i.style.display="none",m("id")):(o.style.display="none",i.style.display="block",p.focus())}}),u.onclick=()=>{const d=p.value.trim().match(/(\d+)/)?.[1];d&&r(d)},p.onkeydown=d=>{if(d.key==="Enter"){const h=p.value.trim().match(/(\d+)/)?.[1];h&&r(h)}},m("%21")}})}async function Cn(e="%21"){const n=[],a=document.querySelector("#import-by-list-content .loader"),s=o=>new Promise((i,c)=>{const l=`jsonpCallback_list_${Date.now()}_${o}`;window[l]=u=>{document.head.removeChild(p),delete window[l],i(u)};const p=document.createElement("script");p.onerror=()=>{delete window[l],document.head.removeChild(p),c(new Error(`Page ${o}の読込みに失敗`))},p.src=`https://charasheet.vampire-blood.net/list_nechro.js?order=${e}&page=${o}&callback=${l}`,p.charset="UTF-8",document.head.appendChild(p)});for(let o=0;o<6;o++)try{a&&(a.textContent=`リストを読み込み中... (${o+1} / 6ページ)`);const i=await s(o);n.push(...i),await new Promise(c=>setTimeout(c,200))}catch(i){throw console.error(`ページ ${o} の取得に失敗しました。処理を中断します。`,i),new Error(`ページ ${o} の取得中にエラーが発生しました。`)}return n}function En(e){return new Promise((t,n)=>{const a=`jsonpCallback_${Date.now()}`;window[a]=o=>{document.head.removeChild(s),delete window[a],t(o)};const s=document.createElement("script");s.onerror=()=>{delete window[a],document.head.removeChild(s),n(new Error("シートの読込みに失敗しました。"))},s.src=`https://charasheet.vampire-blood.net/${e}.js?callback=${a}`,s.charset="UTF-8",document.head.appendChild(s)})}function Te(e,t){const n=()=>{const g=localStorage.getItem("userLocalImages");return g?JSON.parse(g):[]},a=g=>{const f=n();f.includes(g)||(f.push(g),localStorage.setItem("userLocalImages",JSON.stringify(f)))},s=async(g,f,v)=>{const C=g.target.files[0];if(C&&C.type.startsWith("image/"))try{const b=await o(C,300);a(b),v(),Te(e,t)}catch(b){console.error("画像のリサイズに失敗しました:",b),alert("画像の処理に失敗しました。別の画像で試してください。")}g.target.value=""};function o(g,f){return new Promise((v,C)=>{const b=new FileReader;b.readAsDataURL(g),b.onload=y=>{const M=new Image;M.src=y.target.result,M.onload=()=>{let w=M.width,L=M.height;if(w<=f&&L<=f){v(M.src);return}w>L?w>f&&(L*=f/w,w=f):L>f&&(w*=f/L,L=f);const F=document.createElement("canvas");F.width=w,F.height=L,F.getContext("2d").drawImage(M,0,0,w,L);const Lt=F.toDataURL("image/jpeg",.8);v(Lt)},M.onerror=w=>C(w)},b.onerror=y=>C(y)})}const i=["images/doll/doll_01.png","images/doll/doll_02.png","images/doll/doll_03.png","images/doll/doll_04.png","images/doll/doll_05.png","images/doll/doll_06.png","images/doll/doll_12.png","images/doll/doll_13.png","images/doll/doll_14.png","images/doll/doll_15.png","images/doll/doll_16.png","images/doll/doll_17.png"],c=Rt(),l=n(),p=[...new Set([...i,...c])],r=[...l,...p].map(g=>`<div class="image-select-item" data-path="${g}"><img src="${g}" alt="image" loading="lazy"></div>`).join(""),h=`
        <div class="local-image-upload-container">
            <div class="button-group">
                <button id="localImageUploader" class="local-image-upload-btn">ローカルから読込み</button>
                <button id="clearImageCacheBtn" class="local-image-clear-btn">画像キャッシュ消去</button>
            </div>
            <input type="file" id="localImageInput" accept="image/*" style="display: none;">
            <p class="image-upload-note">画像は、300×300px にリサイズされてキャッシュします。</p>
            <p class="image-upload-note">画像キャッシュ使用量: ${(fn()/1024).toFixed(1)} KB / 5.0 MB</p>
        </div>
        <div class="image-select-grid">${r}</div>
    `;R({title:"画像を選択",bodyHtml:h,onRender:(g,f)=>{const v=g.querySelector("#localImageUploader"),C=g.querySelector("#localImageInput");v.onclick=()=>C.click(),C.onchange=y=>s(y,g,f);const b=g.querySelector("#clearImageCacheBtn");b&&(b.onclick=()=>{confirm("ローカルに保存した画像をすべて消去します。よろしいですか？")&&(pn(),ae("画像キャッシュを消去しました。",3e3),f(),Te(e,t))}),g.querySelectorAll(".image-select-item").forEach(y=>{y.onclick=()=>{const M=y.dataset.path;j(e.id,{img:M}),T(),f(),t();const w=P(e.id);w&&Pe(w)}})}})}function Mn(e,t){const n=A(),a=K.indexOf(e.area),s=t.range;if(typeof s!="string"&&typeof s!="number")return[];const o=s.toString().split("～"),i=parseInt(o[0],10),c=parseInt(o[1]||o[0],10);return isNaN(i)?[]:n.actionQueue.filter(l=>{if(l.checked)return!1;const p=l.performer,u=K.indexOf(p.area);if(u===-1)return!1;const r=Math.abs(a-u);return!(r<i||r>c||t.category==="支援"&&e.type!==p.type||t.category==="妨害"&&e.type===p.type)})}function De(e,t){const n=t.range;if(!n||["自身","効果参照","なし","すべて"].includes(n)||t.timing==="オート")return{hasTarget:!0,targets:[]};let a=0;const s=n.toString().split("～"),o=parseInt(s[0],10),i=parseInt(s[1]||s[0],10)+a;if(isNaN(o))return{hasTarget:!0,targets:[]};const c=B(),l=K.indexOf(e.area),p=[],u=c.filter(r=>!r.isDestroyed&&!r.hasWithdrawn);for(const r of u){if(r.id===e.id&&n!=="0"||e.type===r.type&&t.tags.includes("攻撃"))continue;const m=K.indexOf(r.area);if(m===-1)continue;const d=Math.abs(l-m);d>=o&&d<=i&&p.push(r)}return{hasTarget:p.length>0,targets:p}}async function kn(e,t,n){return new Promise(a=>{const s=l=>{if(!oe)return;const p=oe;o(),p(l)},o=()=>{oe=null,document.querySelectorAll(".target-selectable").forEach(l=>l.classList.remove("target-selectable")),document.removeEventListener("click",n)};oe=a,E(`>> ${e.name}のターゲットを選択してください。(対象外クリックでキャンセル)`);const{targets:i}=De(e,t);i.length>0&&Ct(i);const c=new Set(i.map(l=>l.id));document.querySelectorAll(".char, .marker").forEach(l=>{c.has(l.dataset.id)&&(l.classList.add("target-selectable"),l.onclick=p=>{p.stopPropagation(),s(P(l.dataset.id))})}),document.addEventListener("click",n)})}function Sn(e,t,n){const c=(e.type==="pc"?["煉獄","花園","楽園"]:["奈落","地獄","煉獄","花園","楽園"]).map(l=>({label:l+(e.area===l?" (現在地)":""),isDisabled:e.area===l,onClick:()=>{j(e.id,{area:l}),T()}}));R({title:`${e.name} の配置先を選択`,items:c})}function wn(e,t,n,a){const s=A(),o=s.actionQueue[a];if(!o)return;let i=0;const c=[],l=[],p=n.effects.find(f=>f.ref==="GENERIC_ATTACK");if(p&&p.params&&p.params.attack_bonus){const f=parseInt(p.params.attack_bonus,10);isNaN(f)||(i+=f,c.push(`【${n.name}】自体 (${f>0?"+":""}${f})`))}bt(e).filter(f=>f.data.timing==="オート"&&!f.isDamaged).forEach(f=>{f.data.effects&&f.data.effects.forEach(v=>{if(v.ref==="APPLY_BUFF"&&v.params.stat==="attackCheckBonus"){const C=v.params.value||0;i+=C,c.push(`${e.name}の【${f.data.name}】(${C>0?"+":""}${C})`)}})}),e.activeBuffs&&e.activeBuffs.length>0&&e.activeBuffs.forEach(f=>{if(f.stat==="attackCheckBonus"){const v=f.value||0;i+=v,c.push(`${e.name}の【${f.source}】効果 (+${v})`)}}),s.judgeQueue.forEach(f=>{const v=f.sourceManeuver,C=v.effects.find(b=>b.ref==="GENERIC_JUDGE_MOD");if(C){let b=!1;if((f.judgeTarget&&f.judgeTarget.id===o.id||C.params.target==="self_roll"&&f.performer.id===e.id)&&(b=!0),b){const y=C.params.value||0,M=`${f.performer.name}の【${v.name}】`;y>0?(i+=y,c.push(`${M} (+${y})`)):y<0&&(i+=y,l.push(`${M} (${y})`))}}});const r=c.length>0?c.map(f=>`<div class="modifier-item">${f}</div>`).join(""):'<div class="modifier-none">- なし -</div>',m=l.length>0?l.map(f=>`<div class="modifier-item">${f}</div>`).join(""):'<div class="modifier-none">- なし -</div>',d=i>0?`+${i}`:i<0?`${i}`:"",h=`
        <div class="attack-confirm-summary">
            ${e.name}【${n.name}】 → ${t.name}
        </div>
        <div class="attack-confirm-section">
            <div class="section-header">《支援》</div>
            <div class="modifier-list">${r}</div>
        </div>
        <div class="attack-confirm-section">
            <div class="section-header">《妨害》</div>
            <div class="modifier-list">${m}</div>
        </div>
    `,g=`<button id="executeDiceRollBtn" class="welcome-modal-close-btn">🎲 NA${d} 🎲</button>`;R({title:"ジャッジ",bodyHtml:h,footerHtml:g,onRender:(f,v)=>{f.querySelector("#executeDiceRollBtn").onclick=()=>{Mt(a,i),v()}}})}const In="2.1.6";let G=!1,N=null;function Ln(){console.log("Interaction Manager initialized.")}function An(){document.addEventListener("click",t=>{N&&!N.contains(t.target)&&(N.classList.remove("actions-visible"),N=null)}),he(),Tn(),Ue(document.getElementById("pcContainer")),Ue(document.getElementById("enemyContainer")),Bn();const e=document.getElementById("startBattleBtn");e&&(e.onclick=()=>{e.disabled||Xn()}),document.getElementById("countdownBtn").onclick=()=>ea(),document.getElementById("endTurnBtn").onclick=()=>kt()}function he(){document.querySelectorAll(".char").forEach(e=>{const t=e.dataset.id;if(!t)return;const n=P(t);if(n){if(A().isStarted)e.onclick=a=>{if(a.stopPropagation(),G){G=!1;return}qe(n,e)};else{e.onclick=u=>{if(u.stopPropagation(),G){G=!1;return}N===e?(e.classList.remove("actions-visible"),N=null):(N&&N.classList.remove("actions-visible"),e.classList.add("actions-visible"),N=e)};const a=e.querySelector('[data-action="delete"]');a&&(a.onclick=u=>{u.stopPropagation(),ot(t),T(),ve(),N=null});const s=e.querySelector('[data-action="details"]');s&&(s.onclick=u=>{u.stopPropagation(),Pe(n)});const o=e.querySelector('[data-action="place"]');o&&(o.onclick=u=>{u.stopPropagation(),Sn(n)});const i=e.querySelector('[data-action="move-left"]');i&&(i.onclick=u=>{u.stopPropagation(),Se(t,"left"),T(),N=null});const c=e.querySelector('[data-action="move-right"]');c&&(c.onclick=u=>{u.stopPropagation(),Se(t,"right"),T(),N=null});const l=B().filter(u=>u.type===n.type),p=l.findIndex(u=>u.id===t);i&&(i.disabled=p===0),c&&(c.disabled=p===l.length-1)}e.onmouseenter=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.add("hover-highlight"),document.querySelector(`.marker[data-id="${t}"]`)?.classList.add("hover-highlight")},e.onmouseleave=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.remove("hover-highlight"),document.querySelector(`.marker[data-id="${t}"]`)?.classList.remove("hover-highlight")}}}),document.querySelectorAll(".marker").forEach(e=>{const t=e.dataset.id;if(!t)return;const n=P(t);n&&(A().isStarted&&(e.onclick=a=>{a.stopPropagation(),qe(n,e)}),e.onmouseenter=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.add("hover-highlight"),e.classList.add("hover-highlight")},e.onmouseleave=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.remove("hover-highlight"),e.classList.remove("hover-highlight")})}),document.querySelectorAll(".add-char-card").forEach(e=>{const t=e.closest(".char-container");if(t){const n=t.id==="pcContainer"?"pc":"enemy";e.onclick=null,e.onclick=()=>{vn(n)}}})}function Ue(e){let t=!1,n,a,s;e.addEventListener("mousedown",i=>{t=!0,G=!1,n=i.pageX-e.offsetLeft,a=e.scrollLeft,s=0});const o=()=>{t=!1,Math.abs(s)>5&&(G=!0)};e.addEventListener("mouseleave",o),e.addEventListener("mouseup",o),e.addEventListener("mousemove",i=>{if(!t)return;i.preventDefault(),s=i.pageX-e.offsetLeft-n,e.scrollLeft=a-s})}function Tn(){const e=document.getElementById("diceRoller");let t=!1,n,a,s,o;e.addEventListener("mousedown",l=>{s=l.clientX,o=l.clientY,t=!0,n=l.clientX-e.getBoundingClientRect().left,a=l.clientY-e.getBoundingClientRect().top,e.style.cursor="grabbing",document.addEventListener("mousemove",i),document.addEventListener("mouseup",c),l.preventDefault()});function i(l){t&&(e.style.left=`${l.clientX-n}px`,e.style.top=`${l.clientY-a}px`)}function c(){t=!1,e.style.cursor="grab",document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c)}e.addEventListener("click",l=>{Math.abs(l.clientX-s)>3||Math.abs(l.clientY-o)>3||cn()})}function Bn(){document.querySelectorAll(".accordion-header").forEach(e=>{e.closest("#maneuverMenu")||e.addEventListener("click",()=>{const t=e.closest(".accordion-container");t&&t.classList.toggle("is-closed")})})}function xn(e){const t=document.getElementById("madnessModal"),n=document.getElementById("confirmMadnessBtn"),a=new Map;document.querySelectorAll(".pc-regret-group").forEach(s=>{s.querySelectorAll(".regret-item").forEach(o=>{o.onclick=()=>{s.querySelectorAll(".regret-item").forEach(i=>i.classList.remove("is-selected")),o.classList.add("is-selected"),a.set(s.dataset.pcId,o.dataset.regretId),n.disabled=a.size!==e.length}})}),n.disabled=!0,n.onclick=()=>{a.forEach((s,o)=>it(o,s)),t.classList.remove("is-visible"),St()}}function _n(e){ta(e)}function Nn(e){const n=A().actionQueue[e];if(!n)return;const{performer:a,target:s,sourceManeuver:o}=n;o.tags.includes("攻撃")?wn(a,s,o,e):Mt(e)}function Pn(e){na(e)}function Dn(e){const{damageQueue:t}=A(),n=t[e];if(n&&!n.applied){const a=P(n.target.id);if(!a)return;const s=()=>{aa(e)};a.category==="レギオン"||Object.values(a.partsStatus).flat().filter(o=>!o.damaged).length<=n.amount?(a.category==="レギオン"?(E(`レギオンへの攻撃！ ${n.amount}体の兵員が失われます。`),Ne(a.id,null,n.amount)):(E(`＞ ${a.name}は残りパーツ数以上のダメージを受け、完全に破壊されました！`),j(a.id,{isDestroyed:!0})),zn(a.id),s()):Rn(a,n.amount,n.location,s)}}function Rn(e,t,n,a){const s=document.getElementById("damageModal"),o=s.querySelector("#damageModalTitle"),i=s.querySelector("#damageModalInfo"),c=s.querySelector("#partsGridContainer"),l=s.querySelector("#confirmDamageBtn");o.textContent=`${e.name} へのパーツ損傷処理`,c.innerHTML="";let p=[];const u=()=>{i.textContent=`損傷させるパーツを ${t} 個選択してください (残り: ${t-p.length})`,l.disabled=p.length!==t};u();const r=e.category==="ホラー",m={頭:"head",腕:"arms",胴:"torso",脚:"legs",体:"body"},d=m[n]||null;if((r?["body"]:["head","arms","torso","legs","body"]).forEach(g=>{const f=e.partsStatus[g];if(f&&f.length>0){const v=document.createElement("div");v.className="part-location-group",v.dataset.location=g,v.innerHTML=`<h4>${Object.keys(m).find(b=>m[b]===g)||"他"}</h4>`;const C=document.createElement("div");C.className="parts-wrapper",f.forEach(b=>{const y=document.createElement("div");y.className="part-item",y.textContent=b.name,y.dataset.partId=b.id;const M=_(b.name);M&&(y.addEventListener("mouseenter",()=>Et(s.getBoundingClientRect(),y.getBoundingClientRect(),e,{data:M,isDamaged:b.damaged})),y.addEventListener("mouseleave",()=>te())),b.damaged?y.classList.add("is-damaged"):y.onclick=()=>{const w=b.id,L=p.indexOf(w);L>-1?(y.classList.remove("is-selected"),p.splice(L,1)):p.length<t&&(y.classList.add("is-selected"),p.push(w)),u()},C.appendChild(y)}),v.appendChild(C),c.appendChild(v)}}),d&&c.querySelector(`.part-location-group[data-location="${d}"]`)?.classList.add("is-highlighted"),d&&e.partsStatus[d]){const g=e.partsStatus[d].filter(f=>!f.damaged);g.length>0&&g.length<=t&&g.forEach(f=>{const v=c.querySelector(`.part-item[data-part-id="${f.id}"]`);v&&!v.classList.contains("is-selected")&&(v.classList.add("is-selected"),p.push(f.id))})}u(),l.onclick=()=>{p.forEach(g=>Ne(e.id,g)),s.classList.remove("is-visible"),te(),Un(e.id),Q(),a&&a()},document.getElementById("closeDamageModalBtn").onclick=()=>{s.classList.remove("is-visible"),te()},s.classList.add("is-visible")}const On="1.12.68";let ie=null;const le=["奈落","地獄","煉獄","花園","楽園"],Me=Array.from({length:26},(e,t)=>20-t);function Hn(){console.log("UI Manager initialized.")}function jn(){document.documentElement.style.setProperty("--col-count",Me.length),document.documentElement.style.setProperty("--row-count",le.length);const e=document.getElementById("battleWrap");e.innerHTML="";const t=document.createElement("div");t.className="current-action-cell",t.id="currentActionValue",e.appendChild(t),Me.forEach((a,s)=>{const o=document.createElement("div");o.className="col-header",o.textContent=a,o.dataset.col=String(a),o.style.gridColumn=(s+2).toString(),o.style.gridRow="1",e.appendChild(o)});const n={奈落:"naraku",地獄:"jigoku",煉獄:"rengoku",花園:"hanazono",楽園:"rakuen"};le.forEach((a,s)=>{const o=document.createElement("div");o.className="row-header";const i=n[a];i&&o.classList.add(`area-color-${i}`),o.textContent=a,o.style.gridColumn="1",o.style.gridRow=(s+2).toString(),e.appendChild(o)}),le.forEach((a,s)=>{Me.forEach((o,i)=>{const c=document.createElement("div");c.className="cell";const l=n[a];l&&c.classList.add(`cell-area-${l}`),o===0?c.classList.add("col-zero"):o<0&&c.classList.add("col-negative"),c.dataset.row=String(s),c.dataset.col=String(o),c.style.gridColumn=(i+2).toString(),c.style.gridRow=(s+2).toString(),e.appendChild(c)})})}function ae(e,t=2e3){const n=document.getElementById("toast-notification");n&&(ie&&clearTimeout(ie),n.innerHTML=e,n.classList.add("is-visible"),ie=setTimeout(()=>{n.classList.remove("is-visible"),ie=null},t))}function T(){const e=B(),t=e.filter(a=>a.type==="pc"),n=e.filter(a=>a.type==="enemy");We(document.getElementById("pcContainer"),t,"pc"),We(document.getElementById("enemyContainer"),n,"enemy"),Q(),he()}function We(e,t,n){e.innerHTML="";const a=!A().isStarted;if(t.forEach(s=>{const o=$t(s,a);e.appendChild(o)}),a){const s=document.createElement("div");s.className="add-char-card";const o=n==="pc"?"姉妹ドール":"NCの手駒";s.innerHTML=`<div class="add-char-text">${o}</div><div class="add-char-plus">+</div><div class="add-char-text">アンデッドを追加</div>`,e.appendChild(s)}}function $t(e,t){let n="";e.isMentallyBroken&&(n+=" status-mental-collapse"),e.isDestroyed&&(n+=" status-destroyed"),e.hasWithdrawn&&(n+=" status-withdrawn");let a="";(e.isDestroyed||e.hasWithdrawn)&&(a+=" is-inactive");const s=document.createElement("div");s.className=`char ${a.trim()}`,s.dataset.id=e.id;const o=`
        <div class="card-actions-overlay">
            <div class="card-action-row">
                <button class="card-action-btn" data-action="place">移動</button>
                <button class="card-action-btn" data-action="details">詳細</button>
                <button class="card-action-btn" data-action="delete">削除</button>
            </div>
            <div class="card-action-row">
                <button class="card-action-btn" data-action="move-left">←</button>
                <button class="card-action-btn" data-action="move-right">→</button>
            </div>
        </div>`;let i="";e.regrets&&e.regrets.length>0&&(i=`<div class="char-madness">${e.regrets.map(h=>{const g=h.points||0;let f="";for(let C=0;C<4;C++)f+=C<g?"◆":"◇";return`<div class="${g>=4?"is-madness":""}">${f}</div>`}).join("")}</div>`);let c="";if(e.partsStatus){let d="";if(e.category==="ドール"||e.category==="サヴァント"){const h=["head","arms","torso","legs","body"],g={head:"頭",arms:"腕",torso:"胴",legs:"脚",body:"他"},f=e.treasure;d=h.map(v=>{if(!e.partsStatus[v]||e.partsStatus[v].length===0)return"";const b=e.partsStatus[v].map(y=>{const M=_(y.name),w=M&&M.id&&M.id.startsWith("BP-"),L=y.name===f;return{part:y,isBasicPart:w,isTreasure:L,damaged:y.damaged}}).sort((y,M)=>y.isTreasure!==M.isTreasure?y.isTreasure?-1:1:y.isBasicPart!==M.isBasicPart?y.isBasicPart?1:-1:y.damaged!==M.damaged?y.damaged?-1:1:0).map(y=>y.isTreasure?y.damaged?"☆":"★":y.isBasicPart?y.damaged?"□":"■":y.damaged?"〇":"●").join("");return v==="body"&&!e.partsStatus[v].some(y=>y.name!==f)?"":`<div>${b}：${g[v]}</div>`}).filter(v=>v!=="").join("")}else if(e.category==="ホラー"){const h=Object.values(e.partsStatus).flat(),g=[],f=[];h.forEach(b=>{const y=_(b.name);y&&y.id&&y.id.startsWith("BP-")?g.push(b):f.push(b)});let v="";if(f.length>0){const b=f.filter(M=>M.damaged).length;v=`<div>${"〇".repeat(b)+"●".repeat(f.length-b)}：強</div>`}let C="";if(g.length>0){const b=g.filter(M=>M.damaged).length;C=`<div>${"□".repeat(b)+"■".repeat(g.length-b)}：基</div>`}d=C+v}else if(e.category==="レギオン"){const h=e.isDestroyed?0:e.stackCount,g=Math.ceil(h/10),f=[];for(let v=0;v<g;v++){const C=v*10,b=Math.min(h-C,10);b>0&&f.push(`<div>${"●".repeat(b)}：</div>`)}d=f.reverse().join("")}d&&(c=`<div class="char-parts-status">${d}</div>`)}const l=e.category==="レギオン";let p="";l?p=`<div class="char-stack-count">${e.isDestroyed?0:e.stackCount}体</div>`:p=`<div class="char-parts-count">${e.isDestroyed?0:Object.values(e.partsStatus).flat().filter(h=>!h.damaged).length}</div>`;const u=`
        <div class="char-action-display">
            <div class="char-action-value">${e.actionValue}</div>
            <div class="char-action-subtext">行動値</div>
            <div class="char-action-subtext">最大:${e.maxActionValue}</div>
        </div>
    `,m=`area-color-${{奈落:"naraku",地獄:"jigoku",煉獄:"rengoku",花園:"hanazono",楽園:"rakuen"}[e.area]||""}`;return s.innerHTML=`
        <div class="char-status-overlays ${n.trim()}">
            <div class="status-tape status-tape-mental-collapse">BREAKDOWN 精神崩壊 BREAKDOWN</div>
            <div class="status-tape status-tape-destroyed">DESTROYED 完全破壊 DESTROYED</div>
            <div class="status-tape status-tape-withdrawn">ESCAPE 戦場離脱 ESCAPE</div>
        </div>
        <div class="char-img-container">
            <div class="damage-prompt-container"></div> 
            <div class="char-area-name ${m}">${e.area}</div>
            <div class="char-name-overlay">${e.name}</div>
            ${p}
            ${u}
            ${i} 
            ${c} 
            <img src="${e.img}" alt="${e.name}">
        </div>
        <div class="char-stats">
        </div>
        ${t?o:""}
    `,s}function qn(e){if(!e)return;const{actionValue:t,area:n,id:a,name:s,img:o,stackCount:i}=e,c=document.getElementById("battleWrap"),l=le.indexOf(n);if(l===-1)return;const p=c.querySelector(`.cell[data-row="${l}"][data-col="${t}"]`);if(!p)return;const u=document.createElement("span");u.className="marker",u.dataset.id=a,u.dataset.name=s;const r=new Image;if(r.src=o,r.className="marker-img",r.alt=s,u.appendChild(r),e.category==="レギオン"&&i>1){const m=document.createElement("div");m.className="marker-stack-count",m.textContent=`x${i}`,u.appendChild(m)}p.appendChild(u)}function Ct(e){if(!e||e.length===0)return;const t=e[0].id,n=document.querySelector(`.char[data-id="${t}"]`);n&&n.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}function E(e){const t=document.getElementById("logEntries");if(!t)return;const n=document.createElement("div");n.className="log-entry",n.innerHTML=e,t.appendChild(n),t.scrollTop=t.scrollHeight}function Vn(){const e=document.getElementById("madnessModal"),t=document.getElementById("madnessModalBody");t.innerHTML="";const n=B().filter(a=>a.type==="pc"&&!a.isDestroyed&&!a.hasWithdrawn);if(n.length===0){St();return}n.forEach(a=>{const s=document.createElement("div");s.className="pc-regret-group",s.dataset.pcId=a.id,s.innerHTML=`<h4>${a.name}の未練 (1つ選択)</h4>`,a.regrets.forEach(o=>{const i=document.createElement("div");i.className="regret-item",i.dataset.regretId=o.id,i.textContent=`${o.name} (狂気点: ${o.points})`,s.appendChild(i)}),t.appendChild(s)}),e.classList.add("is-visible"),xn(n)}function Un(e){const t=P(e);if(!t)return;const n=document.querySelector(`.char[data-id="${e}"]`);if(n){const a=!A().isStarted,s=$t(t,a);n.replaceWith(s),he()}}function Q(){document.getElementById("battleWrap").querySelectorAll(".marker").forEach(n=>n.remove()),B().filter(n=>!n.isDestroyed&&!n.hasWithdrawn).forEach(n=>{qn(n)}),he()}function Be(){const{isStarted:e,turn:t,count:n,activeActors:a,shouldScrollToCount:s}=A(),o=document.getElementById("timingArea"),i=document.getElementById("battleWrap");o&&(e?(o.classList.remove("setup-phase"),o.classList.add("battle-phase"),i.classList.remove("setup-phase")):(o.classList.add("setup-phase"),o.classList.remove("battle-phase"),i.classList.add("setup-phase")));const c=document.getElementById("turnIndicator").textContent;String(t)!==c&&e&&E(`【ターン ${t} 開始】`);const l=document.getElementById("turnIndicator"),p=document.getElementById("countIndicator"),u=document.getElementById("currentActionValue");if(!e){l.textContent="-",p.textContent="-",u.textContent="カウント -",document.querySelectorAll(".highlight-char").forEach(r=>r.classList.remove("highlight-char")),i.querySelectorAll(".highlight-col").forEach(r=>r.classList.remove("highlight-col")),fe(A());return}if(l.textContent=t,p.textContent=n,u.textContent=`カウント ${n}`,document.querySelectorAll(".char").forEach(r=>{r.classList.toggle("highlight-char",a.some(m=>m.id===r.dataset.id))}),i.querySelectorAll(".highlight-col").forEach(r=>r.classList.remove("highlight-col")),i.querySelectorAll(`.cell[data-col="${n}"], .col-header[data-col="${n}"]`).forEach(r=>r.classList.add("highlight-col")),s){const r=document.querySelector(".battle-grid-scroll-wrapper"),m=i.querySelector(`.col-header[data-col="${n}"]`),d=i.querySelector(".row-header");if(r&&m&&d){const h=d.offsetWidth,f=m.offsetLeft-h;r.scrollTo({left:f,behavior:"smooth"})}Zn()}a.length>0&&Ct(a),fe(A()),Re()}function Wn(e){const t=new Set(e.map(n=>n.id));document.querySelectorAll(".char").forEach(n=>{n.classList.toggle("highlight-char",t.has(n.dataset.id))})}function fe(e){if(!e)return;const{phase:t,actionQueue:n,activeActors:a,count:s}=e,o={action:document.getElementById("actionPhaseIndicator"),rapid:document.getElementById("rapidPhaseIndicator"),judge:document.getElementById("judgePhaseIndicator"),damage:document.getElementById("damagePhaseIndicator")};Object.values(o).forEach(l=>l.classList.remove("active")),a.length>0&&o.action.classList.add("active"),n.length>0&&(o.rapid.classList.add("active"),o.judge.classList.add("active")),(t==="JUDGE_RESOLUTION"||t==="ACTION_RESOLUTION")&&o.judge.classList.add("active"),t==="DAMAGE_RESOLUTION"&&o.damage.classList.add("active");const i=document.getElementById("countdownBtn"),c=document.getElementById("endTurnBtn");i.disabled=!0,c.disabled=!0,t==="COUNT_END"?i.disabled=!1:t==="TURN_END_PREPARATION"&&(c.disabled=!1)}function Re(){const{actionQueue:e,rapidQueue:t,judgeQueue:n,damageQueue:a}=A();ke("actionDeclarationList",e,"アクション宣言"),ke("rapidDeclarationList",t,"ラピッド宣言"),ke("judgeDeclarationList",n,"ジャッジ宣言"),Qn(a),document.querySelectorAll(".damage-prompt-button").forEach(o=>o.remove());const s={};a.forEach(o=>{if(!o.applied){const i=o.target.id;s[i]||(s[i]=0),s[i]+=o.amount}});for(const o in s)s[o]>0&&Fn(o,s[o]);document.getElementById("actionDeclarationArea").classList.toggle("is-closed",e.length===0),document.getElementById("rapidDeclarationArea").classList.toggle("is-closed",t.length===0),document.getElementById("judgeDeclarationArea").classList.toggle("is-closed",n.length===0),document.getElementById("damageProcessingArea").classList.toggle("is-closed",a.length===0)}function ke(e,t,n){const a=document.getElementById(e);if(!a)return;const s=a.closest(".accordion-container"),o=s?s.querySelector(".accordion-header"):null;if(!o)return;const i=A(),c=i.phase==="RAPID_RESOLUTION",l=i.phase==="JUDGE_RESOLUTION",p=i.phase==="ACTION_RESOLUTION",u=i.rapidQueue.some(d=>!d.checked),r=i.judgeQueue.some(d=>!d.checked);let m=o.querySelector("span");if(!m){const d=o.textContent;o.innerHTML="",m=document.createElement("span"),m.textContent=d,o.appendChild(m)}t.length===0?(a.innerHTML="",m.textContent=n+"はありません"):(m.textContent=n,a.innerHTML="",t.forEach((d,h)=>{const g=document.createElement("label");g.className="action-queue-item";let f=!1;e==="rapidDeclarationList"?f=!c:e==="judgeDeclarationList"?f=!l||u:e==="actionDeclarationList"&&(f=!p||u||r),d.checked&&(f=!0),f&&g.classList.add("is-disabled"),d.checked&&g.classList.add("is-checked");const v=document.createElement("input");v.type="checkbox",v.checked=d.checked,v.disabled=!0,f||(e==="rapidDeclarationList"?g.onclick=()=>_n(h):e==="judgeDeclarationList"?g.onclick=()=>Pn(h):e==="actionDeclarationList"&&(g.onclick=()=>Nn(h))),g.appendChild(v);const C=document.createElement("span");let b=`<b>${d.performer.name}</b>: 【${d.summary.name}】`;d.target&&(b+=` → <b>${d.target.name}</b>`),C.innerHTML=b,g.appendChild(C),a.appendChild(g)}))}function Qn(e){const t=document.getElementById("damageProcessingList");if(!t)return;const n=t.closest(".accordion-container"),a=n?n.querySelector(".accordion-header"):null,s=A().phase==="DAMAGE_RESOLUTION";e.length===0?(t.innerHTML="",a&&(a.textContent="ダメージ処理はありません")):(a&&(a.textContent="ダメージ処理"),t.innerHTML="",e.forEach((o,i)=>{const c=document.createElement("label");c.className="action-queue-item damage-item";const l=!s||o.applied;l&&c.classList.add("is-disabled"),o.applied&&c.classList.add("is-checked");const p=document.createElement("input");p.type="checkbox",p.checked=o.applied,p.disabled=!0;const u=document.createElement("span");u.innerHTML=`<b>${o.target.name}</b>: ${o.location}: <b>${o.amount}</b>点`,!o.applied&&!l&&(c.onclick=()=>Dn(i)),c.appendChild(p),c.appendChild(u),t.appendChild(c)}))}function Fn(e,t){const n=document.querySelector(`.char[data-id="${e}"]`);if(!n)return;const a=n.querySelector(".damage-prompt-container");let s=a.querySelector(".damage-prompt-button");if(s){const i=parseInt(s.dataset.damage,10)+t;s.dataset.damage=i,s.textContent=`ダメージ ${i}`}else s=document.createElement("button"),s.className="damage-prompt-button",s.dataset.damage=t,s.textContent=`ダメージ ${t}`,s.onclick=o=>{o.stopPropagation()},s.style.pointerEvents="none",a.appendChild(s)}function zn(e){const t=document.querySelector(`.char[data-id="${e}"]`);if(t){const n=t.querySelector(".damage-prompt-button");n&&n.remove()}}function ve(){const e=document.getElementById("startBattleBtn");if(!e)return;const t=B(),n=t.some(s=>s.type==="pc"),a=t.some(s=>s.type==="enemy");e.disabled=!(n&&a)}function Et(e,t,n,a){const s=document.getElementById("maneuverCard"),o=a.data,i=o.category==="行動値増加"?"行動値":o.category||"その他",c=`category-color-${lt(i)}`,l=Gn(o),p=Jn(o,n);let u="";o.source&&(u=o.source.book||"",o.source.page&&(u+=` (p${o.source.page})`),o.source.errata&&(u+=`, エラッタ ${o.source.errata}`)),s.innerHTML=`
        <div class="card-category-bar ${c}">${i}</div>
        <div class="card-content">
            <div class="card-source-header">
                ${l}
            </div>
            <div class="card-header">
                <span class="card-location-text">${p}</span>
                <span class="card-maneuver-name">【${o.name}】</span>
            </div>
            <div class="card-stats">
                <div><span>T</span>${o.timing}</div>
                <div><span>C</span>${o.cost}</div>
                <div><span>R</span>${o.range}</div>
            </div>
            <div class="card-row"><strong>効果</strong> ${o.description||"---"}</div>
            <div class="card-row"><strong>説明</strong> ${o.description_raw||"---"}</div>
            <div class="card-row"><strong>出典</strong> ${u||"---"}</div>
        </div>
    `,s.style.display="flex";const r=s.getBoundingClientRect();let m=20,d=t.top+60;d+r.height>window.innerHeight&&(d=20),d<10&&(d=20),s.style.left=`${m}px`,s.style.top=`${d}px`}function Gn(e){if(!e.id)return"不明";const t=pe(),n=e.id,a=n.substring(0,2);if(t.positions[a])return`ポジションスキル：${t.positions[a].name}`;if(t.classes[a])return n.endsWith("-SP")?`特化スキル：${t.classes[a].name}`:`クラススキル：${t.classes[a].name}`;if(a==="BP")return"基本パーツ";const s=n.substring(0,1),o=n.substring(1,2);return t.enhancementTypes[s]&&["1","2","3"].includes(o)?`強化パーツ：${o}レベル${t.enhancementTypes[s].name}`:n.startsWith("P")?`手駒専用パーツ：悪意${parseInt(n.substring(1,2),10)/2}`:t.pawnSkills[a]?t.pawnSkills[a].name:t.commonAction[a]?t.commonAction[a].name:"スキル"}function Jn(e,t){if(!e.id||!t.partsStatus)return"";const n={head:"頭",arms:"腕",torso:"胴",legs:"脚",body:"体"};for(const a in t.partsStatus)if(t.partsStatus[a].some(s=>s.name===e.name))return`${n[a]||"体"}：`;return"スキル："}function te(){document.getElementById("maneuverCard").style.display="none"}function Kn(e){const t=document.getElementById("version-info");if(t&&e){const a=["app","battle-logic","ui-manager","interaction-manager","character-manager","settings-manager","menu-builder","data-handler","ui-helpers","dice-roller","dice-3d","character-converter"].map(s=>`<span class="responsive-item">${s}: v${e[s]||"N/A"}</span>`).join('<span class="hide-on-mobile"> | </span>');t.innerHTML=a}}function R(e){const t=document.getElementById("simpleMenuModal"),n=document.getElementById("simpleMenuModalTitle"),a=document.getElementById("simpleMenuModalBody"),s=document.getElementById("simpleMenuModalFooter"),o=document.getElementById("closeSimpleMenuModalBtn");if(!t||!n||!a||!s||!o)return;n.textContent=e.title||"",a.innerHTML=e.bodyHtml||"",s.innerHTML=e.footerHtml||"",s.style.display=e.footerHtml?"block":"none",a.classList.remove("attack-confirm-body"),e.bodyHtml&&e.bodyHtml.includes("attack-confirm-summary")&&a.classList.add("attack-confirm-body"),e.items&&e.items.forEach(c=>{const l=document.createElement("div");c.isTitle||(l.textContent=c.label,l.classList.add("maneuver-item"),c.class&&l.classList.add(...c.class.split(" ")),c.isDisabled&&l.classList.add("is-masked"),l.onclick=()=>{c.isDisabled||(i(),c.onClick&&c.onClick())}),a.appendChild(l)});const i=()=>t.classList.remove("is-visible");o.onclick=i,t.onclick=c=>{c.target===t&&i()},e.onRender&&e.onRender(t,i),t.classList.add("is-visible")}const Yn="1.14.57";let $={isStarted:!1,turn:1,count:0,activeActors:[],phase:"SETUP",actionQueue:[],rapidQueue:[],judgeQueue:[],damageQueue:[],moveQueue:[],currentAction:null,shouldScrollToCount:!1};function Xn(){$.isStarted=!0,$.turn=1;const e=B();$.count=Math.max(0,...e.map(t=>t.actionValue)),T(),$.shouldScrollToCount=!0,Oe(),O()}function A(){return{...$}}function Zn(){$.shouldScrollToCount=!1}function W(e,t,n=null,a=null){const s={id:`decl_${Date.now()}_${Math.random()}`,performer:e,target:n,sourceManeuver:t,timing:t.timing,isResolved:!1,summary:{name:t.name,cost:t.cost,range:t.range,description:t.description}},o=isNaN(Number(t.cost))?0:Number(t.cost);switch(o>0&&j(e.id,{actionValue:e.actionValue-o}),t.name!=="待機"&&j(e.id,{hasActedThisCount:!0}),t.timing){case"ラピッド":$.rapidQueue.push(s),E(`◆[ラピッド] ${e.name}が【${t.name}】を宣言。`);break;case"ジャッジ":s.judgeTarget=a,$.judgeQueue.push(s),E(`◆[ジャッジ] ${e.name}が【${t.name}】を宣言。`);break;case"ダメージ":E(`◆[ダメージ] ${e.name}が【${t.name}】を宣言。`);break;default:$.actionQueue.push(s),E(`◆[アクション] ${e.name}が【${t.name}】を宣言。`);break}e.turnLimitedManeuvers.has(t.name)&&e.usedManeuvers.add(t.name),T(),Q(),O()}function O(){if(!$.isStarted)return;const e=B();if(e.length===0){$.count=0,$.activeActors=[],Be();return}const t=e.filter(d=>d.actionValue>=$.count&&!d.hasActedThisCount),n=t.some(d=>d.type==="enemy");let a=[];n?a=t.filter(d=>d.type==="enemy"):a=t,$.activeActors=a;const s=$.phase;let o=$.phase;const i=B().filter(d=>!d.isDestroyed&&!d.hasWithdrawn),c=i.filter(d=>d.actionValue>=$.count&&!d.hasActedThisCount),l=$.rapidQueue.some(d=>!d.checked),p=$.judgeQueue.some(d=>!d.checked),u=$.actionQueue.some(d=>!d.checked),r=$.damageQueue.some(d=>!d.applied),m=i.some(d=>d.actionValue>0);if(c.length>0?o="ACTION_DECLARATION":l?o="RAPID_RESOLUTION":p?o="JUDGE_RESOLUTION":u?o="ACTION_RESOLUTION":r?o="DAMAGE_RESOLUTION":$.count>0&&m?o="COUNT_END":o="TURN_END_PREPARATION",$.phase=o,s!==$.phase)switch($.phase){case"RAPID_RESOLUTION":E("--- ラピッド解決フェーズ開始 ---");break;case"JUDGE_RESOLUTION":E("--- ジャッジ解決フェーズ開始 ---");break;case"ACTION_RESOLUTION":E("--- アクション解決フェーズ開始 ---");break;case"DAMAGE_RESOLUTION":E("--- ダメージ解決フェーズ開始 ---");break;case"COUNT_END":E("--- カウント終了 ---");break;case"TURN_END_PREPARATION":E("--- ターン終了準備 ---");break}Be(),T(),Q(),Re(),Wn($.activeActors)}function ea(){B().forEach(n=>n.hasActedThisCount=!1);const t=B().filter(n=>!n.isDestroyed&&!n.hasWithdrawn).map(n=>n.actionValue).filter(n=>n<$.count);t.length>0?($.count=Math.max(...t),$.shouldScrollToCount=!0,Oe(),O()):kt()}function Oe(){$.phase="ACTION_DECLARATION",$.actionQueue=[],$.rapidQueue=[],$.judgeQueue=[],$.damageQueue=[],Re(),fe($)}async function ta(e){const t=$.rapidQueue[e];!t||t.checked||(await wt(t),t.checked=!0,O())}async function Mt(e,t=0){const n=$.actionQueue[e];if(!n||n.checked)return;const{targets:a}=De(n.performer,n.sourceManeuver);if(n.target&&!a.some(o=>o.id===n.target.id)){E(`＞ 解決失敗: ${n.target.name} は射程外です。`),n.checked=!0,O();return}await wt(n,t),n.checked=!0,$.actionQueue.every(o=>o.checked)?oa():O()}function na(e){const t=$.judgeQueue[e];t&&!t.checked&&(t.checked=!0,E(`＞ [ジャッジ] ${t.performer.name}の【${t.sourceManeuver.name}】を解決(チェック)しました。`)),O()}function kt(){$.phase="MADNESS_PHASE",E("【ターン終了】各ドールは未練に狂気点を1点加えます。"),Vn(),fe($)}function St(){$.turn++,B().forEach(n=>{n.activeBuffs=n.activeBuffs.filter(a=>a.duration!=="end_of_turn")}),rt();const e=B(),t=Math.max(0,...e.map(n=>n.actionValue));$.count=t>0?t:0,$.shouldScrollToCount=!0,T(),Oe(),O()}function aa(e){const t=$.damageQueue[e];t&&!t.applied&&(t.applied=!0,t.sourceAction&&(t.sourceAction.damageApplied=!0)),O()}function sa(){$.damageQueue.some(t=>!t.applied)?($.phase="DAMAGE_RESOLUTION",E("--- ダメージ解決フェーズ開始 ---")):($.phase="COUNT_END",E("--- カウント終了 ---"))}function oa(){$.moveQueue.length>0&&(E("--- 移動解決フェーズ ---"),ct($.moveQueue),$.moveQueue=[],Q()),sa(),O()}function ia(e,t){let n=JSON.stringify(e);return n=n.replace(/"\$params\.(\w+)"/g,(a,s)=>t.hasOwnProperty(s)?JSON.stringify(t[s]):"null"),JSON.parse(n)}async function ra(e,t){const n=Pt(e.ref);if(!n){console.warn(`[Engine] 汎用効果 '${e.ref}' の定義が見つかりません。`);return}const a=e.params||{};for(const s of n.actions){const o=ia(s,a);switch(o.action_type){case"attack_roll":await da(o,t);break;case"move_character":ca(o,t);break;case"apply_buff":la(o,t);break;case"escape_roll":It(o,t);break;default:E(`＞ [Engine] 未対応のアクションタイプ: ${o.action_type}`),console.warn(`[Engine] 未対応のアクションタイプです: ${o.action_type}`)}}}function ca(e,t){const{performer:n,declaration:a}=t,s=a.sourceManeuver.targetArea;if(!s){E("＞ [Engine] 移動先が指定されていません。");return}E(`＞ 移動予約: ${n.name} が ${s} へ`),$.moveQueue.push({characterId:n.id,targetArea:s})}function la(e,t){const{performer:n}=t,a=e.buff?e.buff:e;switch(a.stat){case"maxActionValue":j(n.id,{baseActionValue:(n.baseActionValue||6)+a.value}),E(`＞ ${n.name}の最大行動値が${a.value>0?"+":""}${a.value}されました。`);break;case"attackCheckBonus":n.activeBuffs.push({source:t.declaration.sourceManeuver.name,stat:a.stat,value:a.value,duration:a.duration}),E(`＞ ${n.name}は【${t.declaration.sourceManeuver.name}】の効果で、ターン終了まで攻撃判定に+${a.value}の修正を得た！`);break;default:E(`＞ [Engine] 未対応のバフタイプ: ${a.stat}`),console.warn(`[Engine] 未対応のバフタイプです: ${a.stat}`)}}async function da(e,t){const{target:n,declaration:a}=t;if(!n){E("＞ 攻撃対象がいません。");return}const s=t.totalAttackBonus||0,o=`NA${s>=0?`+${s}`:s}`;return new Promise(i=>{x({command:o,showToast:!0,callback:(c,l)=>{if(c&&!c.includes("失敗")){E(`＞ ${n.name}に命中！`);let p=e.damage||0;$.damageQueue.push({id:`damage_${Date.now()}_${Math.random()}`,target:n,amount:p,location:l,sourceAction:a,applied:!1}),E(`＞ 【${p}】点のダメージ！`),e.on_hit&&e.on_hit.length>0&&E(`＞ 追加効果(${e.on_hit.join(",")})が発動！`)}else E("＞ 攻撃は失敗しました。");i()}})})}async function wt(e,t=0){const{performer:n,sourceManeuver:a}=e;if(E(`＞ 解決: ${n.name} の【${a.name}】`),a.isEscapeAttempt){await It({},{performer:n});return}if(!a.effects||a.effects.length===0){a.name==="待機"?E(`＞ ${n.name}は状況をうかがっている。`):E("＞ 効果の定義がありません。");return}const s={performer:e.performer,target:e.target,declaration:e,totalAttackBonus:t};for(const o of a.effects)await ra(o,s)}function It(e,t){const{performer:n}=t;E(`＞ ${n.name}が逃走判定を行います...`),x({command:"NC",showToast:!0,callback:a=>{a.includes("成功")?(E(`＞ 逃走成功！ ${n.name}は戦場から離脱しました。`),j(n.id,{hasWithdrawn:!0})):E(`＞ 逃走失敗！ ${n.name}は戦場に留まります。`),T(),Q(),O()}})}const ua="1.1.8";document.addEventListener("DOMContentLoaded",async()=>{try{await Bt(),at(_e()),Hn(),Ln(),mn(),rn({hintMasterData:Dt(),regretMasterData:xe(),takaramonoMasterData:_t(),memoryFragmentsData:Nt(),addLog:E}),ma()}catch(e){document.body.innerHTML=`<div style="color: red; padding: 20px;">アプリケーションの初期化に失敗しました。<br>${e.stack}</div>`}});function ma(){const e=`
    <div class="modal-header modal-header-sub">📢主な更新内容:7.10.1.15</div>
    <div class="modal-body welcome-modal-body">
      <p>◆ ジャッジウィンドウで<strong>適用されている支援、妨害を確認</strong>できるようになりました。
      <p>◆ <strong>支援</strong>がダイスロールに適用できるようになりました。
      <p>◆ ユーザーが<strong>画像を追加</strong>できるようになりました。
      <p>◆ <strong>【保管所で見る】</strong>：キャラクターシート保管所の<strong>キャラクターへのリンク</strong>を追加しました。
      <p>◆ <strong>【新着/IDリスト】</strong>：キャラクターシート保管所の<strong>キャラクターリスト表示</strong>機能を追加しました。
      <p>◆ <strong>【保管所から読込み】</strong>：<strong>キャラクターシート保管所</strong>からの<strong>キャラクター読込み</strong>機能を追加しました。
      <p>◆ <strong>【✏️画像の変更】</strong>：「🪪人形設計図」において<strong>画像の変更</strong>機能を追加しました。
      <p>◆ <strong>マニューバリスト</strong>を更新し、<strong>表示機能を拡張</strong>しました。
      <p>◆ その他、軽微なUI調整と不具合の修正を行いました。
    </div>
  `;jn(),T(),Be(),An(),ve();const t=document.getElementById("welcomeModal"),n=document.getElementById("closeWelcomeModalBtn");if(t&&n){t.classList.add("is-visible");const s=()=>{t.classList.remove("is-visible"),R({title:"更新情報",bodyHtml:e,footerHtml:'<button id="okUpdateBtn" class="welcome-modal-close-btn">OK</button>',onRender:(o,i)=>{o.querySelector("#okUpdateBtn").onclick=i}})};n.onclick=s,t.onclick=o=>{o.target===t&&s()}}Kn({app:ua,"battle-logic":Yn,"character-manager":Xe,"data-handler":Tt,"dice-roller":on,"dice-3d":Ut,"interaction-manager":In,"menu-builder":gn,"ui-helpers":Vt,"ui-manager":On,"settings-manager":un,"character-converter":ln})}
