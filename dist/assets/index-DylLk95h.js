import*as k from"https://unpkg.com/three@0.160.0/build/three.module.js";import*as S from"https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js";import{FBXLoader as At}from"https://unpkg.com/three@0.160.0/examples/jsm/loaders/FBXLoader.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Tt="1.4.7";let X={},ne={},Qe={},Fe={},ze={},Ge={},Je={},Ke={},Ye={};async function Bt(){try{const t=["positions.json","classes.json","basic_parts.json","armed_parts.json","mutant_parts.json","custom_parts.json","tegoma_skills.json","tegoma_parts.json","tegoma_parts0.json"].map(u=>fetch(`data/maneuvers/${u}`).then(r=>r.json())),[n,a,s,o,i,c,l,...p]=await Promise.all([fetch("data/hint.json"),fetch("data/regret.json"),fetch("data/takaramono.json"),fetch("data/memory_fragments.json"),fetch("data/undead.json"),fetch("data/core-data.json"),fetch("data/effects_db.json"),...t]);X=p.reduce((u,r)=>({...u,...r}),{}),[Ye,Qe,Fe,ze,Je,Ke,Ge]=await Promise.all([n.json(),a.json(),s.json(),o.json(),i.json(),c.json(),l.json()]),ne={};for(const u in X){const r=X[u];r&&r.name&&(ne[r.name]={id:u,...r})}console.log("Data handler initialized successfully!")}catch(e){throw console.error("Error in data handler initialization:",e),e}}function xt(){return X}function _(e){return ne[e]}function xe(){return Qe}function _t(){return Fe}function Nt(){return ze}function _e(){return Je}function pe(){return Ke}function Pt(e){return Ge[e]}function Dt(){return Ye}function Rt(){const e=_e(),t=new Set;for(const n in e)e[n]&&e[n].img&&t.add(e[n].img);return[...t]}function Ot(e){if(!e||!e.name){console.warn("è¿½åŠ ã—ã‚ˆã†ã¨ã—ãŸãƒãƒ‹ãƒ¥ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™:",e);return}if(ne[e.name])return;const t=`CSTM_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;e.id=t,X[t]=e,ne[e.name]=e,console.log(`ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ‹ãƒ¥ãƒ¼ãƒã€Œ${e.name}ã€ã‚’å‹•çš„ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`)}const Xe="1.5.17";let Ze={},I=[],et=1;function se(e){let t=0;[...e.skills||[],...Object.values(e.partsStatus||{}).flat().map(a=>a.name)].forEach(a=>{const s=_(a);if(!s||!s.effects||s.effects.length===0)return;let o=!1;if(e.partsStatus){const i=Object.values(e.partsStatus).flat().find(c=>c.name===a);i&&(o=i.damaged)}for(const i of s.effects)i.ref==="APPLY_BUFF"&&i.params.stat==="maxActionValue"?(isNaN(o)||!o)&&(t+=i.params.value||0):i.ref==="MODIFY_MAX_ACTION_VALUE_ON_DAMAGE"&&o&&(t+=i.params.value||0)}),e.maxActionValue=(e.baseActionValue||6)+t}function Ht(e,t,n){const a=Ze[e];if(!a)return console.error(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${e}`),null;const s=JSON.parse(JSON.stringify(a));s.id=`char_${et++}`,s.type=t,s.area=n||a.initialArea||(t==="pc"?"ç…‰ç„":"å¥ˆè½"),s.partsStatus={};let o=0;if(a.parts&&typeof a.parts=="object"&&Object.keys(a.parts).forEach(i=>{Array.isArray(a.parts[i])&&(s.partsStatus[i]=a.parts[i].map(c=>({id:`${s.id}_part_${o++}`,name:c,damaged:!1})))}),t==="pc"&&a.treasure){let i=!1;for(const c in s.partsStatus){const l=s.partsStatus[c].find(p=>p.name===a.treasure);if(l){l.id=`${s.id}_part_treasure`,i=!0;break}}i||(s.partsStatus.body||(s.partsStatus.body=[]),s.partsStatus.body.push({id:`${s.id}_part_treasure`,name:a.treasure,damaged:!1}))}return s.madnessPoints={},s.statusEffects=[],s.activeBuffs=[],s.isMentallyBroken=!1,s.isDestroyed=!1,s.hasWithdrawn=!1,s.regrets=[],se(s),s.actionValue=s.maxActionValue,s.skills=a.skills||[],s.stackCount=1,s.hasActedThisCount=!1,tt(s),s}function ge(){const e=I.filter(a=>a.skills&&a.skills.includes("åˆæµ"));if(e.length<2)return;const t=new Map;e.forEach(a=>{const s=`${a.position}-${a.area}`;t.has(s)||t.set(s,[]),t.get(s).push(a)});let n=!1;t.forEach(a=>{if(a.length<2)return;const s=a[0];for(let o=1;o<a.length;o++){const i=a[o];s.stackCount+=i.stackCount;const c=I.findIndex(l=>l.id===i.id);c!==-1&&I.splice(c,1)}n=!0}),n&&console.log("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒåˆæµã—ã¾ã—ãŸã€‚")}function tt(e){e.usedManeuvers=new Set,e.turnLimitedManeuvers=new Set,[...e.skills||[],...Object.values(e.partsStatus||{}).flat().map(n=>n.name)].forEach(n=>{const a=_(n);if(!a)return;let s=!1;a.hasOwnProperty("usageLimit")?s=a.usageLimit:["ã‚¸ãƒ£ãƒƒã‚¸","ãƒ€ãƒ¡ãƒ¼ã‚¸","ãƒ©ãƒ”ãƒƒãƒ‰"].includes(a.timing)&&(s=!0),s&&e.turnLimitedManeuvers.add(n)})}function nt(e){e.regrets=[];const t=I.filter(o=>o.type==="pc"&&o.id!==e.id),n=e.treasure||"ãŸã‹ã‚‰ã‚‚ã®";e.regrets.push({id:`treasure_${e.id}`,name:`${n}ã¸ã®ä¾å­˜`,points:3,category:"ãŸã‹ã‚‰ã‚‚ã®"});const a=xe(),s=Object.keys(a).filter(o=>o.startsWith("SI-"));t.forEach(o=>{if(s.length>0){const i=s[Math.floor(Math.random()*s.length)];e.regrets.push({id:`regret_${e.id}_to_${o.id}`,name:`${o.name}ã¸ã®${a[i].name}`,points:3,categoryKey:"SI"});const c=s[Math.floor(Math.random()*s.length)];o.regrets.push({id:`regret_${o.id}_to_${e.id}`,name:`${e.name}ã¸ã®${a[c].name}`,points:3,categoryKey:"SI"})}})}function at(e){Ze=e,console.log("Character Manager initialized.")}function B(e=!1){return I}function P(e){return I.find(t=>t.id===e)}function st(e,t,n){const a=Ht(e,t,n);return a?(t==="pc"&&nt(a),I.push(a),console.log(`${a.name} (${t}) ã‚’æˆ¦å ´ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`),ge(),a):null}function ot(e){const t=P(e);if(t&&t.stackCount>1)return t.stackCount--,console.log(`${t.name}ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒ1æ¸›å°‘ã—ã¾ã—ãŸã€‚`),!0;const n=I.findIndex(a=>a.id===e);if(n!==-1){const a=I[n].name;return I.splice(n,1),console.log(`${a} ã‚’æˆ¦å ´ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚`),!0}return!1}function Se(e,t){const n=I.findIndex(p=>p.id===e);if(n===-1)return;const a=I[n],s=I.filter(p=>p.type===a.type),o=s.findIndex(p=>p.id===e);let i;if(t==="left"){if(o===0)return;i=o-1}else{if(o===s.length-1)return;i=o+1}I.splice(n,1);const c=s[i].id,l=I.findIndex(p=>p.id===c);t==="left"?I.splice(l,0,a):I.splice(l+1,0,a)}function j(e,t){const n=P(e);n?(Object.assign(n,t),(n.isDestroyed||n.hasWithdrawn)&&(n.actionValue=0,n.isDestroyed&&n.partsStatus&&Object.values(n.partsStatus).flat().forEach(a=>a.damaged=!0)),se(n),ge()):console.warn(`æ›´æ–°å¯¾è±¡ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${e}`)}function Ne(e,t,n=1){const a=P(e);if(!a){console.error("æå‚·å¯¾è±¡ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",{characterId:e});return}if(a.category==="ãƒ¬ã‚®ã‚ªãƒ³"){a.stackCount-=n,console.log(`${a.name}ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒ${n}æ¸›å°‘ã—ã¾ã—ãŸã€‚æ®‹ã‚Š: ${a.stackCount}`),a.stackCount<=0&&(a.isDestroyed=!0,a.actionValue=0,console.log(`${a.name}ã¯å®Œå…¨ã«ç ´å£Šã•ã‚Œã¾ã—ãŸã€‚`));return}for(const s in a.partsStatus){const o=a.partsStatus[s].find(i=>i.id===t);if(o){if(o.damaged)return;o.damaged=!0,console.log(`${a.name}ã®[${s}]ã«ã‚ã‚‹ã€Œ${o.name}ã€ãŒæå‚·ã—ã¾ã—ãŸã€‚`),se(a);return}}console.error("æå‚·å¯¾è±¡ã®ãƒ‘ãƒ¼ãƒ„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",{characterId:e,partId:t})}function it(e,t){const n=P(e);if(!n)return;const a=n.regrets.find(i=>i.id===t);a&&a.points<4&&(a.points++,console.log(`${n.name}ã®æœªç·´ã€Œ${a.name}ã€ã«ç‹‚æ°—ç‚¹ãŒ1è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚(ç¾åœ¨: ${a.points})`)),n.regrets&&n.regrets.length>0&&n.regrets.every(i=>i.points>=4)&&(n.isMentallyBroken=!0,console.log(`â˜…â˜…â˜… ${n.name} ã¯ç²¾ç¥å´©å£Šã—ã¾ã—ãŸã€‚ â˜…â˜…â˜…`))}function rt(){I.forEach(e=>{if(e.isDestroyed||e.hasWithdrawn){e.actionValue=0;return}e.actionValue+=e.maxActionValue,e.hasActedThisCount=!1,e.usedManeuvers.clear()}),ge(),console.log("æ–°ã—ã„ã‚¿ãƒ¼ãƒ³ãŒé–‹å§‹ã•ã‚Œã€å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡Œå‹•å€¤ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚")}function ct(e){e.forEach(t=>{const n=P(t.characterId);n&&(n.area=t.targetArea)}),console.log("äºˆç´„ã•ã‚ŒãŸç§»å‹•ã‚’ä¸€æ‹¬ã§é©ç”¨ã—ã¾ã—ãŸã€‚")}function jt(e,t){const n=JSON.parse(JSON.stringify(e));n.id=`char_${et++}`,n.type=t,n.area=n.initialArea||(t==="pc"?"ç…‰ç„":"å¥ˆè½"),n.partsStatus={};let a=0;if(n.parts&&typeof n.parts=="object"&&Object.keys(n.parts).forEach(s=>{Array.isArray(n.parts[s])&&(n.partsStatus[s]=n.parts[s].map(o=>({id:`${n.id}_part_${a++}`,name:o,damaged:!1})))}),t==="pc"&&n.treasure)for(const s in n.partsStatus){const o=n.partsStatus[s].find(i=>i.name===n.treasure);if(o){o.id=`${n.id}_part_treasure`;break}}return n.isMentallyBroken=!1,n.isDestroyed=!1,n.activeBuffs=[],n.hasWithdrawn=!1,n.stackCount=1,n.hasActedThisCount=!1,t==="pc"?nt(n):n.regrets=[],se(n),n.actionValue=n.maxActionValue,tt(n),I.push(n),console.log(`${n.name} (imported ${t}) ã‚’æˆ¦å ´ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`),ge(),n}const qt=Object.freeze(Object.defineProperty({__proto__:null,addCharacterFromObject:jt,addCharacterFromTemplate:st,addMadnessPoint:it,applyQueuedMoves:ct,damagePart:Ne,getCharacterById:P,getCharacters:B,initialize:at,moveCharacter:Se,recalculateMaxActionValue:se,removeCharacter:ot,startNewTurn:rt,updateCharacter:j,version:Xe},Symbol.toStringTag,{value:"Module"})),Vt="1.0.1";function lt(e){const n=pe().maneuverCategories.find(a=>a.name===e);return n?n.slug:"other"}const Ut="1.0.10",Wt=.01,Qt=-9.82,Ft=.2,zt=.3,Gt=.3,Jt=.9;let V,U,q,H,Z,D,re,ye,z,we=null,ee=!1,Ie,de,J,ce;const Kt=[{normal:new k.Vector3(0,1,0),value:1},{normal:new k.Vector3(0,-1,0),value:9},{normal:new k.Vector3(.951,0,.309),value:10},{normal:new k.Vector3(.588,0,-.809),value:2},{normal:new k.Vector3(-.588,0,-.809),value:7},{normal:new k.Vector3(-.951,0,.309),value:4},{normal:new k.Vector3(0,.851,.526),value:8},{normal:new k.Vector3(0,.851,-.526),value:6},{normal:new k.Vector3(0,-.851,.526),value:3},{normal:new k.Vector3(0,-.851,-.526),value:5}];function Yt(e){J=e;const t=e.clientWidth,n=e.clientHeight;V=new k.Scene,U=new k.PerspectiveCamera(30,t/n||1,.1,10),U.position.set(0,.5,0),U.lookAt(0,0,0),q=new k.WebGLRenderer({antialias:!0,alpha:!0}),q.setSize(t,n),q.setPixelRatio(window.devicePixelRatio),q.setClearColor(0,0),e.appendChild(q.domElement),V.add(new k.AmbientLight(16777215,.7));const a=new k.DirectionalLight(16777215,.9);a.position.set(1,2,1),V.add(a),H=new S.World,H.gravity.set(0,Qt,0),re=new S.Material("dice"),ye=new S.Material("ground"),z=new S.Material("wall"),H.addContactMaterial(new S.ContactMaterial(re,ye,{restitution:Gt,friction:Ft})),H.addContactMaterial(new S.ContactMaterial(re,z,{restitution:Jt,friction:zt}));const s=new S.Body({mass:0,material:ye});s.addShape(new S.Plane),s.quaternion.setFromEuler(-Math.PI/2,0,0),H.addBody(s),mt(),Zt(),ft(),window.addEventListener("resize",Le),setTimeout(Le,0)}function Xt(e){!D||ee||(we=e,ee=!0,clearTimeout(de),J.classList.add("is-visible"),Le(),D.position.set(0,.1,0),D.velocity.set(0,2.4,0),D.angularVelocity.set(Math.random()*20+10,Math.random()*20+10,Math.random()*20+10),D.wakeUp(),dt(),de=setTimeout(()=>{ee&&(console.warn("Dice roll timed out. Forcing result."),ut())},2e3))}function Zt(){const e=new At,t=new k.TextureLoader,n="models/",a="Dice_10.fbx",s={map:"Dice_10_Albedo.png",normalMap:"Dice_10_Normal.png",metalnessMap:"Dice_10_Metallic.png",roughnessMap:"Dice_10_Roughness.png",aoMap:"Dice_10_AO.png"},o={};let i=0;const c=Object.keys(s).length;Object.entries(s).forEach(([p,u])=>{t.load(n+u,r=>{r.colorSpace=k.SRGBColorSpace,o[p]=r,i++,i===c&&l()})});function l(){e.load(n+a,p=>{p.traverse(g=>{g.isMesh&&(g.material=new k.MeshStandardMaterial({map:o.map,normalMap:o.normalMap,metalnessMap:o.metalnessMap,roughnessMap:o.roughnessMap,aoMap:o.aoMap,metalness:1,roughness:1,aoMapIntensity:1}))}),an(p);const u=tn(p),r=Wt/u;sn(p,r),V.add(p),Z=p;const{vertices:m,indices:d}=nn(p),h=new S.Trimesh(m,d);D=new S.Body({mass:.005,material:re,shape:h,angularDamping:0,allowSleep:!0}),H.addBody(D)})}}function dt(){clearTimeout(Ie),D.sleepState===S.Body.SLEEPING?(clearTimeout(de),setTimeout(ut,200)):Ie=setTimeout(dt,100)}function ut(){if(!ee)return;ee=!1,clearTimeout(de),clearTimeout(Ie);const e=en();we&&we(e),setTimeout(()=>{J.classList.remove("is-visible")},1500)}function en(){let e=-2,t=-1;const n=new k.Vector3(0,1,0);return Kt.forEach(a=>{const o=a.normal.clone().applyQuaternion(Z.quaternion).dot(n);o>e&&(e=o,t=a.value)}),t}const be=[],$e=[];function mt(){if(be.forEach(r=>H.removeBody(r)),be.length=0,$e.forEach(r=>V.remove(r)),$e.length=0,!ce)return;const e=ce.width*.9,t=ce.height*.9,n=new k.PlaneGeometry(e,t),a=new k.MeshStandardMaterial({color:3355443,transparent:!0,opacity:.3}),s=new k.Mesh(n,a);s.rotation.x=-Math.PI/2,s.position.y=.001,V.add(s),$e.push(s);const o=.5,i=.1,c=new S.Box(new S.Vec3(e/2,o/2,i/2)),l=new S.Box(new S.Vec3(i/2,o/2,t/2)),p=[new S.Vec3(0,o/2,t/2),new S.Vec3(0,o/2,-t/2),new S.Vec3(e/2,o/2,0),new S.Vec3(-e/2,o/2,0)];[new S.Body({mass:0,shape:c,position:p[0],material:z}),new S.Body({mass:0,shape:c,position:p[1],material:z}),new S.Body({mass:0,shape:l,position:p[2],material:z}),new S.Body({mass:0,shape:l,position:p[3],material:z})].forEach(r=>{H.addBody(r),be.push(r)})}function Le(){if(!J)return;const e=J.clientWidth,t=J.clientHeight;if(e===0||t===0)return;const n=k.MathUtils.degToRad(U.fov),a=2*Math.tan(n/2)*.5;ce={width:a*(e/t),height:a},mt(),U.aspect=e/t,U.updateProjectionMatrix(),q.setSize(e,t)}let He=performance.now();function ft(){requestAnimationFrame(ft);const e=performance.now(),t=(e-He)/1e3;H&&H.step(1/60,t,3),He=e,Z&&D&&(Z.position.copy(D.position),Z.quaternion.copy(D.quaternion)),q&&V&&U&&q.render(V,U)}function tn(e){const t=new k.Vector3;let n=0;return e.traverse(a=>{if(a.isMesh&&a.geometry?.attributes?.position){const s=a.geometry.attributes.position;for(let o=0;o<s.count;o++){t.fromBufferAttribute(s,o);const i=t.length();i>n&&(n=i)}}}),n}function nn(e){const t=[],n=[];let a=0;return e.traverse(s=>{if(s.isMesh&&s.geometry?.attributes?.position){const o=s.geometry,i=o.attributes.position;for(let c=0;c<i.count;c++)t.push(i.getX(c),i.getY(c),i.getZ(c));if(o.index){const c=o.index.array;for(let l=0;l<c.length;l++)n.push(a+c[l])}else for(let c=0;c<i.count;c++)n.push(a+c);a+=i.count}}),{vertices:t,indices:n}}function an(e){const t=new k.Box3().setFromObject(e),n=new k.Vector3;t.getCenter(n),e.traverse(a=>{a.isMesh&&a.geometry&&a.geometry.translate(-n.x,-n.y,-n.z)}),e.position.set(0,0,0)}function sn(e,t){const n=new k.Matrix4().makeScale(t,t,t);e.traverse(a=>{a.isMesh&&a.geometry&&a.geometry.applyMatrix4(n)}),e.scale.set(1,1,1)}const on="1.2.13";let pt={},gt={},ht={},vt={},Ae=()=>{},je=!1;function rn(e){if(pt=e.hintMasterData,gt=e.regretMasterData,ht=e.takaramonoMasterData,vt=e.memoryFragmentsData,Ae=e.addLog,!je){const t=document.getElementById("dice3d-container");t&&(Yt(t),je=!0)}}function cn(){R({title:"ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«",items:[{label:"ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«",isTitle:!0},{label:"NA  æ”»æ’ƒåˆ¤å®š",onClick:()=>x({command:"NA",showToast:!0})},{label:"NC  åˆ¤å®š",onClick:()=>x({command:"NC",showToast:!0})},{label:"NM  å§‰å¦¹ã¸ã®æœªç·´",onClick:()=>x({command:"NM",showToast:!0})},{label:"NME æ•µã¸ã®æœªç·´",onClick:()=>x({command:"NME",showToast:!0})},{label:"NMN ä¸­ç«‹è€…ã¸ã®æœªç·´",onClick:()=>x({command:"NMN",showToast:!0})},{label:"NT  ãŸã‹ã‚‰ã‚‚ã®è¡¨",onClick:()=>x({command:"NT",showToast:!0})},{label:"NK  è¨˜æ†¶ã®ã‚«ã‚±ãƒ©",onClick:()=>x({command:"NK",showToast:!0})},{label:"NH  æš—ç¤ºè¡¨",onClick:()=>x({command:"NH",showToast:!0})},{label:"1D10",onClick:()=>x({command:"1d10",showToast:!0})},{label:"1D100",onClick:()=>x({command:"1d100",showToast:!0})},{label:"ç›´æ¥å…¥åŠ›",onClick:()=>{R({title:"ğŸ² ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«",bodyHtml:`
                    <p style="text-align: center; margin-bottom: 15px;">ãƒ€ã‚¤ã‚¹ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    <input type="text" id="diceCommandInput" value="3d6" 
                           class="modal-input-text" autofocus
                           inputmode="latin" style="ime-mode: disabled;">
                `,footerHtml:'<button id="executeDiceRollBtn" class="welcome-modal-close-btn">ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«</button>',onRender:(a,s)=>{const o=a.querySelector("#diceCommandInput"),i=a.querySelector("#executeDiceRollBtn"),c=()=>{o.value&&x({command:o.value,showToast:!0}),s()};i.onclick=c,o.onkeydown=l=>{l.key==="Enter"&&c()},o.select()}})}}]})}function x(e){const t=typeof e=="string"?e:e.command,n=typeof e=="object"&&e.callback?e.callback:null;if(!t)return;const a=t.toLowerCase().replace(/\s/g,"");let s=`ã€Œ${t}ã€ã¯ç„¡åŠ¹ãªå…¥åŠ›ã§ã™ã€‚`,o=null,i=null;if(a==="nm")s=Ce("SI-","å§‰å¦¹ã¸ã®æœªç·´è¡¨");else if(a==="nme")s=Ce("EN-","æ•µã¸ã®æœªç·´è¡¨");else if(a==="nmn")s=Ce("NP-","ä¸­ç«‹è€…ã¸ã®æœªç·´è¡¨");else if(a==="nt"){const c=Math.floor(Math.random()*10)+1,l=ht[c];s=l?`ğŸ² ãŸã‹ã‚‰ã‚‚ã®è¡¨(${c}) ï¼ ã€${l.name}ã€‘ ${l.description}`:`ãŸã‹ã‚‰ã‚‚ã®ãƒ‡ãƒ¼ã‚¿[${c}]ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`}else if(a==="nk"){const c=Math.floor(Math.random()*100)+1,l=vt[c];s=l?`ğŸ² è¨˜æ†¶ã®ã‚«ã‚±ãƒ©è¡¨(${c}) ï¼ ã€${l.name}ã€‘ ${l.description}`:`è¨˜æ†¶ã®ã‚«ã‚±ãƒ©ãƒ‡ãƒ¼ã‚¿[${c}]ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`}else if(a==="nh"){const c=Math.floor(Math.random()*10)+1,l=pt[c];s=l?`ğŸ² æš—ç¤ºè¡¨(${c}) ï¼ ã€${l.name}ã€‘ ${l.description}`:`æš—ç¤ºãƒ‡ãƒ¼ã‚¿[${c}]ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`}else{const c=/^(\d*)?(nc|na)([+-]\d+)?$/,l=a.match(c);if(l){const[,p,u,r]=l,m=p?parseInt(p,10):1,d=r?parseInt(r,10):0,h=Array.from({length:m},()=>Math.floor(Math.random()*10)+1),g=Math.max(...h),f=Math.min(...h),v=g+d;let C=d>0?`+${d}`:d<0?`${d}`:"",b="",y="",M="#dc3545";u==="nc"?(v>=11?(b="å¤§æˆåŠŸ",M="#007bff"):f+d<=1?(b="å¤§å¤±æ•—",y="ï¼ ä½¿ç”¨ãƒ‘ãƒ¼ãƒ„å…¨æ"):v>=6?(b="æˆåŠŸ",M="#007bff"):b="å¤±æ•—",o=b):u==="na"&&(v>=11?(b="å¤§æˆåŠŸ",y=`ï¼ æ”»æ’ƒå´ä»»æ„ï¼ˆè¿½åŠ ãƒ€ãƒ¡ãƒ¼ã‚¸${v-10}ï¼‰`,M="#007bff",i="ä»»æ„"):v>=10?(b="æˆåŠŸ",y="ï¼ é ­ï¼ˆãªã‘ã‚Œã°æ”»æ’ƒå´ä»»æ„ï¼‰",M="#007bff",i="é ­"):v>=9?(b="æˆåŠŸ",y="ï¼ è…•ï¼ˆãªã‘ã‚Œã°æ”»æ’ƒå´ä»»æ„ï¼‰",M="#007bff",i="è…•"):v>=8?(b="æˆåŠŸ",y="ï¼ èƒ´ï¼ˆãªã‘ã‚Œã°æ”»æ’ƒå´ä»»æ„ï¼‰",M="#007bff",i="èƒ´"):v>=7?(b="æˆåŠŸ",y="ï¼ è„šï¼ˆãªã‘ã‚Œã°æ”»æ’ƒå´ä»»æ„ï¼‰",M="#007bff",i="è„š"):v>=6?(b="æˆåŠŸ",y="ï¼ é˜²å¾¡å´ä»»æ„",M="#007bff",i="ä»»æ„"):v>=2?b="å¤±æ•—":(b="å¤§å¤±æ•—",y="ï¼ å‘³æ–¹ã‹è‡ªèº«ã«å‘½ä¸­"),o=b);const w=`[${h.join(",")}]`;s=`<span style="color: ${M};">ğŸ² ${t.toUpperCase()} ï¼ ${g}${w}${C} ï¼ ${v} ï¼ ${b} ${y}</span>`,Ae(s),Xt(L=>{const F=`ğŸ² 1D10 ï¼ ${L}`;ae(F,4e3),n&&n(o,i,s)});return}else{const p=/^(\d*)d(\d+)([+-]\d+)?$/,u=a.match(p);if(u){const r=u[1]?parseInt(u[1],10):1,m=parseInt(u[2],10),d=u[3]?parseInt(u[3],10):0;if(r>0&&m>0&&r<=100){const h=Array.from({length:r},()=>Math.floor(Math.random()*m)+1),g=h.reduce((C,b)=>C+b,0),f=g+d;let v=d>0?`+${d}`:d<0?`${d}`:"";s=`ğŸ² ${t.toUpperCase()} ï¼ ${g}[${h.join(",")}]${v} ï¼ ${f}`}else s=`ã€Œ${t}ã€ã®ãƒ€ã‚¤ã‚¹ã®æ•°ã‚„ç¨®é¡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚`}}}Ae(s),(typeof e=="object"&&e.showToast||typeof e=="string")&&ae(s,4e3),n&&n(o,i,s)}function Ce(e,t){const n=gt;if(!n||Object.keys(n).length===0)return"æœªç·´ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";const a=Object.keys(n).filter(i=>i.startsWith(e));if(a.length===0)return`${t} ã«è©²å½“ã™ã‚‹æœªç·´ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;const s=a[Math.floor(Math.random()*a.length)],o=n[s];return o?`ğŸ² ${t}(${s}) ï¼ ã€${o.name}ã€‘[ç™ºç‹‚:${o.madnessName}] ${o.madnessEffect}`:`æœªç·´ãƒ‡ãƒ¼ã‚¿[${s}]ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`}const ln="1.1.17";function dn(e){if(!e)return console.error("[Converter] å¤‰æ›å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿(sourceData)ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚"),null;try{const t={};t.name=e.Name||e.pc_name||e.data_title||"åç§°æœªè¨­å®š",t.description=`${e.data_title||""} | ${e.Position_Name||""}ï¼ˆ${e.MCLS_Name||""}ãƒ»${e.SCLS_Name||""}ï¼‰`,t.img="images/noimage.png",t.category="ãƒ‰ãƒ¼ãƒ«",t.initialArea="ç…‰ç„",t.baseActionValue=6,t.position=e.Position_Name||"",t.mainClass=e.MCLS_Name||"",t.subClass=e.SCLS_Name||"";const n={1:"æ­¦è£…",2:"å¤‰ç•°",3:"æ”¹é€ "};t.enhancementValue={bonus:n[e.ST_Bonus]||"æ­¦è£…"},t.skills=[],t.parts={head:[],arms:[],torso:[],legs:[],body:[]};const a={4:"head",5:"arms",6:"torso",7:"legs"},s={1:"ã‚ªãƒ¼ãƒˆ",2:"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³",3:"ã‚¸ãƒ£ãƒƒã‚¸",4:"ãƒ€ãƒ¡ãƒ¼ã‚¸",5:"ãƒ©ãƒ”ãƒƒãƒ‰"},o={1:"æ”»æ’ƒ",2:"æ”»æ’ƒ",3:"è¡Œå‹•å€¤",4:"è£œåŠ©",5:"å¦¨å®³",6:"é˜²å¾¡",7:"ç§»å‹•"},i=e.Power_name?.length||0;let c=null,l=-1;l=e.Power_shozoku?.findIndex(r=>r&&r.includes("ãŸã‹ã‚‰")),l>-1?c=e.Power_name[l]:(l=e.Power_memo?.findIndex((r,m)=>{const d=e.Power_hantei[m];return!["1","2","3"].includes(d)&&r&&r.includes("ãŸã‹ã‚‰ã‚‚ã®")}),l>-1&&(c=e.Power_name[l])),t.treasure=c;for(let r=0;r<i;r++){const m=e.Power_name[r];if(!m||m===c)continue;const d=e.Power_hantei[r],h=a[d];if(!_(m)){const g=e.Power_Type[r],f={name:m,timing:s[e.Power_timing[r]]||"ã‚ªãƒ¼ãƒˆ",cost:e.Power_cost[r]||"ãªã—",range:e.Power_range[r]||"è‡ªèº«",effect:e.Power_memo[r]||"åŠ¹æœä¸æ˜",description:e.Power_memo[r]||"åŠ¹æœä¸æ˜",category:["1","2","3"].includes(d)?"ã‚¹ã‚­ãƒ«":o[g]||"å¼·åŒ–ãƒ‘ãƒ¼ãƒ„"};Ot(f)}["1","2","3"].includes(d)?t.skills.push(m):h?t.parts[h].push(m):t.skills.push(m)}if(c){const r=e.Power_hantei[l],m=a[r];m?t.parts[m].push(c):t.parts.body.push(c)}t.regrets=[];const p=e.roice_name?.length||0;for(let r=0;r<p;r++){const m=e.roice_name[r],d=e.roice_pos[r];if(m&&d){const h={name:`${m}ã¸ã®${d}`,points:parseInt(e.roice_damage[r],10)||3};m==="ãŸã‹ã‚‰ã‚‚ã®"&&t.treasure?(h.name=`${t.treasure}ã¸ã®${d}`,h.category="ãŸã‹ã‚‰ã‚‚ã®"):h.categoryKey="SI",t.regrets.push(h)}}t.memories=[];const u=e.kakera_name?.length||0;for(let r=0;r<u;r++){const m=e.kakera_name[r],d=e.kakera_memo[r];m&&t.memories.push({name:m,memo:d})}return t.personalData={title:e.data_title||"",tags:e.pc_tags||"",race:e.shuzoku||"ãƒ‰ãƒ¼ãƒ«",age:e.age||"",sex:e.sex||"",height:e.pc_height||"",weight:e.pc_weight||"",karma:e.pc_carma||"",hairColor:e.color_hair||"",eyeColor:e.color_eye||"",skinColor:e.color_skin||"",memo:e.pc_making_memo||""},t}catch(t){return console.error("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆã®å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:",t),null}}const un="1.1.3";function mn(){const e=document.querySelectorAll('input[name="theme-switcher"]'),t=localStorage.getItem("theme")||"system";Ee(t),document.querySelector(`input[name="theme-switcher"][value="${t}"]`).checked=!0,e.forEach(a=>{a.addEventListener("change",s=>{const o=s.target.value;Ee(o),localStorage.setItem("theme",o),console.log(`Theme changed to: ${o}`)})}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{(localStorage.getItem("theme")||"system")==="system"&&Ee("system")}),console.log("Settings Manager initialized.")}function Ee(e){e==="system"?document.documentElement.removeAttribute("data-theme"):document.documentElement.setAttribute("data-theme",e)}function fn(){let e=0;for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t),a=localStorage.getItem(n);if(n&&a){const s=(n.length+a.length)*2;e+=s}}return e}function pn(){localStorage.removeItem("userLocalImages"),console.log("Local image cache cleared.")}const gn="1.10.36";let ue=null;const K=["å¥ˆè½","åœ°ç„","ç…‰ç„","èŠ±åœ’","æ¥½åœ’"];let oe=null,Y="å®£è¨€";const yt=e=>{const t=document.getElementById("maneuverMenu");t&&!t.contains(e.target)&&ue&&!ue.contains(e.target)&&me()};function qe(e,t){me(),ue=t;const n=document.getElementById("maneuverMenu");n.innerHTML="";const a=[{id:"å®£è¨€",label:"å®£è¨€"},{id:"ã‚¹ã‚­ãƒ«",label:"ã‚¹ã‚­ãƒ«"},{id:"ãƒ‘ãƒ¼ãƒ„",label:"ãƒ‘ãƒ¼ãƒ„"},{id:"ãƒãƒ•",label:"ãƒãƒ•"},{id:"ç§»å‹•",label:"ç§»å‹•"},{id:"æ”»æ’ƒ",label:"æ”»æ’ƒ"},{id:"æ”¯æ´",label:"æ”¯æ´"},{id:"å¦¨å®³",label:"å¦¨å®³"},{id:"ã™ã¹ã¦",label:"ã™ã¹ã¦"}],s=document.createElement("div");s.className="maneuver-menu-header",s.innerHTML=`
        <span class="header-icon" id="menuHeaderIcon">ğŸªª</span>
        <span class="header-title">${e.name}</span>
        <button class="header-close-btn">&times;</button>
    `,n.appendChild(s),s.querySelector("#menuHeaderIcon").onclick=()=>Pe(e),s.querySelector(".header-close-btn").onclick=me;const o=document.createElement("div");o.className="maneuver-menu-filter-bar",a.forEach(u=>{const r=document.createElement("button");r.className="filter-btn",r.dataset.filterId=u.id,r.textContent=u.label,u.id===Y&&r.classList.add("is-active"),r.onclick=()=>{Y=u.id,o.querySelectorAll(".filter-btn").forEach(m=>m.classList.remove("is-active")),r.classList.add("is-active"),c()},o.appendChild(r)}),n.appendChild(o);const i=document.createElement("div");i.className="maneuver-menu-list-container",n.appendChild(i);const c=()=>{i.innerHTML="";const u=bt(e),r=hn(u,Y,e);if(Y!=="ãƒ‘ãƒ¼ãƒ„"){const m=pe().maneuverCategories.map(d=>d.name);r.sort((d,h)=>{const g=d.data.category==="è¡Œå‹•å€¤å¢—åŠ "?"è¡Œå‹•å€¤":d.data.category,f=h.data.category==="è¡Œå‹•å€¤å¢—åŠ "?"è¡Œå‹•å€¤":h.data.category;let v=m.indexOf(g);v===-1&&(v=m.length);let C=m.indexOf(f);return C===-1&&(C=m.length),v!==C?v-C:d.data.name.localeCompare(h.data.name)})}Y==="ãƒ‘ãƒ¼ãƒ„"?l(r,e):p(r,e)},l=(u,r)=>{["é ­","è…•","èƒ´","è„š","ä»–"].forEach(d=>{const h=u.filter(g=>bn(g.data,r).includes(d));if(h.length>0){const g=document.createElement("div");g.className="maneuver-group",g.innerHTML=`<div class="group-header">${d}</div>`,h.forEach(f=>g.appendChild(Ve(f,r))),i.appendChild(g)}})},p=(u,r)=>{if(u.length===0){i.innerHTML='<div class="maneuver-item is-empty">å¯¾è±¡ã®ãƒãƒ‹ãƒ¥ãƒ¼ãƒã¯ã‚ã‚Šã¾ã›ã‚“</div>';return}u.forEach(m=>i.appendChild(Ve(m,r)))};c(),n.classList.add("is-visible"),setTimeout(()=>{document.addEventListener("click",yt)},0)}function Ve(e,t){const n=e.data,a=document.createElement("div");a.className="maneuver-item-new";const s=document.createElement("div");s.className="item-category-col";const o=n.category||"ãã®ä»–",i=`category-color-${lt(o)}`;a.classList.add(i.replace("bg-","")),s.classList.add(i),s.innerHTML=`<span>${o}</span>`;const c=document.createElement("div");if(c.className="item-icon-col item-passive-icon-col",e.isActiveBuff||n.timing==="ã‚ªãƒ¼ãƒˆ"){let u=!1;if(e.isActiveBuff)u=!0;else{const r=e.isDamaged;["ãƒ¬ã‚®ã‚ªãƒ³","ãƒ›ãƒ©ãƒ¼","åˆæµ"].includes(n.name)?u=!0:n.effects&&n.effects.length>0&&(n.effects.some(h=>h.ref==="MODIFY_MAX_ACTION_VALUE_ON_DAMAGE")?r&&(u=!0):n.effects.some(g=>g.ref==="APPLY_BUFF"||g.ref==="REDUCE_MOVE_COST")&&!r&&(u=!0))}u&&(c.innerHTML='<span class="maneuver-icon">ğŸ’¡</span>')}const l=document.createElement("div");if(l.className="item-icon-col item-status-icon-col",e.isActiveBuff)l.innerHTML='<input type="checkbox" class="maneuver-checkbox" checked disabled>';else if(t.turnLimitedManeuvers.has(n.name)){const u=t.usedManeuvers.has(n.name);l.innerHTML=`<input type="checkbox" class="maneuver-checkbox" ${u?"checked":""} disabled>`}const p=document.createElement("div");return p.className="item-right-col",p.innerHTML=`
        <div class="item-row-1">
            <span class="item-name">ã€${n.name}ã€‘</span>
            <span class="item-stats">ã€Š${n.timing}/${n.cost}/${n.range}ã€‹</span>
        </div>
        <div class="item-row-2">${n.description||""}</div>
    `,a.appendChild(s),a.appendChild(c),a.appendChild(l),a.appendChild(p),a.addEventListener("mouseenter",()=>Et(document.getElementById("maneuverMenu").getBoundingClientRect(),a.getBoundingClientRect(),t,e)),a.addEventListener("mouseleave",()=>te()),e.isUsable?a.onclick=async u=>{if(u.stopPropagation(),me(),n.name==="ä»»æ„"){const m=`<div class="action-cost-form"><div class="action-cost-selector">${[1,2,3,4,5].map(h=>`<label><input type="radio" name="action-cost" value="${h}" ${h===1?"checked":""}> <span>${h}</span></label>`).join("")}</div></div>`;R({title:"æ¶ˆè²»ã™ã‚‹è¡Œå‹•å€¤ã‚’é¸æŠ",bodyHtml:m,footerHtml:'<button id="applyActionCostBtn" class="welcome-modal-close-btn">é©ç”¨</button>',onRender:(h,g)=>{h.querySelector("#applyActionCostBtn").onclick=()=>{const f=h.querySelector('input[name="action-cost"]:checked').value,v={...n,cost:String(parseInt(f,10))};W(t,v),g()}}});return}if(n.timing==="ã‚¸ãƒ£ãƒƒã‚¸"&&n.range!=="è‡ªèº«"){const m=Mn(t,n);if(m.length===0){E("æ”¯æ´/å¦¨å®³ã®å¯¾è±¡ã¨ãªã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");return}const d=m.map(h=>({label:`${h.performer.name}: ã€${h.sourceManeuver.name}ã€‘${h.target?` â†’ ${h.target.name}`:""}`,onClick:()=>W(t,n,null,h)}));R({title:`ã€${n.name}ã€‘ã®å¯¾è±¡ã‚’é¸æŠ`,items:d});return}if(n.tags.includes("ç§»å‹•")){yn(t,n);return}if(n.tags.includes("æ”»æ’ƒ")){const m=await kn(t,n,yt);m&&W(t,n,m);return}W(t,n)}:(a.classList.add("is-masked"),e.isDamaged&&a.classList.add("is-damaged")),a}function hn(e,t,n){let a=[];const s=["å¾…æ©Ÿ","ä»»æ„"];switch(t){case"å®£è¨€":a=e.filter(o=>o.isUsable&&o.data.timing!=="ã‚ªãƒ¼ãƒˆ");break;case"ã‚¹ã‚­ãƒ«":a=e.filter(o=>o.sourceType==="skill"&&!s.includes(o.data.name));break;case"ãƒ‘ãƒ¼ãƒ„":a=e.filter(o=>o.sourceType==="part"&&!s.includes(o.data.name));break;case"ç§»å‹•":a=e.filter(o=>o.data.tags.includes("ç§»å‹•")&&!s.includes(o.data.name));break;case"æ”»æ’ƒ":a=e.filter(o=>o.data.tags.includes("æ”»æ’ƒ")&&!s.includes(o.data.name));break;case"æ”¯æ´":a=e.filter(o=>(o.data.tags.includes("æ”¯æ´")||o.data.tags.includes("å¼·åŒ–"))&&!s.includes(o.data.name));break;case"å¦¨å®³":a=e.filter(o=>(o.data.tags.includes("å¦¨å®³")||o.data.tags.includes("è„†å¼±"))&&!s.includes(o.data.name));break;case"ãƒãƒ•":case"ã™ã¹ã¦":default:a=[...e];break}return(t==="ãƒãƒ•"||t==="ã™ã¹ã¦")&&n.activeBuffs&&n.activeBuffs.length>0&&n.activeBuffs.forEach(o=>{const i=_(o.source);if(i){const c=a.findIndex(l=>l.data.name===o.source&&!l.isActiveBuff);c>-1&&a.splice(c,1),a.some(l=>l.isActiveBuff&&l.sourceName===o.source)||a.push({data:i,sourceType:"active_buff",sourceName:o.source,isActiveBuff:!0,isUsable:!1})}}),t==="ãƒãƒ•"?a.filter(o=>o.isActiveBuff||o.data.timing==="ã‚ªãƒ¼ãƒˆ"&&o.data.effects&&o.data.effects.some(i=>i.ref==="APPLY_BUFF"||i.ref==="REDUCE_MOVE_COST")):a}function Pe(e){const t=e.category==="ãƒ‰ãƒ¼ãƒ«",n=pe(),a=n.classes;let s={A:0,M:0,R:0};if(t){const u=Object.keys(a).find(g=>a[g].name===e.mainClass),r=Object.keys(a).find(g=>a[g].name===e.subClass),m=u?a[u]:null,d=r?a[r]:null;m&&(s.A+=m.A||0,s.M+=m.M||0,s.R+=m.R||0),d&&(s.A+=d.A||0,s.M+=d.M||0,s.R+=d.R||0);const h=e.enhancementValue.bonus;h==="æ­¦è£…"&&(s.A+=1),h==="å¤‰ç•°"&&(s.M+=1),h==="æ”¹é€ "&&(s.R+=1)}const l=(t?["ç…‰ç„","èŠ±åœ’","æ¥½åœ’"]:["å¥ˆè½","åœ°ç„","ç…‰ç„","èŠ±åœ’","æ¥½åœ’"]).map(u=>`<option value="${u}" ${e.area===u?"selected":""}>${u}</option>`).join(""),p=`
    <div class="sheet-grid-container">
        <div class="sheet-img">
            <button class="sheet-edit-image-btn">âœï¸ ç”»åƒã®å¤‰æ›´</button>
            <img src="${e.img}" alt="${e.name}">
        </div>
        <div class="sheet-header">
            ${e.sheetId?`
            <div class="sheet-charasheet-link">
                <button class="sheet-link-btn" data-sheet-id="${e.sheetId}">ä¿ç®¡æ‰€ã§è¦‹ã‚‹ ID: ${e.sheetId}</button> 
            </div>
            `:""}
            ${e.personalData&&e.personalData.title?`
                <div class="sheet-char-title">${e.personalData.title}</div>
            `:""}
        </div>
        <div class="sheet-basic-info">
            <div class="sheet-input-group">
                <label>åå‰</label>
                <input type="text" value="${e.name}" disabled>
            </div>
            ${t?`
            <div class="sheet-input-group">
                <label>äº«å¹´</label>
                <input type="text" value="${e.personalData?.age||"æœªè¨­å®š"}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>æš—ç¤º</label>
                <input type="text" value="${e.personalData?.karma||"æœªè¨­å®š"}" disabled>
            </div>`:""}
             <div class="sheet-input-group">
                <label>æœ€å¤§è¡Œå‹•å€¤</label>
                <input type="text" value="${e.maxActionValue}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>åˆæœŸé…ç½®</label>
                <select id="areaSelector" class="sheet-select">${l}</select>
            </div>
        </div>
        <div class="sheet-section sheet-enhancement">
            <h4>åŸºæœ¬æƒ…å ±</h4>
            <div class="sheet-input-group">
                <label>ã‚«ãƒ†ã‚´ãƒª</label> <input type="text" value="${e.category}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>ãƒã‚¸ã‚·ãƒ§ãƒ³</label> <input type="text" value="${e.position}" disabled>
            </div>
            ${t?`
            <div class="sheet-input-group">
                <label>ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹</label> <input type="text" value="${e.mainClass}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>ã‚µãƒ–ã‚¯ãƒ©ã‚¹</label> <input type="text" value="${e.subClass}" disabled>
            </div>
            <h4>å¼·åŒ–ç‚¹</h4>
             <div class="sheet-input-group">
                <label>ãƒœãƒ¼ãƒŠã‚¹</label> <input type="text" value="${e.enhancementValue.bonus}" disabled>
            </div>
            <div class="sheet-input-group">
                <label>æ­¦è£…</label> <input type="text" value="${s.A}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>å¤‰ç•°</label> <input type="text" value="${s.M}" disabled>
            </div>
             <div class="sheet-input-group">
                <label>æ”¹é€ </label> <input type="text" value="${s.R}" disabled>
            </div>`:""}
        </div>
        ${e.personalData?`
        <div class="sheet-section sheet-personal-data">
            <h4>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿</h4>
            <div class="sheet-input-group"><label>ã‚¿ã‚°</label><input type="text" value="${e.personalData.tags}" disabled></div>
            <div class="sheet-input-group"><label>ç¨®æ—</label><input type="text" value="${e.personalData.race}" disabled></div>
            <div class="sheet-input-group"><label>èº«é•·</label><input type="text" value="${e.personalData.height}" disabled></div>
            <div class="sheet-input-group"><label>é«ªã®è‰²</label><input type="text" value="${e.personalData.hairColor}" disabled></div>
            <div class="sheet-input-group"><label>ç³ã®è‰²</label><input type="text" value="${e.personalData.eyeColor}" disabled></div>
            <div class="sheet-input-group"><label>è‚Œã®è‰²</label><input type="text" value="${e.personalData.skinColor}" disabled></div>
            <h4>ãã®ä»–ãƒ¡ãƒ¢</h4>
            <textarea class="sheet-textarea" rows="8" disabled>${e.personalData.memo}</textarea>
        </div>
        `:""}
        ${t?`
        <div class="sheet-section sheet-hint">
            <h4>æš—ç¤º</h4>
            ${e.hint?`<p><b>ã€${e.hint.name}ã€‘</b><br>${e.hint.description}</p>`:"<p>ï¼ˆæš—ç¤ºã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰</p>"}
        </div>
        <div class="sheet-section sheet-memory">
            <h4>è¨˜æ†¶ã®ã‚«ã‚±ãƒ©</h4>
            ${e.memories&&e.memories.length>0?e.memories.map(u=>`<p><b>ã€${u.name}ã€‘</b><br>${u.memo}</p>`).join(""):"<p>ï¼ˆè¨˜æ†¶ã®ã‚«ã‚±ãƒ©ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>"}
        </div>
        <div class="sheet-section sheet-regrets">
            <h4>æœªç·´</h4>
            ${e.regrets&&e.regrets.length>0?e.regrets.map(u=>{const r=u.points||0,m="â—".repeat(r)+"â—‹".repeat(4-r),d=xe(),h=Object.values(d).find(f=>u.name.includes(f.name)),g=h?`ï¼š${h.madnessName}ï¼š${h.madnessEffect}`:"";return`<p>${u.name}ï¼š${r}ç‚¹ ${m}${g}</p>`}).join(""):"<p>ï¼ˆæœªç·´ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>"}
        </div>`:""}
        <div class="sheet-section sheet-skills">
            <h4>ã‚¹ã‚­ãƒ«</h4>
            ${e.skills.map(u=>{const r=_(u);if(!r)return`<div class="part-list-item">${u}</div>`;let m="ã‚¹ã‚­ãƒ«";if(r.id&&t){const d=r.id,h=d.substring(0,2),g=d.endsWith("-SP"),f=e.mainClass===e.subClass,v=Object.keys(n.positions).find(y=>n.positions[y].name===e.position),C=Object.keys(a).find(y=>a[y].name===e.mainClass),b=Object.keys(a).find(y=>a[y].name===e.subClass);g&&h===C?m="ç‰¹åŒ–ã‚¹ã‚­ãƒ«":h===v?m="ãƒã‚¸ã‚·ãƒ§ãƒ³":h===C?m=f?"ã‚¯ãƒ©ã‚¹":"ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹":h===b&&(m=f?"ã‚¯ãƒ©ã‚¹":"ã‚µãƒ–ã‚¯ãƒ©ã‚¹")}return`<div class="part-list-item"><span class="type">[${m}]</span> <b>ã€${u}ã€‘</b>ã€Š${r.timing}/${r.cost}/${r.range}ã€‹ï¼š${r.description||r.effect}</div>`}).join("")}
        </div>
        <div class="sheet-section sheet-parts">
            <h4>ãƒ‘ãƒ¼ãƒ„</h4>
            <div class="sheet-parts-grid">
                ${["head","arms","torso","legs","body"].map(u=>{if(!e.partsStatus[u]||e.partsStatus[u].length===0)return"";const r={head:"é ­",arms:"è…•",torso:"èƒ´",legs:"è„š",body:"ä½“"}[u],m=e.partsStatus[u].map(d=>{const h=d.id.includes("_treasure"),g=h?xt()["TR-00"]:_(d.name),f=g?.id?.startsWith("BP-"),v=h?"ãŸã‹ã‚‰ã‚‚ã®":f?"åŸºæœ¬":"å¼·åŒ–";if(!g)return`<div class="part-list-item"><span class="type">[${v}]</span> <b>${d.name}</b></div>`;const C=h?g.effect:g.description||g.effect;return`<div class="part-list-item"><span class="type">[${v}]</span> <b>ã€${d.name}ã€‘</b>ã€Š${g.timing}ï¼${g.cost}ï¼${g.range}ã€‹ï¼š${C}</div>`}).join("");return`<div><h4>ã€ˆ${r}ã€‰</h4>${m}</div>`}).join("")}
            </div>
        </div>
    </div>
    `;R({title:"ãƒã‚¯ãƒ­ãƒ‹ã‚« äººå½¢è¨­è¨ˆå›³",bodyHtml:p,onRender:(u,r)=>{u.querySelector(".modal-content").classList.add("sheet-modal-content"),u.querySelector(".modal-body").classList.add("sheet-modal-body");const m=u.querySelector(".sheet-edit-image-btn");m&&(m.onclick=()=>{Te(e,r)});const d=u.querySelector("#areaSelector");d&&(d.onchange=g=>{const f=g.target.value;j(e.id,{area:f}),T(),Q()});const h=u.querySelector(".sheet-link-btn");h&&(h.onclick=()=>{const g=h.dataset.sheetId;g&&window.open(`https://charasheet.vampire-blood.net/${g}`,"_blank")})}})}function vn(e){const t=document.getElementById("undeadListModal"),n=t.querySelector(".modal-body");n.innerHTML="";const a=document.createElement("div");a.className="import-container";const s=document.createElement("button");s.className="import-btn",s.textContent="ä¿ç®¡æ‰€ã‹ã‚‰èª­è¾¼ã¿",s.onclick=()=>{t.classList.remove("is-visible"),$n(e,qt)},a.appendChild(s),n.appendChild(a);const o=document.createElement("div");o.className="undead-filter-container",["ã™ã¹ã¦",...["ãƒ‰ãƒ¼ãƒ«","ãƒ¬ã‚®ã‚ªãƒ³","ãƒ›ãƒ©ãƒ¼","ã‚µãƒ´ã‚¡ãƒ³ãƒˆ"]].forEach(r=>{const m=document.createElement("button");m.className="filter-btn",m.textContent=r,m.dataset.category=r,r==="ã™ã¹ã¦"&&m.classList.add("active"),o.appendChild(m)}),n.appendChild(o);const l=document.createElement("div");l.className="undead-list-container",n.appendChild(l);const p=_e(),u=r=>{l.innerHTML="";for(const m in p){if(m.startsWith("//"))continue;const d=p[m];if(r==="ã™ã¹ã¦"||d.category===r){const h=document.createElement("div");h.className="undead-list-item",h.innerHTML=`<img src="${d.img}" alt="${d.name}"><div class="undead-list-item-name">${d.name}</div>`,h.onclick=()=>{const g=d.category==="ãƒ¬ã‚®ã‚ªãƒ³"?5:1;for(let f=0;f<g;f++)st(m,e);T(),t.classList.remove("is-visible"),ve()},l.appendChild(h)}}};o.querySelectorAll(".filter-btn").forEach(r=>{r.onclick=()=>{o.querySelectorAll(".filter-btn").forEach(m=>m.classList.remove("active")),r.classList.add("active"),u(r.dataset.category)}}),u("ã™ã¹ã¦"),t.querySelector("#closeModalBtn").onclick=()=>t.classList.remove("is-visible"),t.onclick=r=>{r.target===t&&t.classList.remove("is-visible")},t.classList.add("is-visible")}function yn(e,t,n){const a=K.indexOf(e.area);let s=1;if(t&&t.effects){const r=t.effects.find(m=>m.ref==="MOVE_CHARACTER");if(r&&r.params&&r.params.distance){const d=String(r.params.distance).split("-");s=parseInt(d[1]||d[0],10)}}const o={å¥ˆè½:"naraku",åœ°ç„:"jigoku",ç…‰ç„:"rengoku",èŠ±åœ’:"hanazono",æ¥½åœ’:"rakuen"},i=[],c=e.type==="enemy"&&e.area==="å¥ˆè½"&&e.category!=="ãƒ¬ã‚®ã‚ªãƒ³"&&e.category!=="ãƒ›ãƒ©ãƒ¼",l={label:">>> é€ƒèµ° >>>",isDisabled:!c,onClick:()=>{c&&W(e,{...t,name:"é€ƒèµ°",isEscapeAttempt:!0})}},p=e.type==="pc"&&e.area==="æ¥½åœ’"&&e.category!=="ãƒ¬ã‚®ã‚ªãƒ³"&&e.category!=="ãƒ›ãƒ©ãƒ¼",u={label:"<<< é€ƒèµ° <<<",isDisabled:!p,onClick:()=>{p&&W(e,{...t,name:"é€ƒèµ°",isEscapeAttempt:!0})}};t.effects.some(r=>r.ref==="MOVE_CHARACTER")&&i.push(l),K.forEach((r,m)=>{const h=Math.abs(a-m)>s||m===a,f={label:m===a?`${r} (ç¾åœ¨åœ°)`:r,isDisabled:h,onClick:()=>{h||W(e,{...t,targetArea:r})}},v=o[r];v&&(f.class=`area-color-${v}`),i.push(f)}),t.effects.some(r=>r.ref==="MOVE_CHARACTER")&&i.push(u),R({title:`ã€${t.name}ã€‘ç§»å‹•å…ˆã‚’é¸æŠ`,items:i})}function me(){const e=document.getElementById("maneuverMenu");e&&e.classList.remove("is-visible"),te(),ue=null}function bt(e){const t=A(),n=[];(e.skills||[]).forEach(i=>{const c=_(i);c&&n.push({data:c,sourceType:"skill",sourceName:i})}),Object.values(e.partsStatus||{}).flat().forEach(i=>{const c=_(i.name);c&&n.push({data:c,sourceType:"part",sourceName:i.name,isDamaged:i.damaged})});const a=_("å¾…æ©Ÿ");a&&n.push({data:a,sourceType:"common"});const s=_("ä»»æ„");s&&n.push({data:s,sourceType:"common"});const o=new Set;return document.getElementById("actionPhaseIndicator")?.classList.contains("active")&&o.add("ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"),document.getElementById("rapidPhaseIndicator")?.classList.contains("active")&&o.add("ãƒ©ãƒ”ãƒƒãƒ‰"),document.getElementById("judgePhaseIndicator")?.classList.contains("active")&&o.add("ã‚¸ãƒ£ãƒƒã‚¸"),document.getElementById("damagePhaseIndicator")?.classList.contains("active")&&o.add("ãƒ€ãƒ¡ãƒ¼ã‚¸"),n.map(i=>{const c=i.data;let l=!0;if(i.isDamaged&&(l=!1),e.usedManeuvers.has(c.name)&&(l=!1),(isNaN(Number(c.cost))?0:Number(c.cost))>e.actionValue&&(l=!1),c.timing!=="ã‚ªãƒ¼ãƒˆ"&&o.has(c.timing)||(l=!1),c.timing==="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"&&l&&(t.activeActors.some(r=>r.id===e.id)||(l=!1)),l&&c.timing!=="ã‚ªãƒ¼ãƒˆ"){const{hasTarget:u}=De(e,c);u||(l=!1)}return{...i,isUsable:l}})}function bn(e,t){if(!t||!t.partsStatus)return"";for(const n in t.partsStatus)if(t.partsStatus[n].some(a=>a.name===e.name))return{head:"é ­",arms:"è…•",torso:"èƒ´",legs:"è„š",body:"ä»–"}[n]||"";return""}function $n(e,t){R({title:"ä¿ç®¡æ‰€ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’èª­è¾¼ã¿",bodyHtml:`
        <div class="import-method-selector">
            <input type="radio" name="import-method" id="import-by-new" value="new" checked>
            <label for="import-by-new">æ–°ç€ãƒªã‚¹ãƒˆ</label>
            <input type="radio" name="import-method" id="import-by-idlist" value="idlist">
            <label for="import-by-idlist">IDãƒªã‚¹ãƒˆ</label>
            <input type="radio" name="import-method" id="import-by-id" value="id">
            <label for="import-by-id">IDå…¥åŠ›</label>
        </div>
        
        <div id="import-by-list-content">
            <div class="loader">ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            <div class="sheet-list-container"></div>
        </div>

        <div id="import-by-id-content" style="display: none;">
            <p style="text-align: center; margin: 10px 0;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆä¿ç®¡æ‰€ã®URLã¾ãŸã¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="sheetIdInput" class="modal-input-text" placeholder="ä¾‹: 4634334">
            <p class="modal-note">â€» https://charasheet.vampire-blood.net/xxxx ã®å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</p>
            <button id="importSheetBtn" class="import-btn">èª­è¾¼ã¿</button>
        </div>
    `,onRender:(a,s)=>{const o=a.querySelector("#import-by-list-content"),i=a.querySelector("#import-by-id-content"),c=a.querySelector(".sheet-list-container"),l=a.querySelector(".loader"),p=a.querySelector("#sheetIdInput"),u=a.querySelector("#importSheetBtn"),r=async d=>{try{s(),ae(`ID: ${d} ã‚’èª­è¾¼ã¿ä¸­...`,3e3);const h=await En(d),g=dn(h);if(g)g.sheetId=d,t.addCharacterFromObject(g,e),T(),ve(),ae(`ã€Œ${g.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`,3e3);else throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")}catch(h){alert(`ã‚¨ãƒ©ãƒ¼: ${h.message}`)}},m=d=>{l.style.display="block",c.innerHTML="",l.textContent=`${d==="id"?"ID":"æ–°ç€"}ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...`,Cn(d).then(h=>{l.style.display="none";const g=`
                        <table class="sheet-list-table">
                            <thead>
                                <tr><th>ID</th><th>ã‚¿ã‚¤ãƒˆãƒ« / PCå</th><th>ãƒã‚¸ã‚·ãƒ§ãƒ³</th><th>ã‚¯ãƒ©ã‚¹</th></tr>
                            </thead>
                            <tbody>
                                ${h.map(f=>{const v=f.title||"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)",C=f.Name?`<br><span class="pc-name-in-list">${f.Name}</span>`:"";return`
                                        <tr data-id="${f.id}">
                                            <td>${f.id}</td>
                                            <td>${v}${C}</td>
                                            <td>${f.Race}</td>
                                            <td>${f.Class}</td>
                                        </tr>
                                    `}).join("")}
                            </tbody>
                        </table>`;c.innerHTML=g,a.querySelectorAll(".sheet-list-table tbody tr").forEach(f=>{f.onclick=()=>r(f.dataset.id)})}).catch(h=>{l.textContent=`ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${h.message}`})};a.querySelectorAll('input[name="import-method"]').forEach(d=>{d.onchange=h=>{const g=h.target.value;g==="new"?(o.style.display="block",i.style.display="none",m("%21")):g==="idlist"?(o.style.display="block",i.style.display="none",m("id")):(o.style.display="none",i.style.display="block",p.focus())}}),u.onclick=()=>{const d=p.value.trim().match(/(\d+)/)?.[1];d&&r(d)},p.onkeydown=d=>{if(d.key==="Enter"){const h=p.value.trim().match(/(\d+)/)?.[1];h&&r(h)}},m("%21")}})}async function Cn(e="%21"){const n=[],a=document.querySelector("#import-by-list-content .loader"),s=o=>new Promise((i,c)=>{const l=`jsonpCallback_list_${Date.now()}_${o}`;window[l]=u=>{document.head.removeChild(p),delete window[l],i(u)};const p=document.createElement("script");p.onerror=()=>{delete window[l],document.head.removeChild(p),c(new Error(`Page ${o}ã®èª­è¾¼ã¿ã«å¤±æ•—`))},p.src=`https://charasheet.vampire-blood.net/list_nechro.js?order=${e}&page=${o}&callback=${l}`,p.charset="UTF-8",document.head.appendChild(p)});for(let o=0;o<6;o++)try{a&&(a.textContent=`ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­... (${o+1} / 6ãƒšãƒ¼ã‚¸)`);const i=await s(o);n.push(...i),await new Promise(c=>setTimeout(c,200))}catch(i){throw console.error(`ãƒšãƒ¼ã‚¸ ${o} ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã€‚`,i),new Error(`ãƒšãƒ¼ã‚¸ ${o} ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`)}return n}function En(e){return new Promise((t,n)=>{const a=`jsonpCallback_${Date.now()}`;window[a]=o=>{document.head.removeChild(s),delete window[a],t(o)};const s=document.createElement("script");s.onerror=()=>{delete window[a],document.head.removeChild(s),n(new Error("ã‚·ãƒ¼ãƒˆã®èª­è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"))},s.src=`https://charasheet.vampire-blood.net/${e}.js?callback=${a}`,s.charset="UTF-8",document.head.appendChild(s)})}function Te(e,t){const n=()=>{const g=localStorage.getItem("userLocalImages");return g?JSON.parse(g):[]},a=g=>{const f=n();f.includes(g)||(f.push(g),localStorage.setItem("userLocalImages",JSON.stringify(f)))},s=async(g,f,v)=>{const C=g.target.files[0];if(C&&C.type.startsWith("image/"))try{const b=await o(C,300);a(b),v(),Te(e,t)}catch(b){console.error("ç”»åƒã®ãƒªã‚µã‚¤ã‚ºã«å¤±æ•—ã—ã¾ã—ãŸ:",b),alert("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ç”»åƒã§è©¦ã—ã¦ãã ã•ã„ã€‚")}g.target.value=""};function o(g,f){return new Promise((v,C)=>{const b=new FileReader;b.readAsDataURL(g),b.onload=y=>{const M=new Image;M.src=y.target.result,M.onload=()=>{let w=M.width,L=M.height;if(w<=f&&L<=f){v(M.src);return}w>L?w>f&&(L*=f/w,w=f):L>f&&(w*=f/L,L=f);const F=document.createElement("canvas");F.width=w,F.height=L,F.getContext("2d").drawImage(M,0,0,w,L);const Lt=F.toDataURL("image/jpeg",.8);v(Lt)},M.onerror=w=>C(w)},b.onerror=y=>C(y)})}const i=["images/doll/doll_01.png","images/doll/doll_02.png","images/doll/doll_03.png","images/doll/doll_04.png","images/doll/doll_05.png","images/doll/doll_06.png","images/doll/doll_12.png","images/doll/doll_13.png","images/doll/doll_14.png","images/doll/doll_15.png","images/doll/doll_16.png","images/doll/doll_17.png"],c=Rt(),l=n(),p=[...new Set([...i,...c])],r=[...l,...p].map(g=>`<div class="image-select-item" data-path="${g}"><img src="${g}" alt="image" loading="lazy"></div>`).join(""),h=`
        <div class="local-image-upload-container">
            <div class="button-group">
                <button id="localImageUploader" class="local-image-upload-btn">ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­è¾¼ã¿</button>
                <button id="clearImageCacheBtn" class="local-image-clear-btn">ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¶ˆå»</button>
            </div>
            <input type="file" id="localImageInput" accept="image/*" style="display: none;">
            <p class="image-upload-note">ç”»åƒã¯ã€300Ã—300px ã«ãƒªã‚µã‚¤ã‚ºã•ã‚Œã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚</p>
            <p class="image-upload-note">ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨é‡: ${(fn()/1024).toFixed(1)} KB / 5.0 MB</p>
        </div>
        <div class="image-select-grid">${r}</div>
    `;R({title:"ç”»åƒã‚’é¸æŠ",bodyHtml:h,onRender:(g,f)=>{const v=g.querySelector("#localImageUploader"),C=g.querySelector("#localImageInput");v.onclick=()=>C.click(),C.onchange=y=>s(y,g,f);const b=g.querySelector("#clearImageCacheBtn");b&&(b.onclick=()=>{confirm("ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ãŸç”»åƒã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")&&(pn(),ae("ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚",3e3),f(),Te(e,t))}),g.querySelectorAll(".image-select-item").forEach(y=>{y.onclick=()=>{const M=y.dataset.path;j(e.id,{img:M}),T(),f(),t();const w=P(e.id);w&&Pe(w)}})}})}function Mn(e,t){const n=A(),a=K.indexOf(e.area),s=t.range;if(typeof s!="string"&&typeof s!="number")return[];const o=s.toString().split("ï½"),i=parseInt(o[0],10),c=parseInt(o[1]||o[0],10);return isNaN(i)?[]:n.actionQueue.filter(l=>{if(l.checked)return!1;const p=l.performer,u=K.indexOf(p.area);if(u===-1)return!1;const r=Math.abs(a-u);return!(r<i||r>c||t.category==="æ”¯æ´"&&e.type!==p.type||t.category==="å¦¨å®³"&&e.type===p.type)})}function De(e,t){const n=t.range;if(!n||["è‡ªèº«","åŠ¹æœå‚ç…§","ãªã—","ã™ã¹ã¦"].includes(n)||t.timing==="ã‚ªãƒ¼ãƒˆ")return{hasTarget:!0,targets:[]};let a=0;const s=n.toString().split("ï½"),o=parseInt(s[0],10),i=parseInt(s[1]||s[0],10)+a;if(isNaN(o))return{hasTarget:!0,targets:[]};const c=B(),l=K.indexOf(e.area),p=[],u=c.filter(r=>!r.isDestroyed&&!r.hasWithdrawn);for(const r of u){if(r.id===e.id&&n!=="0"||e.type===r.type&&t.tags.includes("æ”»æ’ƒ"))continue;const m=K.indexOf(r.area);if(m===-1)continue;const d=Math.abs(l-m);d>=o&&d<=i&&p.push(r)}return{hasTarget:p.length>0,targets:p}}async function kn(e,t,n){return new Promise(a=>{const s=l=>{if(!oe)return;const p=oe;o(),p(l)},o=()=>{oe=null,document.querySelectorAll(".target-selectable").forEach(l=>l.classList.remove("target-selectable")),document.removeEventListener("click",n)};oe=a,E(`>> ${e.name}ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚(å¯¾è±¡å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«)`);const{targets:i}=De(e,t);i.length>0&&Ct(i);const c=new Set(i.map(l=>l.id));document.querySelectorAll(".char, .marker").forEach(l=>{c.has(l.dataset.id)&&(l.classList.add("target-selectable"),l.onclick=p=>{p.stopPropagation(),s(P(l.dataset.id))})}),document.addEventListener("click",n)})}function Sn(e,t,n){const c=(e.type==="pc"?["ç…‰ç„","èŠ±åœ’","æ¥½åœ’"]:["å¥ˆè½","åœ°ç„","ç…‰ç„","èŠ±åœ’","æ¥½åœ’"]).map(l=>({label:l+(e.area===l?" (ç¾åœ¨åœ°)":""),isDisabled:e.area===l,onClick:()=>{j(e.id,{area:l}),T()}}));R({title:`${e.name} ã®é…ç½®å…ˆã‚’é¸æŠ`,items:c})}function wn(e,t,n,a){const s=A(),o=s.actionQueue[a];if(!o)return;let i=0;const c=[],l=[],p=n.effects.find(f=>f.ref==="GENERIC_ATTACK");if(p&&p.params&&p.params.attack_bonus){const f=parseInt(p.params.attack_bonus,10);isNaN(f)||(i+=f,c.push(`ã€${n.name}ã€‘è‡ªä½“ (${f>0?"+":""}${f})`))}bt(e).filter(f=>f.data.timing==="ã‚ªãƒ¼ãƒˆ"&&!f.isDamaged).forEach(f=>{f.data.effects&&f.data.effects.forEach(v=>{if(v.ref==="APPLY_BUFF"&&v.params.stat==="attackCheckBonus"){const C=v.params.value||0;i+=C,c.push(`${e.name}ã®ã€${f.data.name}ã€‘(${C>0?"+":""}${C})`)}})}),e.activeBuffs&&e.activeBuffs.length>0&&e.activeBuffs.forEach(f=>{if(f.stat==="attackCheckBonus"){const v=f.value||0;i+=v,c.push(`${e.name}ã®ã€${f.source}ã€‘åŠ¹æœ (+${v})`)}}),s.judgeQueue.forEach(f=>{const v=f.sourceManeuver,C=v.effects.find(b=>b.ref==="GENERIC_JUDGE_MOD");if(C){let b=!1;if((f.judgeTarget&&f.judgeTarget.id===o.id||C.params.target==="self_roll"&&f.performer.id===e.id)&&(b=!0),b){const y=C.params.value||0,M=`${f.performer.name}ã®ã€${v.name}ã€‘`;y>0?(i+=y,c.push(`${M} (+${y})`)):y<0&&(i+=y,l.push(`${M} (${y})`))}}});const r=c.length>0?c.map(f=>`<div class="modifier-item">${f}</div>`).join(""):'<div class="modifier-none">- ãªã— -</div>',m=l.length>0?l.map(f=>`<div class="modifier-item">${f}</div>`).join(""):'<div class="modifier-none">- ãªã— -</div>',d=i>0?`+${i}`:i<0?`${i}`:"",h=`
        <div class="attack-confirm-summary">
            ${e.name}ã€${n.name}ã€‘ â†’ ${t.name}
        </div>
        <div class="attack-confirm-section">
            <div class="section-header">ã€Šæ”¯æ´ã€‹</div>
            <div class="modifier-list">${r}</div>
        </div>
        <div class="attack-confirm-section">
            <div class="section-header">ã€Šå¦¨å®³ã€‹</div>
            <div class="modifier-list">${m}</div>
        </div>
    `,g=`<button id="executeDiceRollBtn" class="welcome-modal-close-btn">ğŸ² NA${d} ğŸ²</button>`;R({title:"ã‚¸ãƒ£ãƒƒã‚¸",bodyHtml:h,footerHtml:g,onRender:(f,v)=>{f.querySelector("#executeDiceRollBtn").onclick=()=>{Mt(a,i),v()}}})}const In="2.1.6";let G=!1,N=null;function Ln(){console.log("Interaction Manager initialized.")}function An(){document.addEventListener("click",t=>{N&&!N.contains(t.target)&&(N.classList.remove("actions-visible"),N=null)}),he(),Tn(),Ue(document.getElementById("pcContainer")),Ue(document.getElementById("enemyContainer")),Bn();const e=document.getElementById("startBattleBtn");e&&(e.onclick=()=>{e.disabled||Xn()}),document.getElementById("countdownBtn").onclick=()=>ea(),document.getElementById("endTurnBtn").onclick=()=>kt()}function he(){document.querySelectorAll(".char").forEach(e=>{const t=e.dataset.id;if(!t)return;const n=P(t);if(n){if(A().isStarted)e.onclick=a=>{if(a.stopPropagation(),G){G=!1;return}qe(n,e)};else{e.onclick=u=>{if(u.stopPropagation(),G){G=!1;return}N===e?(e.classList.remove("actions-visible"),N=null):(N&&N.classList.remove("actions-visible"),e.classList.add("actions-visible"),N=e)};const a=e.querySelector('[data-action="delete"]');a&&(a.onclick=u=>{u.stopPropagation(),ot(t),T(),ve(),N=null});const s=e.querySelector('[data-action="details"]');s&&(s.onclick=u=>{u.stopPropagation(),Pe(n)});const o=e.querySelector('[data-action="place"]');o&&(o.onclick=u=>{u.stopPropagation(),Sn(n)});const i=e.querySelector('[data-action="move-left"]');i&&(i.onclick=u=>{u.stopPropagation(),Se(t,"left"),T(),N=null});const c=e.querySelector('[data-action="move-right"]');c&&(c.onclick=u=>{u.stopPropagation(),Se(t,"right"),T(),N=null});const l=B().filter(u=>u.type===n.type),p=l.findIndex(u=>u.id===t);i&&(i.disabled=p===0),c&&(c.disabled=p===l.length-1)}e.onmouseenter=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.add("hover-highlight"),document.querySelector(`.marker[data-id="${t}"]`)?.classList.add("hover-highlight")},e.onmouseleave=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.remove("hover-highlight"),document.querySelector(`.marker[data-id="${t}"]`)?.classList.remove("hover-highlight")}}}),document.querySelectorAll(".marker").forEach(e=>{const t=e.dataset.id;if(!t)return;const n=P(t);n&&(A().isStarted&&(e.onclick=a=>{a.stopPropagation(),qe(n,e)}),e.onmouseenter=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.add("hover-highlight"),e.classList.add("hover-highlight")},e.onmouseleave=()=>{document.querySelector(`.char[data-id="${t}"]`)?.classList.remove("hover-highlight"),e.classList.remove("hover-highlight")})}),document.querySelectorAll(".add-char-card").forEach(e=>{const t=e.closest(".char-container");if(t){const n=t.id==="pcContainer"?"pc":"enemy";e.onclick=null,e.onclick=()=>{vn(n)}}})}function Ue(e){let t=!1,n,a,s;e.addEventListener("mousedown",i=>{t=!0,G=!1,n=i.pageX-e.offsetLeft,a=e.scrollLeft,s=0});const o=()=>{t=!1,Math.abs(s)>5&&(G=!0)};e.addEventListener("mouseleave",o),e.addEventListener("mouseup",o),e.addEventListener("mousemove",i=>{if(!t)return;i.preventDefault(),s=i.pageX-e.offsetLeft-n,e.scrollLeft=a-s})}function Tn(){const e=document.getElementById("diceRoller");let t=!1,n,a,s,o;e.addEventListener("mousedown",l=>{s=l.clientX,o=l.clientY,t=!0,n=l.clientX-e.getBoundingClientRect().left,a=l.clientY-e.getBoundingClientRect().top,e.style.cursor="grabbing",document.addEventListener("mousemove",i),document.addEventListener("mouseup",c),l.preventDefault()});function i(l){t&&(e.style.left=`${l.clientX-n}px`,e.style.top=`${l.clientY-a}px`)}function c(){t=!1,e.style.cursor="grab",document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c)}e.addEventListener("click",l=>{Math.abs(l.clientX-s)>3||Math.abs(l.clientY-o)>3||cn()})}function Bn(){document.querySelectorAll(".accordion-header").forEach(e=>{e.closest("#maneuverMenu")||e.addEventListener("click",()=>{const t=e.closest(".accordion-container");t&&t.classList.toggle("is-closed")})})}function xn(e){const t=document.getElementById("madnessModal"),n=document.getElementById("confirmMadnessBtn"),a=new Map;document.querySelectorAll(".pc-regret-group").forEach(s=>{s.querySelectorAll(".regret-item").forEach(o=>{o.onclick=()=>{s.querySelectorAll(".regret-item").forEach(i=>i.classList.remove("is-selected")),o.classList.add("is-selected"),a.set(s.dataset.pcId,o.dataset.regretId),n.disabled=a.size!==e.length}})}),n.disabled=!0,n.onclick=()=>{a.forEach((s,o)=>it(o,s)),t.classList.remove("is-visible"),St()}}function _n(e){ta(e)}function Nn(e){const n=A().actionQueue[e];if(!n)return;const{performer:a,target:s,sourceManeuver:o}=n;o.tags.includes("æ”»æ’ƒ")?wn(a,s,o,e):Mt(e)}function Pn(e){na(e)}function Dn(e){const{damageQueue:t}=A(),n=t[e];if(n&&!n.applied){const a=P(n.target.id);if(!a)return;const s=()=>{aa(e)};a.category==="ãƒ¬ã‚®ã‚ªãƒ³"||Object.values(a.partsStatus).flat().filter(o=>!o.damaged).length<=n.amount?(a.category==="ãƒ¬ã‚®ã‚ªãƒ³"?(E(`ãƒ¬ã‚®ã‚ªãƒ³ã¸ã®æ”»æ’ƒï¼ ${n.amount}ä½“ã®å…µå“¡ãŒå¤±ã‚ã‚Œã¾ã™ã€‚`),Ne(a.id,null,n.amount)):(E(`ï¼ ${a.name}ã¯æ®‹ã‚Šãƒ‘ãƒ¼ãƒ„æ•°ä»¥ä¸Šã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã€å®Œå…¨ã«ç ´å£Šã•ã‚Œã¾ã—ãŸï¼`),j(a.id,{isDestroyed:!0})),zn(a.id),s()):Rn(a,n.amount,n.location,s)}}function Rn(e,t,n,a){const s=document.getElementById("damageModal"),o=s.querySelector("#damageModalTitle"),i=s.querySelector("#damageModalInfo"),c=s.querySelector("#partsGridContainer"),l=s.querySelector("#confirmDamageBtn");o.textContent=`${e.name} ã¸ã®ãƒ‘ãƒ¼ãƒ„æå‚·å‡¦ç†`,c.innerHTML="";let p=[];const u=()=>{i.textContent=`æå‚·ã•ã›ã‚‹ãƒ‘ãƒ¼ãƒ„ã‚’ ${t} å€‹é¸æŠã—ã¦ãã ã•ã„ (æ®‹ã‚Š: ${t-p.length})`,l.disabled=p.length!==t};u();const r=e.category==="ãƒ›ãƒ©ãƒ¼",m={é ­:"head",è…•:"arms",èƒ´:"torso",è„š:"legs",ä½“:"body"},d=m[n]||null;if((r?["body"]:["head","arms","torso","legs","body"]).forEach(g=>{const f=e.partsStatus[g];if(f&&f.length>0){const v=document.createElement("div");v.className="part-location-group",v.dataset.location=g,v.innerHTML=`<h4>${Object.keys(m).find(b=>m[b]===g)||"ä»–"}</h4>`;const C=document.createElement("div");C.className="parts-wrapper",f.forEach(b=>{const y=document.createElement("div");y.className="part-item",y.textContent=b.name,y.dataset.partId=b.id;const M=_(b.name);M&&(y.addEventListener("mouseenter",()=>Et(s.getBoundingClientRect(),y.getBoundingClientRect(),e,{data:M,isDamaged:b.damaged})),y.addEventListener("mouseleave",()=>te())),b.damaged?y.classList.add("is-damaged"):y.onclick=()=>{const w=b.id,L=p.indexOf(w);L>-1?(y.classList.remove("is-selected"),p.splice(L,1)):p.length<t&&(y.classList.add("is-selected"),p.push(w)),u()},C.appendChild(y)}),v.appendChild(C),c.appendChild(v)}}),d&&c.querySelector(`.part-location-group[data-location="${d}"]`)?.classList.add("is-highlighted"),d&&e.partsStatus[d]){const g=e.partsStatus[d].filter(f=>!f.damaged);g.length>0&&g.length<=t&&g.forEach(f=>{const v=c.querySelector(`.part-item[data-part-id="${f.id}"]`);v&&!v.classList.contains("is-selected")&&(v.classList.add("is-selected"),p.push(f.id))})}u(),l.onclick=()=>{p.forEach(g=>Ne(e.id,g)),s.classList.remove("is-visible"),te(),Un(e.id),Q(),a&&a()},document.getElementById("closeDamageModalBtn").onclick=()=>{s.classList.remove("is-visible"),te()},s.classList.add("is-visible")}const On="1.12.68";let ie=null;const le=["å¥ˆè½","åœ°ç„","ç…‰ç„","èŠ±åœ’","æ¥½åœ’"],Me=Array.from({length:26},(e,t)=>20-t);function Hn(){console.log("UI Manager initialized.")}function jn(){document.documentElement.style.setProperty("--col-count",Me.length),document.documentElement.style.setProperty("--row-count",le.length);const e=document.getElementById("battleWrap");e.innerHTML="";const t=document.createElement("div");t.className="current-action-cell",t.id="currentActionValue",e.appendChild(t),Me.forEach((a,s)=>{const o=document.createElement("div");o.className="col-header",o.textContent=a,o.dataset.col=String(a),o.style.gridColumn=(s+2).toString(),o.style.gridRow="1",e.appendChild(o)});const n={å¥ˆè½:"naraku",åœ°ç„:"jigoku",ç…‰ç„:"rengoku",èŠ±åœ’:"hanazono",æ¥½åœ’:"rakuen"};le.forEach((a,s)=>{const o=document.createElement("div");o.className="row-header";const i=n[a];i&&o.classList.add(`area-color-${i}`),o.textContent=a,o.style.gridColumn="1",o.style.gridRow=(s+2).toString(),e.appendChild(o)}),le.forEach((a,s)=>{Me.forEach((o,i)=>{const c=document.createElement("div");c.className="cell";const l=n[a];l&&c.classList.add(`cell-area-${l}`),o===0?c.classList.add("col-zero"):o<0&&c.classList.add("col-negative"),c.dataset.row=String(s),c.dataset.col=String(o),c.style.gridColumn=(i+2).toString(),c.style.gridRow=(s+2).toString(),e.appendChild(c)})})}function ae(e,t=2e3){const n=document.getElementById("toast-notification");n&&(ie&&clearTimeout(ie),n.innerHTML=e,n.classList.add("is-visible"),ie=setTimeout(()=>{n.classList.remove("is-visible"),ie=null},t))}function T(){const e=B(),t=e.filter(a=>a.type==="pc"),n=e.filter(a=>a.type==="enemy");We(document.getElementById("pcContainer"),t,"pc"),We(document.getElementById("enemyContainer"),n,"enemy"),Q(),he()}function We(e,t,n){e.innerHTML="";const a=!A().isStarted;if(t.forEach(s=>{const o=$t(s,a);e.appendChild(o)}),a){const s=document.createElement("div");s.className="add-char-card";const o=n==="pc"?"å§‰å¦¹ãƒ‰ãƒ¼ãƒ«":"NCã®æ‰‹é§’";s.innerHTML=`<div class="add-char-text">${o}</div><div class="add-char-plus">+</div><div class="add-char-text">ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ã‚’è¿½åŠ </div>`,e.appendChild(s)}}function $t(e,t){let n="";e.isMentallyBroken&&(n+=" status-mental-collapse"),e.isDestroyed&&(n+=" status-destroyed"),e.hasWithdrawn&&(n+=" status-withdrawn");let a="";(e.isDestroyed||e.hasWithdrawn)&&(a+=" is-inactive");const s=document.createElement("div");s.className=`char ${a.trim()}`,s.dataset.id=e.id;const o=`
        <div class="card-actions-overlay">
            <div class="card-action-row">
                <button class="card-action-btn" data-action="place">ç§»å‹•</button>
                <button class="card-action-btn" data-action="details">è©³ç´°</button>
                <button class="card-action-btn" data-action="delete">å‰Šé™¤</button>
            </div>
            <div class="card-action-row">
                <button class="card-action-btn" data-action="move-left">â†</button>
                <button class="card-action-btn" data-action="move-right">â†’</button>
            </div>
        </div>`;let i="";e.regrets&&e.regrets.length>0&&(i=`<div class="char-madness">${e.regrets.map(h=>{const g=h.points||0;let f="";for(let C=0;C<4;C++)f+=C<g?"â—†":"â—‡";return`<div class="${g>=4?"is-madness":""}">${f}</div>`}).join("")}</div>`);let c="";if(e.partsStatus){let d="";if(e.category==="ãƒ‰ãƒ¼ãƒ«"||e.category==="ã‚µãƒ´ã‚¡ãƒ³ãƒˆ"){const h=["head","arms","torso","legs","body"],g={head:"é ­",arms:"è…•",torso:"èƒ´",legs:"è„š",body:"ä»–"},f=e.treasure;d=h.map(v=>{if(!e.partsStatus[v]||e.partsStatus[v].length===0)return"";const b=e.partsStatus[v].map(y=>{const M=_(y.name),w=M&&M.id&&M.id.startsWith("BP-"),L=y.name===f;return{part:y,isBasicPart:w,isTreasure:L,damaged:y.damaged}}).sort((y,M)=>y.isTreasure!==M.isTreasure?y.isTreasure?-1:1:y.isBasicPart!==M.isBasicPart?y.isBasicPart?1:-1:y.damaged!==M.damaged?y.damaged?-1:1:0).map(y=>y.isTreasure?y.damaged?"â˜†":"â˜…":y.isBasicPart?y.damaged?"â–¡":"â– ":y.damaged?"ã€‡":"â—").join("");return v==="body"&&!e.partsStatus[v].some(y=>y.name!==f)?"":`<div>${b}ï¼š${g[v]}</div>`}).filter(v=>v!=="").join("")}else if(e.category==="ãƒ›ãƒ©ãƒ¼"){const h=Object.values(e.partsStatus).flat(),g=[],f=[];h.forEach(b=>{const y=_(b.name);y&&y.id&&y.id.startsWith("BP-")?g.push(b):f.push(b)});let v="";if(f.length>0){const b=f.filter(M=>M.damaged).length;v=`<div>${"ã€‡".repeat(b)+"â—".repeat(f.length-b)}ï¼šå¼·</div>`}let C="";if(g.length>0){const b=g.filter(M=>M.damaged).length;C=`<div>${"â–¡".repeat(b)+"â– ".repeat(g.length-b)}ï¼šåŸº</div>`}d=C+v}else if(e.category==="ãƒ¬ã‚®ã‚ªãƒ³"){const h=e.isDestroyed?0:e.stackCount,g=Math.ceil(h/10),f=[];for(let v=0;v<g;v++){const C=v*10,b=Math.min(h-C,10);b>0&&f.push(`<div>${"â—".repeat(b)}ï¼š</div>`)}d=f.reverse().join("")}d&&(c=`<div class="char-parts-status">${d}</div>`)}const l=e.category==="ãƒ¬ã‚®ã‚ªãƒ³";let p="";l?p=`<div class="char-stack-count">${e.isDestroyed?0:e.stackCount}ä½“</div>`:p=`<div class="char-parts-count">${e.isDestroyed?0:Object.values(e.partsStatus).flat().filter(h=>!h.damaged).length}</div>`;const u=`
        <div class="char-action-display">
            <div class="char-action-value">${e.actionValue}</div>
            <div class="char-action-subtext">è¡Œå‹•å€¤</div>
            <div class="char-action-subtext">æœ€å¤§:${e.maxActionValue}</div>
        </div>
    `,m=`area-color-${{å¥ˆè½:"naraku",åœ°ç„:"jigoku",ç…‰ç„:"rengoku",èŠ±åœ’:"hanazono",æ¥½åœ’:"rakuen"}[e.area]||""}`;return s.innerHTML=`
        <div class="char-status-overlays ${n.trim()}">
            <div class="status-tape status-tape-mental-collapse">BREAKDOWN ç²¾ç¥å´©å£Š BREAKDOWN</div>
            <div class="status-tape status-tape-destroyed">DESTROYED å®Œå…¨ç ´å£Š DESTROYED</div>
            <div class="status-tape status-tape-withdrawn">ESCAPE æˆ¦å ´é›¢è„± ESCAPE</div>
        </div>
        <div class="char-img-container">
            <div class="damage-prompt-container"></div> 
            <div class="char-area-name ${m}">${e.area}</div>
            <div class="char-name-overlay">${e.name}</div>
            ${p}
            ${u}
            ${i} 
            ${c} 
            <img src="${e.img}" alt="${e.name}">
        </div>
        <div class="char-stats">
        </div>
        ${t?o:""}
    `,s}function qn(e){if(!e)return;const{actionValue:t,area:n,id:a,name:s,img:o,stackCount:i}=e,c=document.getElementById("battleWrap"),l=le.indexOf(n);if(l===-1)return;const p=c.querySelector(`.cell[data-row="${l}"][data-col="${t}"]`);if(!p)return;const u=document.createElement("span");u.className="marker",u.dataset.id=a,u.dataset.name=s;const r=new Image;if(r.src=o,r.className="marker-img",r.alt=s,u.appendChild(r),e.category==="ãƒ¬ã‚®ã‚ªãƒ³"&&i>1){const m=document.createElement("div");m.className="marker-stack-count",m.textContent=`x${i}`,u.appendChild(m)}p.appendChild(u)}function Ct(e){if(!e||e.length===0)return;const t=e[0].id,n=document.querySelector(`.char[data-id="${t}"]`);n&&n.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}function E(e){const t=document.getElementById("logEntries");if(!t)return;const n=document.createElement("div");n.className="log-entry",n.innerHTML=e,t.appendChild(n),t.scrollTop=t.scrollHeight}function Vn(){const e=document.getElementById("madnessModal"),t=document.getElementById("madnessModalBody");t.innerHTML="";const n=B().filter(a=>a.type==="pc"&&!a.isDestroyed&&!a.hasWithdrawn);if(n.length===0){St();return}n.forEach(a=>{const s=document.createElement("div");s.className="pc-regret-group",s.dataset.pcId=a.id,s.innerHTML=`<h4>${a.name}ã®æœªç·´ (1ã¤é¸æŠ)</h4>`,a.regrets.forEach(o=>{const i=document.createElement("div");i.className="regret-item",i.dataset.regretId=o.id,i.textContent=`${o.name} (ç‹‚æ°—ç‚¹: ${o.points})`,s.appendChild(i)}),t.appendChild(s)}),e.classList.add("is-visible"),xn(n)}function Un(e){const t=P(e);if(!t)return;const n=document.querySelector(`.char[data-id="${e}"]`);if(n){const a=!A().isStarted,s=$t(t,a);n.replaceWith(s),he()}}function Q(){document.getElementById("battleWrap").querySelectorAll(".marker").forEach(n=>n.remove()),B().filter(n=>!n.isDestroyed&&!n.hasWithdrawn).forEach(n=>{qn(n)}),he()}function Be(){const{isStarted:e,turn:t,count:n,activeActors:a,shouldScrollToCount:s}=A(),o=document.getElementById("timingArea"),i=document.getElementById("battleWrap");o&&(e?(o.classList.remove("setup-phase"),o.classList.add("battle-phase"),i.classList.remove("setup-phase")):(o.classList.add("setup-phase"),o.classList.remove("battle-phase"),i.classList.add("setup-phase")));const c=document.getElementById("turnIndicator").textContent;String(t)!==c&&e&&E(`ã€ã‚¿ãƒ¼ãƒ³ ${t} é–‹å§‹ã€‘`);const l=document.getElementById("turnIndicator"),p=document.getElementById("countIndicator"),u=document.getElementById("currentActionValue");if(!e){l.textContent="-",p.textContent="-",u.textContent="ã‚«ã‚¦ãƒ³ãƒˆ -",document.querySelectorAll(".highlight-char").forEach(r=>r.classList.remove("highlight-char")),i.querySelectorAll(".highlight-col").forEach(r=>r.classList.remove("highlight-col")),fe(A());return}if(l.textContent=t,p.textContent=n,u.textContent=`ã‚«ã‚¦ãƒ³ãƒˆ ${n}`,document.querySelectorAll(".char").forEach(r=>{r.classList.toggle("highlight-char",a.some(m=>m.id===r.dataset.id))}),i.querySelectorAll(".highlight-col").forEach(r=>r.classList.remove("highlight-col")),i.querySelectorAll(`.cell[data-col="${n}"], .col-header[data-col="${n}"]`).forEach(r=>r.classList.add("highlight-col")),s){const r=document.querySelector(".battle-grid-scroll-wrapper"),m=i.querySelector(`.col-header[data-col="${n}"]`),d=i.querySelector(".row-header");if(r&&m&&d){const h=d.offsetWidth,f=m.offsetLeft-h;r.scrollTo({left:f,behavior:"smooth"})}Zn()}a.length>0&&Ct(a),fe(A()),Re()}function Wn(e){const t=new Set(e.map(n=>n.id));document.querySelectorAll(".char").forEach(n=>{n.classList.toggle("highlight-char",t.has(n.dataset.id))})}function fe(e){if(!e)return;const{phase:t,actionQueue:n,activeActors:a,count:s}=e,o={action:document.getElementById("actionPhaseIndicator"),rapid:document.getElementById("rapidPhaseIndicator"),judge:document.getElementById("judgePhaseIndicator"),damage:document.getElementById("damagePhaseIndicator")};Object.values(o).forEach(l=>l.classList.remove("active")),a.length>0&&o.action.classList.add("active"),n.length>0&&(o.rapid.classList.add("active"),o.judge.classList.add("active")),(t==="JUDGE_RESOLUTION"||t==="ACTION_RESOLUTION")&&o.judge.classList.add("active"),t==="DAMAGE_RESOLUTION"&&o.damage.classList.add("active");const i=document.getElementById("countdownBtn"),c=document.getElementById("endTurnBtn");i.disabled=!0,c.disabled=!0,t==="COUNT_END"?i.disabled=!1:t==="TURN_END_PREPARATION"&&(c.disabled=!1)}function Re(){const{actionQueue:e,rapidQueue:t,judgeQueue:n,damageQueue:a}=A();ke("actionDeclarationList",e,"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®£è¨€"),ke("rapidDeclarationList",t,"ãƒ©ãƒ”ãƒƒãƒ‰å®£è¨€"),ke("judgeDeclarationList",n,"ã‚¸ãƒ£ãƒƒã‚¸å®£è¨€"),Qn(a),document.querySelectorAll(".damage-prompt-button").forEach(o=>o.remove());const s={};a.forEach(o=>{if(!o.applied){const i=o.target.id;s[i]||(s[i]=0),s[i]+=o.amount}});for(const o in s)s[o]>0&&Fn(o,s[o]);document.getElementById("actionDeclarationArea").classList.toggle("is-closed",e.length===0),document.getElementById("rapidDeclarationArea").classList.toggle("is-closed",t.length===0),document.getElementById("judgeDeclarationArea").classList.toggle("is-closed",n.length===0),document.getElementById("damageProcessingArea").classList.toggle("is-closed",a.length===0)}function ke(e,t,n){const a=document.getElementById(e);if(!a)return;const s=a.closest(".accordion-container"),o=s?s.querySelector(".accordion-header"):null;if(!o)return;const i=A(),c=i.phase==="RAPID_RESOLUTION",l=i.phase==="JUDGE_RESOLUTION",p=i.phase==="ACTION_RESOLUTION",u=i.rapidQueue.some(d=>!d.checked),r=i.judgeQueue.some(d=>!d.checked);let m=o.querySelector("span");if(!m){const d=o.textContent;o.innerHTML="",m=document.createElement("span"),m.textContent=d,o.appendChild(m)}t.length===0?(a.innerHTML="",m.textContent=n+"ã¯ã‚ã‚Šã¾ã›ã‚“"):(m.textContent=n,a.innerHTML="",t.forEach((d,h)=>{const g=document.createElement("label");g.className="action-queue-item";let f=!1;e==="rapidDeclarationList"?f=!c:e==="judgeDeclarationList"?f=!l||u:e==="actionDeclarationList"&&(f=!p||u||r),d.checked&&(f=!0),f&&g.classList.add("is-disabled"),d.checked&&g.classList.add("is-checked");const v=document.createElement("input");v.type="checkbox",v.checked=d.checked,v.disabled=!0,f||(e==="rapidDeclarationList"?g.onclick=()=>_n(h):e==="judgeDeclarationList"?g.onclick=()=>Pn(h):e==="actionDeclarationList"&&(g.onclick=()=>Nn(h))),g.appendChild(v);const C=document.createElement("span");let b=`<b>${d.performer.name}</b>: ã€${d.summary.name}ã€‘`;d.target&&(b+=` â†’ <b>${d.target.name}</b>`),C.innerHTML=b,g.appendChild(C),a.appendChild(g)}))}function Qn(e){const t=document.getElementById("damageProcessingList");if(!t)return;const n=t.closest(".accordion-container"),a=n?n.querySelector(".accordion-header"):null,s=A().phase==="DAMAGE_RESOLUTION";e.length===0?(t.innerHTML="",a&&(a.textContent="ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã¯ã‚ã‚Šã¾ã›ã‚“")):(a&&(a.textContent="ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†"),t.innerHTML="",e.forEach((o,i)=>{const c=document.createElement("label");c.className="action-queue-item damage-item";const l=!s||o.applied;l&&c.classList.add("is-disabled"),o.applied&&c.classList.add("is-checked");const p=document.createElement("input");p.type="checkbox",p.checked=o.applied,p.disabled=!0;const u=document.createElement("span");u.innerHTML=`<b>${o.target.name}</b>: ${o.location}: <b>${o.amount}</b>ç‚¹`,!o.applied&&!l&&(c.onclick=()=>Dn(i)),c.appendChild(p),c.appendChild(u),t.appendChild(c)}))}function Fn(e,t){const n=document.querySelector(`.char[data-id="${e}"]`);if(!n)return;const a=n.querySelector(".damage-prompt-container");let s=a.querySelector(".damage-prompt-button");if(s){const i=parseInt(s.dataset.damage,10)+t;s.dataset.damage=i,s.textContent=`ãƒ€ãƒ¡ãƒ¼ã‚¸ ${i}`}else s=document.createElement("button"),s.className="damage-prompt-button",s.dataset.damage=t,s.textContent=`ãƒ€ãƒ¡ãƒ¼ã‚¸ ${t}`,s.onclick=o=>{o.stopPropagation()},s.style.pointerEvents="none",a.appendChild(s)}function zn(e){const t=document.querySelector(`.char[data-id="${e}"]`);if(t){const n=t.querySelector(".damage-prompt-button");n&&n.remove()}}function ve(){const e=document.getElementById("startBattleBtn");if(!e)return;const t=B(),n=t.some(s=>s.type==="pc"),a=t.some(s=>s.type==="enemy");e.disabled=!(n&&a)}function Et(e,t,n,a){const s=document.getElementById("maneuverCard"),o=a.data,i=o.category==="è¡Œå‹•å€¤å¢—åŠ "?"è¡Œå‹•å€¤":o.category||"ãã®ä»–",c=`category-color-${lt(i)}`,l=Gn(o),p=Jn(o,n);let u="";o.source&&(u=o.source.book||"",o.source.page&&(u+=` (p${o.source.page})`),o.source.errata&&(u+=`, ã‚¨ãƒ©ãƒƒã‚¿ ${o.source.errata}`)),s.innerHTML=`
        <div class="card-category-bar ${c}">${i}</div>
        <div class="card-content">
            <div class="card-source-header">
                ${l}
            </div>
            <div class="card-header">
                <span class="card-location-text">${p}</span>
                <span class="card-maneuver-name">ã€${o.name}ã€‘</span>
            </div>
            <div class="card-stats">
                <div><span>T</span>${o.timing}</div>
                <div><span>C</span>${o.cost}</div>
                <div><span>R</span>${o.range}</div>
            </div>
            <div class="card-row"><strong>åŠ¹æœ</strong> ${o.description||"---"}</div>
            <div class="card-row"><strong>èª¬æ˜</strong> ${o.description_raw||"---"}</div>
            <div class="card-row"><strong>å‡ºå…¸</strong> ${u||"---"}</div>
        </div>
    `,s.style.display="flex";const r=s.getBoundingClientRect();let m=20,d=t.top+60;d+r.height>window.innerHeight&&(d=20),d<10&&(d=20),s.style.left=`${m}px`,s.style.top=`${d}px`}function Gn(e){if(!e.id)return"ä¸æ˜";const t=pe(),n=e.id,a=n.substring(0,2);if(t.positions[a])return`ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ«ï¼š${t.positions[a].name}`;if(t.classes[a])return n.endsWith("-SP")?`ç‰¹åŒ–ã‚¹ã‚­ãƒ«ï¼š${t.classes[a].name}`:`ã‚¯ãƒ©ã‚¹ã‚¹ã‚­ãƒ«ï¼š${t.classes[a].name}`;if(a==="BP")return"åŸºæœ¬ãƒ‘ãƒ¼ãƒ„";const s=n.substring(0,1),o=n.substring(1,2);return t.enhancementTypes[s]&&["1","2","3"].includes(o)?`å¼·åŒ–ãƒ‘ãƒ¼ãƒ„ï¼š${o}ãƒ¬ãƒ™ãƒ«${t.enhancementTypes[s].name}`:n.startsWith("P")?`æ‰‹é§’å°‚ç”¨ãƒ‘ãƒ¼ãƒ„ï¼šæ‚ªæ„${parseInt(n.substring(1,2),10)/2}`:t.pawnSkills[a]?t.pawnSkills[a].name:t.commonAction[a]?t.commonAction[a].name:"ã‚¹ã‚­ãƒ«"}function Jn(e,t){if(!e.id||!t.partsStatus)return"";const n={head:"é ­",arms:"è…•",torso:"èƒ´",legs:"è„š",body:"ä½“"};for(const a in t.partsStatus)if(t.partsStatus[a].some(s=>s.name===e.name))return`${n[a]||"ä½“"}ï¼š`;return"ã‚¹ã‚­ãƒ«ï¼š"}function te(){document.getElementById("maneuverCard").style.display="none"}function Kn(e){const t=document.getElementById("version-info");if(t&&e){const a=["app","battle-logic","ui-manager","interaction-manager","character-manager","settings-manager","menu-builder","data-handler","ui-helpers","dice-roller","dice-3d","character-converter"].map(s=>`<span class="responsive-item">${s}: v${e[s]||"N/A"}</span>`).join('<span class="hide-on-mobile"> | </span>');t.innerHTML=a}}function R(e){const t=document.getElementById("simpleMenuModal"),n=document.getElementById("simpleMenuModalTitle"),a=document.getElementById("simpleMenuModalBody"),s=document.getElementById("simpleMenuModalFooter"),o=document.getElementById("closeSimpleMenuModalBtn");if(!t||!n||!a||!s||!o)return;n.textContent=e.title||"",a.innerHTML=e.bodyHtml||"",s.innerHTML=e.footerHtml||"",s.style.display=e.footerHtml?"block":"none",a.classList.remove("attack-confirm-body"),e.bodyHtml&&e.bodyHtml.includes("attack-confirm-summary")&&a.classList.add("attack-confirm-body"),e.items&&e.items.forEach(c=>{const l=document.createElement("div");c.isTitle||(l.textContent=c.label,l.classList.add("maneuver-item"),c.class&&l.classList.add(...c.class.split(" ")),c.isDisabled&&l.classList.add("is-masked"),l.onclick=()=>{c.isDisabled||(i(),c.onClick&&c.onClick())}),a.appendChild(l)});const i=()=>t.classList.remove("is-visible");o.onclick=i,t.onclick=c=>{c.target===t&&i()},e.onRender&&e.onRender(t,i),t.classList.add("is-visible")}const Yn="1.14.57";let $={isStarted:!1,turn:1,count:0,activeActors:[],phase:"SETUP",actionQueue:[],rapidQueue:[],judgeQueue:[],damageQueue:[],moveQueue:[],currentAction:null,shouldScrollToCount:!1};function Xn(){$.isStarted=!0,$.turn=1;const e=B();$.count=Math.max(0,...e.map(t=>t.actionValue)),T(),$.shouldScrollToCount=!0,Oe(),O()}function A(){return{...$}}function Zn(){$.shouldScrollToCount=!1}function W(e,t,n=null,a=null){const s={id:`decl_${Date.now()}_${Math.random()}`,performer:e,target:n,sourceManeuver:t,timing:t.timing,isResolved:!1,summary:{name:t.name,cost:t.cost,range:t.range,description:t.description}},o=isNaN(Number(t.cost))?0:Number(t.cost);switch(o>0&&j(e.id,{actionValue:e.actionValue-o}),t.name!=="å¾…æ©Ÿ"&&j(e.id,{hasActedThisCount:!0}),t.timing){case"ãƒ©ãƒ”ãƒƒãƒ‰":$.rapidQueue.push(s),E(`â—†[ãƒ©ãƒ”ãƒƒãƒ‰] ${e.name}ãŒã€${t.name}ã€‘ã‚’å®£è¨€ã€‚`);break;case"ã‚¸ãƒ£ãƒƒã‚¸":s.judgeTarget=a,$.judgeQueue.push(s),E(`â—†[ã‚¸ãƒ£ãƒƒã‚¸] ${e.name}ãŒã€${t.name}ã€‘ã‚’å®£è¨€ã€‚`);break;case"ãƒ€ãƒ¡ãƒ¼ã‚¸":E(`â—†[ãƒ€ãƒ¡ãƒ¼ã‚¸] ${e.name}ãŒã€${t.name}ã€‘ã‚’å®£è¨€ã€‚`);break;default:$.actionQueue.push(s),E(`â—†[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³] ${e.name}ãŒã€${t.name}ã€‘ã‚’å®£è¨€ã€‚`);break}e.turnLimitedManeuvers.has(t.name)&&e.usedManeuvers.add(t.name),T(),Q(),O()}function O(){if(!$.isStarted)return;const e=B();if(e.length===0){$.count=0,$.activeActors=[],Be();return}const t=e.filter(d=>d.actionValue>=$.count&&!d.hasActedThisCount),n=t.some(d=>d.type==="enemy");let a=[];n?a=t.filter(d=>d.type==="enemy"):a=t,$.activeActors=a;const s=$.phase;let o=$.phase;const i=B().filter(d=>!d.isDestroyed&&!d.hasWithdrawn),c=i.filter(d=>d.actionValue>=$.count&&!d.hasActedThisCount),l=$.rapidQueue.some(d=>!d.checked),p=$.judgeQueue.some(d=>!d.checked),u=$.actionQueue.some(d=>!d.checked),r=$.damageQueue.some(d=>!d.applied),m=i.some(d=>d.actionValue>0);if(c.length>0?o="ACTION_DECLARATION":l?o="RAPID_RESOLUTION":p?o="JUDGE_RESOLUTION":u?o="ACTION_RESOLUTION":r?o="DAMAGE_RESOLUTION":$.count>0&&m?o="COUNT_END":o="TURN_END_PREPARATION",$.phase=o,s!==$.phase)switch($.phase){case"RAPID_RESOLUTION":E("--- ãƒ©ãƒ”ãƒƒãƒ‰è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---");break;case"JUDGE_RESOLUTION":E("--- ã‚¸ãƒ£ãƒƒã‚¸è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---");break;case"ACTION_RESOLUTION":E("--- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---");break;case"DAMAGE_RESOLUTION":E("--- ãƒ€ãƒ¡ãƒ¼ã‚¸è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---");break;case"COUNT_END":E("--- ã‚«ã‚¦ãƒ³ãƒˆçµ‚äº† ---");break;case"TURN_END_PREPARATION":E("--- ã‚¿ãƒ¼ãƒ³çµ‚äº†æº–å‚™ ---");break}Be(),T(),Q(),Re(),Wn($.activeActors)}function ea(){B().forEach(n=>n.hasActedThisCount=!1);const t=B().filter(n=>!n.isDestroyed&&!n.hasWithdrawn).map(n=>n.actionValue).filter(n=>n<$.count);t.length>0?($.count=Math.max(...t),$.shouldScrollToCount=!0,Oe(),O()):kt()}function Oe(){$.phase="ACTION_DECLARATION",$.actionQueue=[],$.rapidQueue=[],$.judgeQueue=[],$.damageQueue=[],Re(),fe($)}async function ta(e){const t=$.rapidQueue[e];!t||t.checked||(await wt(t),t.checked=!0,O())}async function Mt(e,t=0){const n=$.actionQueue[e];if(!n||n.checked)return;const{targets:a}=De(n.performer,n.sourceManeuver);if(n.target&&!a.some(o=>o.id===n.target.id)){E(`ï¼ è§£æ±ºå¤±æ•—: ${n.target.name} ã¯å°„ç¨‹å¤–ã§ã™ã€‚`),n.checked=!0,O();return}await wt(n,t),n.checked=!0,$.actionQueue.every(o=>o.checked)?oa():O()}function na(e){const t=$.judgeQueue[e];t&&!t.checked&&(t.checked=!0,E(`ï¼ [ã‚¸ãƒ£ãƒƒã‚¸] ${t.performer.name}ã®ã€${t.sourceManeuver.name}ã€‘ã‚’è§£æ±º(ãƒã‚§ãƒƒã‚¯)ã—ã¾ã—ãŸã€‚`)),O()}function kt(){$.phase="MADNESS_PHASE",E("ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†ã€‘å„ãƒ‰ãƒ¼ãƒ«ã¯æœªç·´ã«ç‹‚æ°—ç‚¹ã‚’1ç‚¹åŠ ãˆã¾ã™ã€‚"),Vn(),fe($)}function St(){$.turn++,B().forEach(n=>{n.activeBuffs=n.activeBuffs.filter(a=>a.duration!=="end_of_turn")}),rt();const e=B(),t=Math.max(0,...e.map(n=>n.actionValue));$.count=t>0?t:0,$.shouldScrollToCount=!0,T(),Oe(),O()}function aa(e){const t=$.damageQueue[e];t&&!t.applied&&(t.applied=!0,t.sourceAction&&(t.sourceAction.damageApplied=!0)),O()}function sa(){$.damageQueue.some(t=>!t.applied)?($.phase="DAMAGE_RESOLUTION",E("--- ãƒ€ãƒ¡ãƒ¼ã‚¸è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ---")):($.phase="COUNT_END",E("--- ã‚«ã‚¦ãƒ³ãƒˆçµ‚äº† ---"))}function oa(){$.moveQueue.length>0&&(E("--- ç§»å‹•è§£æ±ºãƒ•ã‚§ãƒ¼ã‚º ---"),ct($.moveQueue),$.moveQueue=[],Q()),sa(),O()}function ia(e,t){let n=JSON.stringify(e);return n=n.replace(/"\$params\.(\w+)"/g,(a,s)=>t.hasOwnProperty(s)?JSON.stringify(t[s]):"null"),JSON.parse(n)}async function ra(e,t){const n=Pt(e.ref);if(!n){console.warn(`[Engine] æ±ç”¨åŠ¹æœ '${e.ref}' ã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);return}const a=e.params||{};for(const s of n.actions){const o=ia(s,a);switch(o.action_type){case"attack_roll":await da(o,t);break;case"move_character":ca(o,t);break;case"apply_buff":la(o,t);break;case"escape_roll":It(o,t);break;default:E(`ï¼ [Engine] æœªå¯¾å¿œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—: ${o.action_type}`),console.warn(`[Engine] æœªå¯¾å¿œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã§ã™: ${o.action_type}`)}}}function ca(e,t){const{performer:n,declaration:a}=t,s=a.sourceManeuver.targetArea;if(!s){E("ï¼ [Engine] ç§»å‹•å…ˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");return}E(`ï¼ ç§»å‹•äºˆç´„: ${n.name} ãŒ ${s} ã¸`),$.moveQueue.push({characterId:n.id,targetArea:s})}function la(e,t){const{performer:n}=t,a=e.buff?e.buff:e;switch(a.stat){case"maxActionValue":j(n.id,{baseActionValue:(n.baseActionValue||6)+a.value}),E(`ï¼ ${n.name}ã®æœ€å¤§è¡Œå‹•å€¤ãŒ${a.value>0?"+":""}${a.value}ã•ã‚Œã¾ã—ãŸã€‚`);break;case"attackCheckBonus":n.activeBuffs.push({source:t.declaration.sourceManeuver.name,stat:a.stat,value:a.value,duration:a.duration}),E(`ï¼ ${n.name}ã¯ã€${t.declaration.sourceManeuver.name}ã€‘ã®åŠ¹æœã§ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†ã¾ã§æ”»æ’ƒåˆ¤å®šã«+${a.value}ã®ä¿®æ­£ã‚’å¾—ãŸï¼`);break;default:E(`ï¼ [Engine] æœªå¯¾å¿œã®ãƒãƒ•ã‚¿ã‚¤ãƒ—: ${a.stat}`),console.warn(`[Engine] æœªå¯¾å¿œã®ãƒãƒ•ã‚¿ã‚¤ãƒ—ã§ã™: ${a.stat}`)}}async function da(e,t){const{target:n,declaration:a}=t;if(!n){E("ï¼ æ”»æ’ƒå¯¾è±¡ãŒã„ã¾ã›ã‚“ã€‚");return}const s=t.totalAttackBonus||0,o=`NA${s>=0?`+${s}`:s}`;return new Promise(i=>{x({command:o,showToast:!0,callback:(c,l)=>{if(c&&!c.includes("å¤±æ•—")){E(`ï¼ ${n.name}ã«å‘½ä¸­ï¼`);let p=e.damage||0;$.damageQueue.push({id:`damage_${Date.now()}_${Math.random()}`,target:n,amount:p,location:l,sourceAction:a,applied:!1}),E(`ï¼ ã€${p}ã€‘ç‚¹ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`),e.on_hit&&e.on_hit.length>0&&E(`ï¼ è¿½åŠ åŠ¹æœ(${e.on_hit.join(",")})ãŒç™ºå‹•ï¼`)}else E("ï¼ æ”»æ’ƒã¯å¤±æ•—ã—ã¾ã—ãŸã€‚");i()}})})}async function wt(e,t=0){const{performer:n,sourceManeuver:a}=e;if(E(`ï¼ è§£æ±º: ${n.name} ã®ã€${a.name}ã€‘`),a.isEscapeAttempt){await It({},{performer:n});return}if(!a.effects||a.effects.length===0){a.name==="å¾…æ©Ÿ"?E(`ï¼ ${n.name}ã¯çŠ¶æ³ã‚’ã†ã‹ãŒã£ã¦ã„ã‚‹ã€‚`):E("ï¼ åŠ¹æœã®å®šç¾©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");return}const s={performer:e.performer,target:e.target,declaration:e,totalAttackBonus:t};for(const o of a.effects)await ra(o,s)}function It(e,t){const{performer:n}=t;E(`ï¼ ${n.name}ãŒé€ƒèµ°åˆ¤å®šã‚’è¡Œã„ã¾ã™...`),x({command:"NC",showToast:!0,callback:a=>{a.includes("æˆåŠŸ")?(E(`ï¼ é€ƒèµ°æˆåŠŸï¼ ${n.name}ã¯æˆ¦å ´ã‹ã‚‰é›¢è„±ã—ã¾ã—ãŸã€‚`),j(n.id,{hasWithdrawn:!0})):E(`ï¼ é€ƒèµ°å¤±æ•—ï¼ ${n.name}ã¯æˆ¦å ´ã«ç•™ã¾ã‚Šã¾ã™ã€‚`),T(),Q(),O()}})}const ua="1.1.8";document.addEventListener("DOMContentLoaded",async()=>{try{await Bt(),at(_e()),Hn(),Ln(),mn(),rn({hintMasterData:Dt(),regretMasterData:xe(),takaramonoMasterData:_t(),memoryFragmentsData:Nt(),addLog:E}),ma()}catch(e){document.body.innerHTML=`<div style="color: red; padding: 20px;">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>${e.stack}</div>`}});function ma(){const e=`
    <div class="modal-header modal-header-sub">ğŸ“¢ä¸»ãªæ›´æ–°å†…å®¹:7.10.1.15</div>
    <div class="modal-body welcome-modal-body">
      <p>â—† ã‚¸ãƒ£ãƒƒã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§<strong>é©ç”¨ã•ã‚Œã¦ã„ã‚‹æ”¯æ´ã€å¦¨å®³ã‚’ç¢ºèª</strong>ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
      <p>â—† <strong>æ”¯æ´</strong>ãŒãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«ã«é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
      <p>â—† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ<strong>ç”»åƒã‚’è¿½åŠ </strong>ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
      <p>â—† <strong>ã€ä¿ç®¡æ‰€ã§è¦‹ã‚‹ã€‘</strong>ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆä¿ç®¡æ‰€ã®<strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯</strong>ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
      <p>â—† <strong>ã€æ–°ç€/IDãƒªã‚¹ãƒˆã€‘</strong>ï¼šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆä¿ç®¡æ‰€ã®<strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º</strong>æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
      <p>â—† <strong>ã€ä¿ç®¡æ‰€ã‹ã‚‰èª­è¾¼ã¿ã€‘</strong>ï¼š<strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ãƒ¼ãƒˆä¿ç®¡æ‰€</strong>ã‹ã‚‰ã®<strong>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª­è¾¼ã¿</strong>æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
      <p>â—† <strong>ã€âœï¸ç”»åƒã®å¤‰æ›´ã€‘</strong>ï¼šã€ŒğŸªªäººå½¢è¨­è¨ˆå›³ã€ã«ãŠã„ã¦<strong>ç”»åƒã®å¤‰æ›´</strong>æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
      <p>â—† <strong>ãƒãƒ‹ãƒ¥ãƒ¼ãƒãƒªã‚¹ãƒˆ</strong>ã‚’æ›´æ–°ã—ã€<strong>è¡¨ç¤ºæ©Ÿèƒ½ã‚’æ‹¡å¼µ</strong>ã—ã¾ã—ãŸã€‚
      <p>â—† ãã®ä»–ã€è»½å¾®ãªUIèª¿æ•´ã¨ä¸å…·åˆã®ä¿®æ­£ã‚’è¡Œã„ã¾ã—ãŸã€‚
    </div>
  `;jn(),T(),Be(),An(),ve();const t=document.getElementById("welcomeModal"),n=document.getElementById("closeWelcomeModalBtn");if(t&&n){t.classList.add("is-visible");const s=()=>{t.classList.remove("is-visible"),R({title:"æ›´æ–°æƒ…å ±",bodyHtml:e,footerHtml:'<button id="okUpdateBtn" class="welcome-modal-close-btn">OK</button>',onRender:(o,i)=>{o.querySelector("#okUpdateBtn").onclick=i}})};n.onclick=s,t.onclick=o=>{o.target===t&&s()}}Kn({app:ua,"battle-logic":Yn,"character-manager":Xe,"data-handler":Tt,"dice-roller":on,"dice-3d":Ut,"interaction-manager":In,"menu-builder":gn,"ui-helpers":Vt,"ui-manager":On,"settings-manager":un,"character-converter":ln})}
