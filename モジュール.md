### **`interaction-manager.js` の役割**

このモジュールの主な責務は2つです。

1.  **ユーザー操作の受付（入力）**: ユーザーが画面上で行うあらゆる操作（クリック、ドラッグ、マウスオーバーなど）を受け付けるための**イベントリスナー**を管理します。
2.  **UI表示の指示（出力）**: 受け付けた操作に応じて、**マニューバメニューや各種モーダル（詳細シート、画像選択など）を構築**し、`ui-manager.js`に表示を依頼します。また、操作の結果を`battle-logic.js`に伝達する**橋渡し役**も担います。

---

### **主要な機能の分類と概要**

#### 1. 初期化とイベントリスナー設定

アプリケーション起動時やUI更新時に呼び出され、様々な要素を操作可能にするための関数群です。

| 関数名 | 機能概要 |
| :--- | :--- |
| `initialize()` | モジュールの初期化を宣言するだけのシンプルな関数です。 |
| `setupAllEventListeners()` | アプリケーション全体のイベントリスナーをセットアップする統括関数です。`script.js`から一度だけ呼び出され、以下のセットアップ関数をすべて実行します。カード外クリック時の選択解除リスナーもここに設定されています。 |
| `setupCharacterEventListeners()` | **（重要）** 戦場にいる全てのキャラクターカード（`.char`）とグリッド上のマーカー（`.marker`）にイベントリスナーを設定します。**UIが再描画されるたびに呼び出され**、新しい要素にもイベントを設定し直します。戦闘中か戦闘準備中かで、クリックされたときの挙動（メニュー表示 or ボタン表示）を切り替えるロジックも内包しています。 |
| `setupDragToScroll()` | PC・手駒エリアのコンテナを、マウスドラッグで横スクロールできるようにします。 |
| `setupDiceRollerEventListeners()` | 画面右下のダイスローラーアイコンをドラッグで移動可能にし、クリックでダイスメニューが開くようにします。 |
| `setupAccordion()` | 右側パネルの各宣言リストなどが、クリックで開閉（アコーディオン）できるようにします。 |
| `setupMadnessModalEventListeners()` | ターン終了時の狂気点モーダル内の各項目に、選択状態を管理するためのクリックイベントを設定します。 |

#### 2. UI構築（メニューとモーダル）

ユーザーのアクションに応じて、専門的なUI（メニューやモーダル）を動的に構築し、表示する関数群です。

| 関数名 | 機能概要 |
| :--- | :--- |
| `buildManeuverMenu()` | **（最重要）** キャラクターがクリックされた際に、そのキャラクターが使用可能なマニューバのリストを構築し、メニューとして表示します。損傷状態、タイミング、使用回数、対象の有無などをチェックして、使用不可能なマニューバを非活性化（グレーアウト）する役割も担います。戦闘中に人形設計図を開く「🪪」ボタンもここで生成されます。 |
| `showCharacterSheetModal()` | アンデッドの「詳細」ボタンが押されたときに、キャラクターの全情報（パーソナルデータ、スキル、パーツなど）を整形して、人形設計図モーダルとして表示します。画像の変更ボタンや初期配置の選択リストもここで生成・制御しています。 |
| `showUndeadListModal()` | 「アンデッドを追加」カードがクリックされたときに、`undead.json`から取得したテンプレート一覧をモーダルで表示します。キャラクターの種別フィルタリングや、「保管所から読込み」ボタンの設置もここで行います。 |
| `showImportCharacterModal()` | 「保管所から読込み」ボタンが押されたときに、キャラクターシートIDを入力するためのモーダルを表示します。入力されたIDを元に`fetchVampireBloodSheet`を呼び出し、一連のインポート処理を管理します。 |
| `fetchVampireBloodSheet()` | キャラクターシート保管所のサーバーにJSONPリクエストを送信し、キャラクターデータを非同期で取得する専門の関数です。 |
| `buildMoveMenu()` | 移動マニューバが選択された際に、移動可能なエリアを計算し、エリアカラーで色分けされたボタンを持つ専用のメニューをモーダルで表示します。「逃走」ボタンの表示と活性/非活性の制御もここで行います。 |
| `showImageSelectionModal()` | 人形設計図の「✏️ 画像の変更」ボタンが押されたときに、`images`フォルダ内の画像一覧をモーダルで表示し、選択された画像にキャラクターデータを更新する機能を提供します。 |

#### 3. ユーザー操作の処理（イベントハンドラ）

右側パネルの宣言リストなど、特定のUI要素がクリックされたときに直接呼び出され、`battle-logic.js`に処理を依頼する関数群です。

| 関数名 | 機能概要 |
| :--- | :--- |
| `handleActionItemClick()` | アクション宣言リストの項目がクリックされたときに呼び出され、`battleLogic.resolveActionByIndex()`を呼び出します。 |
| `handleJudgeItemClick()` | ジャッジ宣言リストの項目がクリックされたときに呼び出され、`battleLogic.checkJudgeItem()`を呼び出して、その項目を「解決済み」にします。 |
| `handleQueueCheck()` | ラピッド宣言リストのチェックボックスが変更されたときに呼び出され、`battleLogic.handleQueueCheck()`に状態を伝達します。 |
| `handleDamageItemClick()` | ダメージ処理リストの項目がクリックされたときに呼び出され、`showDamageModal`（パーツ損傷モーダル）を開くか、`battleLogic.applyDamage()`を直接呼び出します。 |

#### 4. 内部ヘルパー関数

上記の主要な関数群を補助するための、内部的な計算やチェックを行う関数です。

| 関数名 | 機能概要 |
| :--- | :--- |
| `checkTargetAvailability()` | あるマニューバが、射程内に有効な**キャラクターターゲット**を持つかどうかを判定します。（主に攻撃や移動マニューバ用） |
| `getTargetableDeclarations()` | あるジャッジマニューバが、射程内に有効な**アクション宣言ターゲット**を持つかどうかを判定します。（主に支援・妨害マニューバ用） |
| `closeAllMenus()` | 表示されている全てのポップアップメニュー（マニューバメニューなど）を閉じます。 |
| `handleGlobalClick()` | 画面のどこかがクリックされたかを監視し、メニュー外がクリックされた場合はメニューを閉じる、ターゲット選択中に選択対象外がクリックされた場合は選択をキャンセルする、といったグローバルな制御を行います。 |